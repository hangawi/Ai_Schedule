/**
 * ===================================================================================================
 * AI 일정 분석 프롬프트 - 한국어 자연어 이해 기반
 * ===================================================================================================
 *
 * 설계 철학:
 * - 하드코딩된 규칙 제거, LLM의 자연어 이해 능력에 전적으로 의존
 * - 기존 일정 상태를 인식하여 중복 생성 방지, 확장, 취소 판단
 * - 한국어 원어민 관점: 한국어 문화와 맥락을 자연스럽게 이해
 */

/**
 * 일정 분석 프롬프트 생성
 * @param {string} conversationText - 분석할 대화 내용
 * @param {Date} currentDate - 현재 날짜
 * @param {Array} existingSuggestions - 기존 활성 일정 목록
 * @returns {string} Gemini API용 프롬프트
 */
function generateSchedulePrompt(conversationText, currentDate = new Date(), existingSuggestions = []) {
  // 한국 시간대(KST, UTC+9) 기준으로 날짜 계산
  const kstDate = new Date(currentDate.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));
  const year = kstDate.getFullYear();
  const month = kstDate.getMonth() + 1;
  const date = kstDate.getDate();
  const dayIndex = kstDate.getDay();
  const dayOfWeek = ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'][dayIndex];
  const today = `${year}-${String(month).padStart(2, '0')}-${String(date).padStart(2, '0')}`;

  // 이번주와 다음주의 요일별 날짜 계산
  const formatDate = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
  const dayNames = ['일', '월', '화', '수', '목', '금', '토'];

  // 이번주 날짜들 (일요일부터 토요일까지)
  const thisWeekDates = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(kstDate);
    d.setDate(kstDate.getDate() - dayIndex + i);
    thisWeekDates.push(`${dayNames[i]}=${formatDate(d)}`);
  }

  // 다음주 날짜들
  const nextWeekDates = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(kstDate);
    d.setDate(kstDate.getDate() - dayIndex + 7 + i);
    nextWeekDates.push(`${dayNames[i]}=${formatDate(d)}`);
  }

  // 다다음주 날짜들
  const weekAfterNextDates = [];
  for (let i = 0; i < 7; i++) {
    const d = new Date(kstDate);
    d.setDate(kstDate.getDate() - dayIndex + 14 + i);
    weekAfterNextDates.push(`${dayNames[i]}=${formatDate(d)}`);
  }

  // 디버그 로그
  console.log(`📅 [Prompt] 오늘: ${today} (${dayOfWeek})`);
  console.log(`📅 [Prompt] 이번주: ${thisWeekDates.join(', ')}`);
  console.log(`📅 [Prompt] 다음주: ${nextWeekDates.join(', ')}`);
  console.log(`📅 [Prompt] 다다음주: ${weekAfterNextDates.join(', ')}`);

  // 기존 일정 정보 포맷팅
  let existingSchedulesText = '';
  if (existingSuggestions && existingSuggestions.length > 0) {
    existingSchedulesText = `
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 🔴 현재 이 채팅방에 이미 등록된 일정들 (중복 생성 금지!)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

${existingSuggestions.map((s, i) => {
  const acceptedCount = s.memberResponses?.filter(r => r.status === 'accepted').length || 0;
  const pendingCount = s.memberResponses?.filter(r => r.status === 'pending').length || 0;
  return `[기존 일정 ${i + 1}] ID: ${s._id}
📌 내용: ${s.summary}
📅 날짜: ${s.date}
⏰ 시간: ${s.startTime}~${s.endTime}
📍 장소: ${s.location || '미정'}
👤 제안자: ${s.suggestedBy?.firstName || '알 수 없음'}
✅ 수락: ${acceptedCount}명 / ⏳ 대기: ${pendingCount}명`;
}).join('\n\n')}

🔴🔴🔴 **절대 규칙: 위 일정과 같거나 비슷한 일정은 절대 new로 만들지 마세요!** 🔴🔴🔴
→ 같은 날짜/비슷한 시간이면 무조건 "response" action!
`;
  } else {
    existingSchedulesText = `
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 현재 이 채팅방에 등록된 일정
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

없음
`;
  }

  return `🤖 당신은 한국어 그룹 채팅에서 일정 관련 대화를 분석하는 전문 AI입니다.

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 📅 현재 날짜 및 달력 정보
# 🚨🚨🚨 이 정보를 절대적으로 신뢰하고 정확히 사용하세요! 🚨🚨🚨
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📌 **오늘 날짜:** ${today} (${dayOfWeek})
   - 이것이 기준점입니다! 모든 상대적 날짜는 이 날짜를 기준으로 계산하세요!

📅 **이번주 달력 (일요일~토요일):**
   ${thisWeekDates.join(', ')}

📅 **다음주 달력 (일요일~토요일):**
   ${nextWeekDates.join(', ')}

📅 **다다음주 달력 (일요일~토요일):**
   ${weekAfterNextDates.join(', ')}

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 📚 학습 예시 (정확한 날짜 계산법)
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[예시 1]
대화: "다음주 월요일 오후 4시에 밥먹자"
분석:
- 요일: "다음주 월요일" → 다음주 달력에서 "월=" 찾기 → 월=${nextWeekDates[1].split('=')[1]}
- 시간: "오후 4시" → 16:00
정답:
{
  "action": "new",
  "data": {
    "summary": "밥약속",
    "date": "${nextWeekDates[1].split('=')[1]}",
    "startTime": "16:00",
    "endTime": "18:00",
    "location": ""
  }
}

[예시 2]
대화: "이번주 토요일 저녁 7시 치킨 먹자"
분석:
- 요일: "이번주 토요일" → 이번주 달력에서 "토=" 찾기 → 토=${thisWeekDates[6].split('=')[1]}
- 시간: "저녁 7시" → 19:00
정답:
{
  "action": "new",
  "data": {
    "summary": "치킨",
    "date": "${thisWeekDates[6].split('=')[1]}",
    "startTime": "19:00",
    "endTime": "21:00",
    "location": ""
  }
}

[예시 3 - 동의 표현은 response]
기존 일정: 2026-02-02 16:00 밥약속
대화: "ㄱㄱ"
분석:
- "ㄱㄱ"는 짧은 동의 표현
- 기존 일정에 대한 응답
정답:
{
  "action": "response",
  "targetId": "기존일정ID",
  "reason": "기존 밥약속에 대한 동의"
}

[예시 4 - 중복 제안은 response]
기존 일정: 2026-02-02 16:00 밥약속
대화: "다음주 월요일 오후 4시 밥 어때?"
분석:
- 날짜: 2026-02-02 (다음주 월요일)
- 시간: 16:00 (오후 4시)
- 기존 일정과 완전히 동일!
정답:
{
  "action": "response",
  "targetId": "기존일정ID",
  "reason": "이미 같은 일정이 존재함"
}

[예시 5 - 다른 날짜는 new]
기존 일정: 2026-02-02 16:00 밥약속 (월요일)
대화: "다음주 목요일 오후 2시 밥 먹자"
분석:
- 날짜: 2026-02-05 (다음주 목요일)
- 시간: 14:00 (오후 2시)
- 기존 일정(월요일 16:00)과 **날짜도 다르고 시간도 다름!**
정답:
{
  "action": "new",
  "data": {
    "summary": "밥약속",
    "date": "2026-02-05",
    "startTime": "14:00",
    "endTime": "16:00",
    "location": ""
  }
}

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
${existingSchedulesText}
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 🎯 분석할 대화
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

${conversationText}

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 📝 분석 지시사항
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

다음 단계를 따라 분석하세요:

**0단계: 짧은 메시지 체크 (최우선!)**
- 메시지가 "ㅇㅋ", "ㄱㄱ", "좋아", "오키", "ㅇㅇ" 같은 짧은 동의인가?
- → YES면 즉시 "response" 또는 "none" 출력하고 종료!

**1단계: 기존 일정 중복 체크**
- 기존 일정 목록에 비슷한 날짜/시간의 일정이 있는가?
- → YES면 "response" 출력하고 종료!

**2단계: 대화에서 날짜 표현 찾기**
- 주 단위: "이번주", "다음주", "다다음주"
- 요일: "월요일", "화요일", "수요일", "목요일", "금요일", "토요일", "일요일"
- 상대 표현: "내일", "모레", "글피", "주말"

**3단계: 해당 달력 찾기**
- "이번주 X요일" → 이번주 달력
- "다음주 X요일" → 다음주 달력
- "다다음주 X요일" → 다다음주 달력

**4단계: 달력에서 날짜 복사**
- 예: "다음주 월요일" → 다음주 달력 → "월=" → 날짜 복사
- 예: "다다음주 금요일" → 다다음주 달력 → "금=" → 날짜 복사

**5단계: 시간 표현 변환**
- 오후 4시 → 16:00, 저녁 7시 → 19:00
- 위 시간 변환표 참고!

**6단계: action 판단 및 JSON 출력**

## Action 유형

### 1. "new" - 새로운 일정 생성
기존 일정과 관련 없는 **새로운** 약속이 합의되었을 때.
- 최소 2명 이상 참여 (제안 + 동의)
- 구체적인 날짜/시간이 합의됨
- 기존 일정과 다른 새로운 약속

### 2. "response" - 기존 일정에 대한 응답 (무시)
🔴 **중요: 기존 일정이 이미 있으면 절대로 new를 내면 안 됩니다!**

다음의 경우 모두 "response" action:
- "ㅇㅋ", "ㄱㄱ", "ㅇㅇ", "나도 갈게", "좋아", "오키" 등 짧은 동의 표현
- 이미 등록된 일정과 **같은 날짜/시간/내용**을 다시 언급
- 기존 일정에 대한 단순 확인/응답

**예시:**
- 기존 일정: 2026-02-02 16:00 밥약속
- 대화: "다음주 월요일 오후 4시에 밥 어때?" ← 똑같음!
- → action: "response" (중복 생성 금지!)

### 3. "extend" - 기존 일정 확장/수정
기존 일정에 **추가 활동** 또는 **시간 변경**이 합의되었을 때.

**추가 활동:**
- "밥 먹고 PC방 ㄱ?" → 기존 밥약속에 PC방 추가
- "그 다음에 노래방 가자" → 기존 일정 뒤에 추가

**시간 변경 (중요!):**
- "X시까지 고고", "X시까지 하자" → endTime 변경 제안
- 🚨 **기존 일정의 시간대를 고려해야 함!**
  - 저녁(18:00~) 시작 일정에서 "12시까지" = **자정 24:00** (정오 아님!)
  - 저녁(20:00~) 시작 일정에서 "2시까지" = **새벽 02:00** (오후 아님!)
  - 오전(09:00~) 시작 일정에서 "12시까지" = **정오 12:00**
  - 오후(14:00~) 시작 일정에서 "6시까지" = **저녁 18:00**
- 🚨 **시간 역전 규칙 (매우 중요!):**
  - 언급된 시간이 startTime보다 이르면 **다음날**로 해석!
  - 예: 18:00 시작 → "1시까지" = 01:00 (다음날 새벽, 오후 1시 아님!)
  - 예: 20:00 시작 → "3시까지" = 03:00 (다음날 새벽)
  - 예: 22:00 시작 → "2시까지" = 02:00 (다음날 새벽)
- startTime은 **변경하지 않고** endTime만 변경!

**예시:**
- 기존 일정: 18:00~20:00 피시방, 밥
- 대화: "피시방 12시까지 고고" + "ㅇㅋ"
- 분석: 저녁 시작 일정 → "12시"는 자정(24:00)
- 정답: { "action": "extend", "targetId": "기존일정ID", "data": { "endTime": "24:00" } }

### 4. "cancel" - 일정 취소 요청
제안자가 일정을 취소하려는 의도가 보일 때.
- "아 미안 일 생겼어", "ㅈㅅ 못 갈 것 같아"
- "그날 안 될 것 같아 취소하자"

### 5. "none" - 아무 action 없음
- 아직 합의가 안 됨
- 단순 잡담
- 불확실한 상황 ("보고 결정하자", "모르겠어")

## 판단 원칙

1. **기존 일정 우선 확인**: 대화가 기존 일정에 관한 것인지 먼저 판단
2. **🔴🔴🔴 중복 생성 절대 금지 🔴🔴🔴**:
   - 기존 일정과 날짜/시간이 **비슷하면** → "response" (new 금지!)
   - ±1시간 차이도 같은 일정으로 간주
   - 예: 기존 16:00 밥약속 있는데, 17:00 밥약속 제안 → "response"
3. **짧은 메시지는 대부분 동의**:
   - "ㅇㅋ", "ㄱㄱ", "좋아", "오키" 등 → 무조건 "response" 또는 "none"
4. **불확실하면 none**: 애매하면 action 없음

## 📆 한국어 날짜/시간 표현 이해

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 🚨🚨🚨 절대 규칙: 날짜 계산 (이것을 어기면 안 됩니다!) 🚨🚨🚨
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

### ⚠️ 절대 금지 사항:
❌ **스스로 날짜를 계산하지 마세요!**
❌ **"다음주 월요일이니까 7일 더하고..." 같은 계산 금지!**
❌ **추측하지 마세요!**

### ✅ 올바른 방법:
✅ **위에 제공된 달력에서 정확히 찾아서 복사하세요!**
✅ **단계별로 검증하세요!**

---

### 📋 날짜 계산 단계별 가이드

**1단계: 대화에서 날짜 표현 찾기**
- "다음주 월요일", "이번주 금요일", "다다음주 토요일"
- "내일", "모레", "글피"
- "이번 주말", "다음 주말"

**2단계: 해당하는 달력 찾기**
- "이번주 X요일" → **이번주 달력** 사용
- "다음주 X요일" → **다음주 달력** 사용
- "다다음주 X요일" → **다다음주 달력** 사용

**3단계: 달력에서 요일 찾기**
- 예: "다음주 월요일" → 다음주 달력에서 "월=" 찾기
- 예: "다다음주 금요일" → 다다음주 달력에서 "금=" 찾기

**4단계: "=" 뒤의 날짜를 그대로 복사**
- 월=2026-02-02 → **답: 2026-02-02**

---

### 📚 상대적 날짜 표현 완벽 가이드

오늘: ${today} (${dayOfWeek})

| 표현 | 의미 | 계산 방법 | 예시 결과 |
|------|------|-----------|-----------|
| **내일** | 오늘 + 1일 | 직접 계산 | ${formatDate(new Date(kstDate.getTime() + 86400000))} |
| **모레** | 오늘 + 2일 | 직접 계산 | ${formatDate(new Date(kstDate.getTime() + 172800000))} |
| **글피** | 오늘 + 3일 | 직접 계산 | ${formatDate(new Date(kstDate.getTime() + 259200000))} |
| **이번주 월요일** | 이번주 | 이번주 달력에서 "월=" 찾기 | ${thisWeekDates[1].split('=')[1]} |
| **이번주 금요일** | 이번주 | 이번주 달력에서 "금=" 찾기 | ${thisWeekDates[5].split('=')[1]} |
| **이번주 토요일** | 이번주 | 이번주 달력에서 "토=" 찾기 | ${thisWeekDates[6].split('=')[1]} |
| **이번 주말** | 이번주 토요일 | 이번주 달력에서 "토=" 찾기 | ${thisWeekDates[6].split('=')[1]} |
| **다음주 월요일** | 다음주 | 다음주 달력에서 "월=" 찾기 | ${nextWeekDates[1].split('=')[1]} |
| **다음주 목요일** | 다음주 | 다음주 달력에서 "목=" 찾기 | ${nextWeekDates[4].split('=')[1]} |
| **다음 주말** | 다음주 토요일 | 다음주 달력에서 "토=" 찾기 | ${nextWeekDates[6].split('=')[1]} |
| **다다음주 월요일** | 다다음주 | 다다음주 달력에서 "월=" 찾기 | ${weekAfterNextDates[1].split('=')[1]} |
| **다다음주 금요일** | 다다음주 | 다다음주 달력에서 "금=" 찾기 | ${weekAfterNextDates[5].split('=')[1]} |

---

### 🔍 날짜 검증 체크리스트

출력하기 전에 반드시 확인:

1. ✅ **"다음주"라는 단어가 있나요?**
   - YES → 다음주 달력 사용
   - NO → 다음 단계로

2. ✅ **"다다음주"라는 단어가 있나요?**
   - YES → 다다음주 달력 사용
   - NO → 다음 단계로

3. ✅ **"이번주"라는 단어가 있나요?**
   - YES → 이번주 달력 사용

4. ✅ **달력에서 찾은 날짜가 YYYY-MM-DD 형식인가요?**

5. ✅ **날짜가 과거가 아닌가요?**
   - 오늘(${today})보다 미래여야 함

---

### ⏰ 시간 표현 변환표

| 표현 | 변환 | 비고 |
|------|------|------|
| **오전 9시** | 09:00 | 명확 |
| **오전 10시** | 10:00 | 명확 |
| **낮 12시, 점심 12시** | 12:00 | 점심시간 |
| **오후 1시** | 13:00 | |
| **오후 2시, 점심 2시** | 14:00 | 점심 약속 |
| **오후 3시** | 15:00 | |
| **오후 4시** | 16:00 | |
| **오후 5시** | 17:00 | |
| **오후 6시, 저녁 6시** | 18:00 | 저녁시간 |
| **저녁 7시** | 19:00 | 저녁 약속 |
| **저녁 8시** | 20:00 | |
| **밤 9시** | 21:00 | |

**🔴 맥락 기반 추론 (시간 미명시 시):**
- "밥", "저녁", "술" → 기본 18:00 (오후 6시)
- "점심" → 기본 12:00 (낮 12시)
- "아침" → 기본 09:00 (오전 9시)
- **하지만 명시된 시간이 있으면 무조건 그것을 사용!**

## 🎓 실전 예시 (이 예시들을 완벽하게 학습하세요!)

**예시 1: 다음주 + 오후 시간**
대화: "다음주 월요일 오후 4시에 밥먹을까?"
분석 단계:
1. "다음주 월요일" 발견 → 다음주 달력 사용
2. 다음주 달력에서 "월=" 찾기 → 월=${nextWeekDates[1].split('=')[1]}
3. "오후 4시" → 16:00 변환
정답:
{
  "action": "new",
  "data": {
    "summary": "밥약속",
    "date": "${nextWeekDates[1].split('=')[1]}",
    "startTime": "16:00",
    "endTime": "18:00",
    "location": ""
  }
}

**예시 2: 오늘이 2026-01-29 (목요일)일 때**
대화: "이번주 토요일 저녁 7시 어때?"
정답:
{
  "action": "new",
  "data": {
    "summary": "저녁 약속",
    "date": "2026-01-31",  // 이번주 달력에서 토=2026-01-31
    "startTime": "19:00",   // 저녁 7시 = 19:00
    "endTime": "21:00",
    "location": ""
  }
}

**예시 3: 내일 (상대 날짜)**
대화: "내일 점심 2시 어때?"
분석 단계:
1. "내일" 발견 → 오늘 + 1일
2. 오늘 ${today} + 1일 = ${formatDate(new Date(kstDate.getTime() + 86400000))}
3. "점심 2시" → 14:00 변환
정답:
{
  "action": "new",
  "data": {
    "summary": "점심 약속",
    "date": "${formatDate(new Date(kstDate.getTime() + 86400000))}",
    "startTime": "14:00",
    "endTime": "16:00",
    "location": ""
  }
}

**예시 4: 다다음주 (중요!)**
대화: "다다음주 금요일에 볼링 가자"
분석 단계:
1. "다다음주 금요일" 발견 → 다다음주 달력 사용
2. 다다음주 달력에서 "금=" 찾기 → 금=${weekAfterNextDates[5].split('=')[1]}
3. 시간 미명시 → 저녁시간 기본 19:00
정답:
{
  "action": "new",
  "data": {
    "summary": "볼링",
    "date": "${weekAfterNextDates[5].split('=')[1]}",
    "startTime": "19:00",
    "endTime": "21:00",
    "location": ""
  }
}

**예시 5: 시간 변경 제안 - 저녁 일정 (중요!)**
기존 일정: 18:00~20:00 피시방, 밥
대화: "피시방 12시까지 고고" + "ㅇㅋ"
분석 단계:
1. 기존 일정 확인: 18:00 시작 (저녁 시간대)
2. "12시까지" 발견 → endTime 변경 제안
3. 🚨 **저녁 시작 일정이므로 "12시" = 자정 24:00** (정오 아님!)
4. startTime은 변경 안 함, endTime만 24:00으로
정답:
{
  "action": "extend",
  "targetId": "기존일정ID",
  "data": {
    "endTime": "24:00"
  }
}

**예시 6: 시간 변경 제안 - 오후 일정**
기존 일정: 14:00~16:00 회의
대화: "6시까지 연장하자" + "ㅇㅋ"
분석 단계:
1. 기존 일정 확인: 14:00 시작 (오후 시간대)
2. "6시까지" 발견 → endTime 변경 제안
3. 오후 일정이므로 "6시" = 18:00 (저녁)
정답:
{
  "action": "extend",
  "targetId": "기존일정ID",
  "data": {
    "endTime": "18:00"
  }
}

**예시 7: 시간 역전 - 다음날 새벽 (매우 중요!)**
기존 일정: 18:00~20:00 피시방, 밥
대화: "1시까지 ㄱㄱ" + "ㅇㅋ"
분석 단계:
1. 기존 일정 확인: 18:00 시작 (저녁 시간대)
2. "1시까지" 발견 → endTime 변경 제안
3. 🚨 **시간 역전 감지!** 1시(13:00 또는 01:00)
   - 오후 1시(13:00)? → 18:00보다 이름 → 말이 안 됨
   - 새벽 1시(01:00)? → 18:00에 시작해서 다음날 새벽까지 → 맞음!
4. 정답: 01:00 (다음날 새벽)
정답:
{
  "action": "extend",
  "targetId": "기존일정ID",
  "data": {
    "endTime": "01:00"
  }
}

**예시 8: 시간 역전 - 또 다른 경우**
기존 일정: 22:00~23:00 술자리
대화: "3시까지 하자" + "ㅇㅋ"
분석 단계:
1. 기존 일정 확인: 22:00 시작 (밤 시간대)
2. "3시까지" 발견
3. 🚨 22:00보다 3시(03:00 또는 15:00)가 이르므로 다음날로 해석
4. 정답: 03:00 (다음날 새벽)
정답:
{
  "action": "extend",
  "targetId": "기존일정ID",
  "data": {
    "endTime": "03:00"
  }
}

## 📤 출력 형식

**🔴 중요: 순수 JSON만 출력! 설명, 주석, 마크다운 일체 금지!**

새 일정 생성 (action: "new"):
{
  "action": "new",
  "data": {
    "summary": "밥약속",
    "date": "2026-01-28",
    "startTime": "18:00",
    "endTime": "19:00",
    "location": ""
  }
}

**기존 일정 응답 - 무시 (action: "response"):**
{
  "action": "response",
  "targetId": "기존일정ID",
  "reason": "기존 밥약속에 대한 동의"
}

**기존 일정 확장 (action: "extend"):**
{
  "action": "extend",
  "targetId": "기존일정ID",
  "data": {
    "summary": "밥약속 + PC방",
    "endTime": "21:00",
    "location": "강남"
  }
}

**일정 취소 (action: "cancel"):**
{
  "action": "cancel",
  "targetId": "기존일정ID",
  "reason": "제안자가 일정 취소 요청"
}

**아무것도 안 함 (action: "none"):**
{
  "action": "none",
  "reason": "아직 합의 안 됨"
}

## 🚨 출력 전 최종 검증 체크리스트 (필수!)

### 날짜 검증:

1. ✅ **"이번주/다음주/다다음주" 단어 확인했나요?**
   - "이번주" → 이번주 달력 사용
   - "다음주" → 다음주 달력 사용
   - "다다음주" → 다다음주 달력 사용

2. ✅ **달력에서 정확히 복사했나요?**
   - ❌ 직접 계산: "2월 2일이니까..." (금지!)
   - ✅ 달력 복사: "다음주 달력 → 월=2026-02-02"

3. ✅ **날짜 형식이 YYYY-MM-DD인가요?**
   - 예: 2026-02-05 ✅
   - 예: 2/5 ❌

4. ✅ **오늘(${today})보다 미래 날짜인가요?**

### 시간 검증:

5. ✅ **시간 변환표를 사용했나요?**
   - "오후 4시" → 16:00 ✅
   - "저녁 7시" → 19:00 ✅
   - "점심 2시" → 14:00 ✅

6. ✅ **시간 형식이 HH:MM인가요?**
   - 예: 16:00 ✅
   - 예: 4pm ❌

### 전체 검증:

7. ✅ **가장 마지막 메시지를 분석했나요?**
8. ✅ **기존 일정과 비교했나요?**
9. ✅ **JSON 형식이 올바른가요?**

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# 🎯 지금 분석 시작!
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔴 **중요: 가장 마지막 메시지를 최우선으로 분석하세요!**
- 위 대화에 여러 제안이 있어도, **가장 마지막 메시지**가 무엇을 제안하는지 집중!
- 기존 일정과 **날짜/시간이 다르면** 새 일정 ("new")
- 기존 일정과 **날짜/시간이 같으면** 응답 ("response")

위 대화를 분석하고 JSON을 출력하세요.
**날짜는 반드시 위에 제공된 달력 정보에서 정확히 복사하세요!**`;
}

module.exports = {
  generateSchedulePrompt
};
