<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <title>Math Alive - í•™ìƒ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Malgun Gothic, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #333; text-align: center; margin-bottom: 10px; font-size: 32px; }
        .student-id {
            text-align: center;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 30px;
            font-size: 18px;
        }
        .status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 16px;
            color: #666;
        }
        .status.ready {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        .question-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            display: none;
        }
        .question-box.show { display: block; }
        .question-text {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .answer-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 18px;
            text-align: center;
            margin-bottom: 15px;
        }
        .answer-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            margin-top: 15px;
            display: none;
        }
        .result.show { display: block; }
        .result.correct { background: #d4edda; color: #155724; }
        .result.incorrect { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‘¨â€ğŸ“ í•™ìƒ í™”ë©´</h1>
        <div class="student-id" id="studentId">ì—°ê²° ì¤‘...</div>
        <div class="status" id="status">ë¬¸ì œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
        <div class="question-box" id="questionBox">
            <div class="question-text" id="questionText"></div>
            <input type="text" id="answerInput" class="answer-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" />
            <button class="submit-btn" id="submitBtn">ì •ë‹µ ì œì¶œ</button>
        </div>
        <div class="result" id="result"></div>
    </div>
    <script>
        const API_BASE = 'http://localhost:5000/api/nview';
        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('studentId') || 'unknown';
        let currentQuestion = null;
        let startTime = null; // ë¬¸ì œ ë°›ì€ ì‹œê°„
        let dailyQuestions = []; // ì˜¤ëŠ˜ì˜ 5ë¬¸ì œ
        let currentQuestionIndex = 0; // í˜„ì¬ ë¬¸ì œ ë²ˆí˜¸

        document.getElementById('studentId').textContent = studentId.replace('student', 'í•™ìƒ ');

        window.addEventListener('message', function(event) {
            console.log('ğŸ“© í•™ìƒ ë©”ì‹œì§€ ìˆ˜ì‹ :', event.data);

            if (event.data.type === 'daily_questions') {
                console.log('âœ… ì˜¤ëŠ˜ì˜ 5ë¬¸ì œ ë°›ìŒ:', event.data.questions);

                dailyQuestions = event.data.questions;
                currentQuestionIndex = 0;

                // ì²« ë²ˆì§¸ ë¬¸ì œ í‘œì‹œ
                showNextQuestion();
            }
            else if (event.data.type === 'new_question') {
                console.log('âœ… ìƒˆ ë¬¸ì œ ë°›ìŒ (AI/ë§ì¶¤í˜•):', event.data.data);

                // AI/ë§ì¶¤í˜• ë¬¸ì œ ëª¨ë“œë¡œ ì „í™˜
                dailyQuestions = []; // ì˜¤ëŠ˜ì˜ ë¬¸ì œ ëª¨ë“œ ì¢…ë£Œ
                currentQuestionIndex = 0;
                currentQuestion = event.data.data;
                startTime = Date.now(); // ì‹œê°„ ì¶”ì  ì‹œì‘

                console.log('í˜„ì¬ ë¬¸ì œ ì„¤ì • (ì¼ë°˜ ì œì¶œ ëª¨ë“œ):', currentQuestion);

                document.getElementById('questionText').textContent = currentQuestion.question;
                document.getElementById('questionBox').classList.add('show');
                document.getElementById('status').textContent = 'ë¬¸ì œê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤! ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”.';
                document.getElementById('status').className = 'status ready';
                document.getElementById('answerInput').value = '';
                document.getElementById('answerInput').disabled = false;
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('result').classList.remove('show');
                document.getElementById('answerInput').focus();

                console.log('âœ… ë¬¸ì œ í‘œì‹œ ì™„ë£Œ!');
            }
        });

        function showNextQuestion() {
            if (currentQuestionIndex >= dailyQuestions.length) {
                // ëª¨ë“  ë¬¸ì œ ì™„ë£Œ
                document.getElementById('status').textContent = 'ğŸ‰ ëª¨ë“  ë¬¸ì œë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!';
                document.getElementById('status').className = 'status ready';
                document.getElementById('questionBox').classList.remove('show');
                document.getElementById('result').innerHTML = '<div style="font-size:24px;">ğŸ† ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!</div>';
                document.getElementById('result').className = 'result show correct';
                return;
            }

            currentQuestion = dailyQuestions[currentQuestionIndex];
            startTime = Date.now();

            document.getElementById('questionText').textContent = `ë¬¸ì œ ${currentQuestionIndex + 1}/5: ${currentQuestion.question}`;
            document.getElementById('questionBox').classList.add('show');
            document.getElementById('status').textContent = `ë¬¸ì œ ${currentQuestionIndex + 1}/5 - ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”`;
            document.getElementById('status').className = 'status ready';
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').disabled = false;
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('result').classList.remove('show');
            document.getElementById('answerInput').focus();
        }

        document.getElementById('submitBtn').addEventListener('click', submitAnswer);
        document.getElementById('answerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') submitAnswer();
        });

        async function submitAnswer() {
            if (!currentQuestion) return;

            const answer = document.getElementById('answerInput').value.trim();
            if (!answer) {
                alert('ì •ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            // ì†Œìš” ì‹œê°„ ê³„ì‚° (ì´ˆ ë‹¨ìœ„)
            const timeSpent = startTime ? Math.floor((Date.now() - startTime) / 1000) : 0;

            const correct = String(answer).toLowerCase() === String(currentQuestion.answer).toLowerCase();

            // ë°±ì—”ë“œì— ë‹µì•ˆ ì œì¶œ (í•™ìŠµ ë°ì´í„° ìë™ ì €ì¥)
            try {
                // ì˜¤ëŠ˜ì˜ ë¬¸ì œì¸ ê²½ìš°
                if (dailyQuestions.length > 0) {
                    await fetch(`${API_BASE}/submit-daily-answer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            studentId,
                            questionIndex: currentQuestionIndex,
                            answer,
                            timeSpent
                        })
                    });
                } else {
                    // ì¼ë°˜ ë¬¸ì œì¸ ê²½ìš°
                    await fetch(`${API_BASE}/submit-answer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            studentId,
                            answer,
                            timeSpent
                        })
                    });
                }
            } catch (error) {
                console.error('ë‹µì•ˆ ì œì¶œ ì˜¤ë¥˜:', error);
            }

            // êµì‚¬ í˜ì´ì§€ë¡œ ê²°ê³¼ ì „ì†¡
            if (window.opener) {
                window.opener.postMessage({
                    type: 'answer_submitted',
                    studentId,
                    answer,
                    correct,
                    correctAnswer: currentQuestion.answer,
                    timeSpent
                }, '*');
            }

            const resultEl = document.getElementById('result');
            resultEl.className = `result show ${correct ? 'correct' : 'incorrect'}`;
            resultEl.innerHTML = correct
                ? `ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤!<br><small style="font-size:14px; opacity:0.7;">ì†Œìš” ì‹œê°„: ${timeSpent}ì´ˆ</small>`
                : `âŒ í‹€ë ¸ìŠµë‹ˆë‹¤! ì •ë‹µì€ "${currentQuestion.answer}" ì…ë‹ˆë‹¤.<br><small style="font-size:14px; opacity:0.7;">ì†Œìš” ì‹œê°„: ${timeSpent}ì´ˆ</small>`;

            document.getElementById('submitBtn').disabled = true;
            document.getElementById('answerInput').disabled = true;

            // ì˜¤ëŠ˜ì˜ ë¬¸ì œì¸ ê²½ìš° 3ì´ˆ í›„ ë‹¤ìŒ ë¬¸ì œë¡œ
            if (dailyQuestions.length > 0) {
                document.getElementById('status').textContent = correct ? 'ì •ë‹µ! 3ì´ˆ í›„ ë‹¤ìŒ ë¬¸ì œ...' : '3ì´ˆ í›„ ë‹¤ìŒ ë¬¸ì œ...';

                setTimeout(() => {
                    currentQuestionIndex++;
                    showNextQuestion();
                }, 3000);
            } else {
                document.getElementById('status').textContent = correct ? 'ì •ë‹µì„ ë§í˜”ìŠµë‹ˆë‹¤!' : 'ë‹¤ìŒ ë¬¸ì œë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
            }
        }

        window.addEventListener('load', () => {
            window.opener.postMessage({
                type: 'student_ready',
                studentId
            }, '*');
        });
    </script>
</body>
</html>
