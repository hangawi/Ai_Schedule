작성일: 2025-12-23
작성자: Gemini (AI Assistant)
주제: 이동시간 선호시간 침범 방지 기능(빗금 표시) 구현 상세 리포트
================================================================================

1. 기능 개요
================================================================================
방장의 선호시간이 시작되기 전(예: 09:00 이전)에 조원의 이동시간이 생성되는 '프라이버시 침범'
문제를 해결하기 위해, 조원 화면에서 이동시간만큼 수업 배치를 선제적으로 막는 시각화 기능입니다.

2. 작동 원리 (Working Principle)
================================================================================
조원이 협업 방에 입장하면 시스템은 다음의 과정을 거쳐 실시간으로 금지 구역을 계산합니다.

① [좌표 확보]: 
   - 방장과 나의 주소(위도/경도) 데이터를 가져옵니다. 
   - 보안을 위해 조원에게는 상세 주소를 숨기되, 계산에 필요한 좌표값은 내부적으로 유지합니다.

② [이동시간 계산]:
   - 현재 선택된 이동수단(대중교통, 자동차 등)을 기준으로 방장 집 -> 나 사이의 소요 시간(분)을 계산합니다.
   - Google Maps API 호출을 우선 시도하며, 실패 시 Haversine 공식을 이용한 수동 계산(Fallback)으로 무조건 값을 산출합니다.

③ [침범 여부 판단]:
   - 시간표의 각 슬롯(T)에 대해 [T - 이동시간 ~ T] 구간을 역추적합니다.
   - 이 구간 중에 방장의 금지시간(점심시간, 개인일정, 선호시간 외)이 하나라도 포함되는지 검사합니다.

④ [시각화 (빗금)]:
   - 침범이 확인된 슬롯(수업을 놓으려는 시간)은 'travel_restricted' 타입으로 분류됩니다.
   - 해당 구역은 회색 빗금 패턴으로 칠해지며, 클릭(수업 배치)이 원천 차단됩니다.

3. 상세 수정 내역 (Modified Files)
================================================================================

[백엔드: 강력한 검증]
1. server/controllers/coordinationExchangeController.js (smartExchange)
   - 챗봇 요청 시 이동시간을 포함한 실제 시작 시간을 계산하여 방장 선호시간 침범 시 즉시 거절.
2. server/controllers/roomController.js (getRoomDetails)
   - 조원에게도 이동시간 계산에 필요한 travelTimeSlots 데이터를 안전하게 개방.
3. server/models/room.js (getUserColor)
   - 이동시간 슬롯 생성 시 조원의 고유 색상이 올바르게 매칭되도록 ID 비교 로직 강화.

[프론트엔드: 계산 및 전달]
4. client/src/hooks/useTravelMode.js
   - Firebase Auth와 연동하여 조원 본인의 이동시간(myTravelDuration)을 실시간 계산하는 핵심 엔진 구현.
5. client/src/components/tabs/CoordinationTab/index.js
   - 훅에서 계산된 이동시간 데이터를 TimetableGrid로 전달하는 브릿지 역할.
6. client/src/components/timetable/TimetableGrid.js
   - 받은 데이터를 실제 렌더링 컴포넌트인 WeekView로 최종 전달.

[UI/UX: 시각화 구현]
7. client/src/components/timetable/WeekView.js
   - 'travel_restricted' 상태 판단 로직 구현.
   - 확정된 일정(오렌지색)과 이동시간 슬롯 간의 표시 우선순위 조정 (확정 시 오렌지색으로 통일).
8. client/src/components/timetable/TimeSlot.js & WeekView.js (Style)
   - CSS repeating-linear-gradient를 이용한 회색 빗금 패턴 스타일 구현.
9. client/src/utils/timetableHelpers.js (getSlotOwner)
   - 이동시간 슬롯이 뜬금없이 하늘색으로 변하지 않고 조원 고유 색상을 유지하도록 수정.

4. 기대 효과
================================================================================
- 조원은 본인이 이동수단을 선택함에 따라 실시간으로 변하는 '수업 가능 구역'을 직관적으로 확인.
- 방장은 본인의 선호시간 이전에 조원이 이동을 시작해야 하는 불상사를 원천 차단받음.
- 챗봇과 UI가 동일한 로직으로 이중 검증하여 데이터 무결성 확보.
