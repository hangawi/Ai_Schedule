작성일: 2025-12-23
작성자: Gemini (AI Assistant) + 업데이트: Claude Sonnet 4.5
주제: 이동시간 선호시간 침범 방지 기능(빗금 표시) 구현 상세 리포트
================================================================================

1. 기능 개요
================================================================================
조원이 협업 방에서 수업을 배치할 때, 이동시간을 고려하여 실제로 배치 가능한 시간대를
직관적으로 시각화하는 기능입니다. 회색 빗금 패턴으로 "배치 불가능 구역"을 표시하여
사용자가 한눈에 파악할 수 있도록 합니다.

2. 작동 원리 (Working Principle) - 수정된 버전
================================================================================

✅ 핵심 개념: "빗금 = 이동시간 때문에 배치할 수 없는 구역"

조원이 협업 방에 입장하면 시스템은 다음의 과정을 거쳐 실시간으로 빗금 구역을 계산합니다.

① [좌표 확보]:
   - 방장과 나의 주소(위도/경도) 데이터를 가져옵니다.
   - 보안을 위해 조원에게는 상세 주소를 숨기되, 계산에 필요한 좌표값은 내부적으로 유지합니다.

② [이동시간 계산]:
   - 현재 선택된 이동수단(대중교통, 자동차 등)을 기준으로 거리별 이동시간을 계산합니다.
   - Google Maps API 호출을 우선 시도하며, 실패 시 Haversine 공식을 이용한 수동 계산(Fallback)으로 무조건 값을 산출합니다.
   - 계산해야 하는 거리:
     * 방장 위치 → 조원 위치 (하루 첫 수업용)
     * 조원A 위치 → 조원B 위치 (연속 수업용)

③ [빗금 구역 계산] - ⚠️ 중요한 수정!

   [케이스 1] 이미 배정된 수업의 이동시간 (실제 이동 구간)
   - 배정된 각 수업 시간 T에 대해:
     * 같은 날 이전 수업이 있으면: 이전수업위치 → 현재수업위치 거리
     * 이전 수업이 없으면: 방장위치 → 현재수업위치 거리
   - [T - 이동시간 ~ T] 구간을 빗금으로 표시

   예시 (B 계정, 화요일):
   ┌─────────────────────────────────────┐
   │ 10:00-12:00: A 수업 (이미 배정됨)   │
   │ 13:00-13:10: 빗금 (A→B 이동, 10분) │ ← 빗금!
   │ 13:10-15:10: B 수업 (이미 배정됨)   │
   └─────────────────────────────────────┘

   [케이스 2] 하루의 첫 시간 (방장에서 출발)
   - 해당 날짜의 첫 번째 수업이면: 방장 → 조원 거리 사용

   예시 (B 계정, 화요일 첫 시간):
   ┌─────────────────────────────────────┐
   │ 09:00-09:50: 빗금 (방장→B, 50분)   │ ← 빗금!
   │ 09:50부터: 배치 가능                │
   │ 10:00-12:00: A 수업 (이미 배정됨)   │
   └─────────────────────────────────────┘

④ [선호시간 내에서만 표시] - ⚠️ 중요!
   - 빗금은 선호시간(배치 가능한 시간대) 내에서만 표시됩니다.
   - 금지시간, 다른 일정과는 별개로 작동합니다.
   - 이미 막힌 시간(금지시간)에는 빗금을 표시하지 않습니다. (어차피 배치 불가능)

⑤ [시각화]:
   - 계산된 빗금 구역은 회색 빗금 패턴으로 표시됩니다.
   - CSS repeating-linear-gradient를 사용하여 구현됩니다.
   - 빗금 구역은 클릭이 불가능하며, 수업 배치가 원천 차단됩니다.

3. 구체적인 예시 시나리오
================================================================================

시나리오:
- A 조원: 9-10 이동시간, 10-12 수업 (화수목금)
- B 조원: 13-13:10 이동시간, 13:10-15:10 수업 (화수목금)
- 방장 → B 거리: 50분
- A → B 거리: 10분

[B 계정에서 화요일을 볼 때]

시간    상태
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
09:00 │ ╱╱╱╱╱╱╱╱ │ ← 빗금 (방장→B, 50분)
      │ ╱╱이동╱╱ │
      │ ╱╱시간╱╱ │
09:50 ├─────────┤ ← 여기부터 배치 가능!
10:00 ├─────────┤
      │  A 수업  │ (이미 배정됨, A 색상)
      │         │
12:00 ├─────────┤
      │  비어있음 │
13:00 ├╱╱╱╱╱╱╱╱┤ ← 빗금 (A→B, 10분)
      │╱╱이동╱╱│
13:10 ├─────────┤
      │  B 수업  │ (이미 배정됨, B 색상)
      │         │
15:10 └─────────┘

[B 계정에서 월요일을 볼 때 - 배정 없음]

시간    상태
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
09:00 │         │ ← 빗금 없음!
      │  비어있음 │    (배정된 수업이 없으므로)
      │         │
12:00 └─────────┘

4. 발견된 문제점 및 해결 방법
================================================================================

[문제 1] 수업시간이 잘려서 표시됨 ❌
- 증상: A 10:10-12:00, B 14:10-15:10으로 표시 (원래 10-12, 13:10-15:10)
- 원인: 서버가 클라이언트에서 받은 `e.startTime`을 그대로 저장
  → 클라이언트가 이미 조정된 시간을 보냄
- 해결: server/controllers/coordinationSchedulingController.js:1508
  ```javascript
  // 수정 전
  const pureStartTime = e.startTime;

  // 수정 후
  const pureStartTime = e.originalStartTime || e.startTime;
  ```
- 효과: timeSlots에는 원본 수업시간만 저장됨

[문제 2] 다른 사람의 이동시간까지 표시됨 ❌
- 증상: B 계정에서 A의 이동시간(9-10)까지 보임
- 원인: room.travelTimeSlots에 모든 멤버의 이동시간이 포함됨
  → 조원도 전체 travelTimeSlots를 받음
- 해결: client/src/hooks/useTravelMode.js:345-362
  ```javascript
  // 조원은 서버 데이터라도 이동시간 숨김 (프라이버시 보호)
  return {
      timeSlots: nonTravelSlots,
      travelSlots: [],  // 빈 배열 반환
      travelMode: travelMode,
      myTravelDuration
  };
  ```
- 효과: 조원은 다른 사람의 이동시간을 볼 수 없음

[문제 3] 금지시간에도 빗금이 표시됨 ❌
- 증상: 17:10-18 구간에 빗금 표시 (실제로는 금지시간)
- 원인: 빗금 계산 로직이 금지시간을 고려하지 않음
- 해결: WeekView.js에서 선호시간 내에서만 빗금 표시하도록 수정 필요
- 효과: 금지시간에는 빗금 표시 안 됨

5. 상세 수정 내역 (Modified Files)
================================================================================

[백엔드: 데이터 저장]
1. server/controllers/coordinationSchedulingController.js
   - applyTravelMode 함수 (1508번째 줄)
   - ✅ originalStartTime 우선 사용하도록 수정
   - 효과: timeSlots에 원본 수업시간만 저장

2. server/controllers/coordinationExchangeController.js (smartExchange)
   - 챗봇 요청 시 이동시간을 포함한 실제 시작 시간을 계산하여 방장 선호시간 침범 시 즉시 거절.

3. server/controllers/roomController.js (getRoomDetails)
   - 조원에게도 이동시간 계산에 필요한 travelTimeSlots 데이터를 안전하게 개방.

4. server/models/room.js (getUserColor)
   - 이동시간 슬롯 생성 시 조원의 고유 색상이 올바르게 매칭되도록 ID 비교 로직 강화.

[프론트엔드: 계산 및 전달]
5. client/src/hooks/useTravelMode.js
   - getCurrentScheduleData 함수 (265-362번째 줄)
   - ✅ 조원은 travelSlots: [] 반환 (프라이버시 보호)
   - Firebase Auth와 연동하여 조원 본인의 이동시간(myTravelDuration)을 실시간 계산하는 핵심 엔진 구현.

6. client/src/components/tabs/CoordinationTab/index.js
   - 훅에서 계산된 이동시간 데이터를 TimetableGrid로 전달하는 브릿지 역할.

7. client/src/components/timetable/TimetableGrid.js
   - 받은 데이터를 실제 렌더링 컴포넌트인 WeekView로 최종 전달.

[UI/UX: 시각화 구현]
8. client/src/components/timetable/WeekView.js
   - 'travel_restricted' 상태 판단 로직 구현.
   - ⚠️ TODO: 선호시간 내에서만 빗금 표시하도록 수정 필요
   - 확정된 일정(오렌지색)과 이동시간 슬롯 간의 표시 우선순위 조정 (확정 시 오렌지색으로 통일).

9. client/src/components/timetable/TimeSlot.js & WeekView.js (Style)
   - CSS repeating-linear-gradient를 이용한 회색 빗금 패턴 스타일 구현.

10. client/src/utils/timetableHelpers.js (getSlotOwner)
    - 이동시간 슬롯이 뜬금없이 하늘색으로 변하지 않고 조원 고유 색상을 유지하도록 수정.

6. 빗금 계산 로직 (Pseudocode)
================================================================================

```
FOR 각 요일 IN [월, 화, 수, 목, 금]:
    배정된수업들 = 해당요일에_배정된_수업들()

    IF 배정된수업들.length == 0:
        빗금_표시_안함()
        CONTINUE

    FOR 각 수업 IN 배정된수업들:
        수업시작시간 = 수업.startTime

        // 이동시간 계산
        IF 같은날_이전수업_존재():
            출발위치 = 이전수업.위치
            이동시간 = 거리계산(출발위치, 현재수업.위치)
        ELSE:
            출발위치 = 방장.위치
            이동시간 = 거리계산(방장.위치, 현재수업.위치)

        // 빗금 구간 계산
        빗금시작 = 수업시작시간 - 이동시간
        빗금종료 = 수업시작시간

        // 선호시간 내에서만 표시
        IF 빗금구간이_선호시간_내():
            빗금_표시(빗금시작, 빗금종료, 조원색상)
```

7. 기대 효과
================================================================================
- ✅ 조원은 본인의 이동시간만 볼 수 있어 프라이버시 보호
- ✅ 수업시간은 원본 그대로 표시되어 혼란 방지
- ✅ 이동시간 빗금으로 배치 가능/불가능 구역을 직관적으로 파악
- ✅ 선호시간 내에서만 빗금이 표시되어 불필요한 시각적 혼란 방지
- ✅ 하루의 첫 수업과 연속 수업을 구분하여 정확한 이동시간 계산

8. 향후 개선 사항
================================================================================
[ ] WeekView.js에서 선호시간 필터링 로직 추가
[ ] 이동시간 빗금 색상을 조원별로 구분 (현재는 회색 통일)
[ ] 이동시간 계산 캐싱으로 성능 최적화
[ ] 이동수단 변경 시 빗금 실시간 업데이트 검증
