# 4가지 버그 수정 계획

**작성일:** 2026-02-09
**상태:** 진행 중

---

## 문제 1: 일반 사용자 장소가 새로고침 시 집주소로 변경됨

### 현상
- 일반 사용자가 채팅으로 일정 추가 → 장소 정상 표시
- 새로고침 후 장소 클릭 → 이름은 유지되나 **장소가 집주소로 변경됨**
- 구글 사용자는 이 문제 없음 (Google Calendar에 별도 저장)

### 원인
`server/controllers/userController.js`의 `updateUserSchedule()` 함수에서 personalTimes를 매핑할 때 **중요 필드들이 누락됨**:

```
누락된 필드:
- locationLat (위도)
- locationLng (경도)
- transportMode (교통수단)
- roomId (조율방 ID)
- isTravelTime (이동시간 여부)
- hasTravelTime (이동시간 포함 여부)
- suggestionId (제안 ID)
- googleEventId (구글 이벤트 ID)
```

일정을 수정/추가할 때 PUT 요청이 발생하면 이 필드들이 전부 사라짐 → 좌표 없이 location 문자열만 남음 → 프론트에서 사용자 집주소로 폴백

### 수정 파일
1. `server/controllers/userController.js` - `updateUserSchedule()` 함수에 누락 필드 추가

### 수정 내용
```javascript
// 기존: location, participants, externalParticipants만 포함
// 수정: 아래 필드 추가
locationLat: pt.locationLat || null,
locationLng: pt.locationLng || null,
transportMode: pt.transportMode || null,
roomId: pt.roomId || null,
isTravelTime: pt.isTravelTime || false,
hasTravelTime: pt.hasTravelTime || false,
suggestionId: pt.suggestionId || null,
googleEventId: pt.googleEventId || null
```

### 상태: [ ] 미완료

---

## 문제 2: 일반 사용자 채팅 제안 일정 삭제 시 참여 인원별 분기 처리

### 현상
- 현재: 달력에서 삭제하면 무조건 삭제/자동불참 처리
- 원하는 동작:
  - **참여자 0~1명**: "일정이 삭제되었습니다" (완전 삭제)
  - **참여자 2명 이상**: "불참" 처리 (일정 유지, 본인만 불참)

### 관련 코드 흐름
```
달력에서 삭제 클릭
  → handleDeleteScheduleEvent() (MobileCalendarView.js)
  → DELETE /api/users/profile/schedule/:personalTimeId (profile.js 라우트)
  → 서버: personalTime 삭제 + ScheduleSuggestion에서 자동 불참
```

### 수정 파일
1. `server/routes/profile.js` - DELETE /api/users/profile/schedule/:personalTimeId 핸들러
   - suggestionId가 있으면 accepted 멤버 수 확인
   - 2명 이상이면 불참 처리만 (personalTime 삭제 + suggestion에서 rejected)
   - 1명 이하면 suggestion 자체를 cancelled로 변경 + 전체 삭제
2. `client/src/components/mobile/MobileCalendarView.js` - 삭제 결과에 따른 메시지 분기

### 수정 로직
```
DELETE /api/users/profile/schedule/:personalTimeId
  1. personalTime에서 suggestionId 추출
  2. ScheduleSuggestion 조회
  3. accepted 멤버 수 확인 (getResponseStats())
  4. if (accepted >= 2):
       → 본인만 rejected 처리
       → 본인 personalTime만 삭제
       → 다른 참여자 participants 수 업데이트
       → 응답: { action: 'rejected', message: '불참 처리되었습니다' }
  5. else:
       → suggestion.status = 'cancelled'
       → 모든 참여자 personalTime 삭제
       → 응답: { action: 'deleted', message: '일정이 삭제되었습니다' }
```

### 상태: [ ] 미완료

---

## 문제 3: 구글 사용자 채팅 제안 일정 달력에서 삭제 불가 (400 에러)

### 현상
- 구글 사용자가 채팅방에서 일정 제안 후 달력에서 삭제 시도
- `PUT http://localhost:5000/api/users/profile/schedule 400 (Bad Request)` 발생

### 원인
구글 사용자는 채팅 제안 수락 시 `personalTimes`에 저장하지 않고 Google Calendar에만 저장함 (중복 방지 3차 수정의 부작용). 따라서:
- 달력에서 삭제할 때 personalTimeId가 없음
- 클라이언트가 잘못된 엔드포인트(PUT)를 호출하거나, personalTimeId 없이 DELETE 호출

### 수정 파일
1. `client/src/components/mobile/MobileCalendarView.js` - `handleDeleteScheduleEvent()`
   - 구글 사용자의 제안 일정 삭제 시 올바른 엔드포인트 호출
   - `DELETE /api/users/profile/schedule/google/:suggestionId` 사용
2. `server/routes/profile.js` - 구글 사용자 삭제 엔드포인트에도 문제 2의 참여 인원별 분기 적용

### 수정 로직
```
handleDeleteScheduleEvent(event):
  if (event.suggestionId && isGoogleUser):
    → DELETE /api/users/profile/schedule/google/:suggestionId
    → 참여 인원별 분기 (문제 2와 동일 로직)
  elif (event.suggestionId && !isGoogleUser):
    → DELETE /api/users/profile/schedule/:personalTimeId
    → 참여 인원별 분기 (문제 2와 동일 로직)
  else:
    → 일반 일정 삭제 (기존 로직)
```

### 상태: [ ] 미완료

---

## 문제 4: 선호시간 겹침 기반 최적 만남 시간 추천 버튼

### 현상
- 현재 `findOptimalSlots()` 함수가 `schedulingAnalysisService.js`에 존재하나 HTTP 엔드포인트가 없음
- 프론트엔드 UI도 없음

### 원하는 동작
1. 버튼 클릭 → 즉시 참여자들의 선호시간 비교
2. 겹치는 시간대를 후보로 표시
3. 사용자가 후보 중 하나를 선택 → 확정

### 예시
```
A: 월, 화, 금 선호
B: 월, 목, 금 선호
C: 월, 수, 금 선호
→ 후보: 월, 금 (3명 모두 가능)
→ 사용자가 "금" 선택 → 확정
```

### 수정 파일

#### 백엔드
1. `server/routes/coordination.js` - 새 라우트 추가
2. `server/controllers/coordinationController.js` - `findOptimalMeetingTime` 핸들러 추가

#### 프론트엔드
3. `client/src/components/tabs/CoordinationTab/components/RoomHeader.js` - "최적 시간 찾기" 버튼 추가
4. 새 컴포넌트: `client/src/components/modals/OptimalTimeModal.js` - 후보 표시 및 선택 모달

### 수정 로직
```
버튼 클릭
  → POST /api/coordination/rooms/:roomId/find-optimal-time
  → 서버: 모든 멤버의 defaultSchedule 수집
  → 겹치는 요일/시간대 계산
  → 후보 목록 반환 (예: [{day: '월', times: ['14:00-16:00']}, ...])
  → 프론트: 모달에 후보 표시
  → 사용자 선택 → 확정 API 호출
```

### 상태: [ ] 미완료

---

## 작업 순서

| 순서 | 문제 | 예상 난이도 | 의존성 |
|------|------|------------|--------|
| 1 | 문제 1: 장소 필드 누락 | 낮음 | 없음 |
| 2 | 문제 2: 일반 사용자 삭제 분기 | 중간 | 없음 |
| 3 | 문제 3: 구글 사용자 삭제 오류 | 중간 | 문제 2 로직 공유 |
| 4 | 문제 4: 최적 시간 추천 | 높음 | 없음 |

---

## 진행 기록

### 문제 1 수정
- [ ] 시작
- [ ] 코드 수정 완료
- [ ] 테스트 완료

### 문제 2 수정
- [ ] 시작
- [ ] 코드 수정 완료
- [ ] 테스트 완료

### 문제 3 수정
- [ ] 시작
- [ ] 코드 수정 완료
- [ ] 테스트 완료

### 문제 4 수정
- [ ] 시작
- [ ] 코드 수정 완료
- [ ] 테스트 완료
