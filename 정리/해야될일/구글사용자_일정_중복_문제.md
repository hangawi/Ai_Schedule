# êµ¬ê¸€ ì‚¬ìš©ì ì¼ì • ì¤‘ë³µ ë° ë™ê¸°í™” ë¬¸ì œ

## ë°œê²¬ì¼: 2026-02-06

---

## ë¬¸ì œ 1: ì‹œê°„ í•´ì„ ëª¨í˜¸ì„±

### í˜„ìƒ
- ì‚¬ìš©ìê°€ "10ì‹œê¹Œì§€ ë†€ì"ë¼ê³  í–ˆì„ ë•Œ AIê°€ **ì˜¤ì „ 10ì‹œ(10:00)**ë¡œ í•´ì„
- "ì˜¤í›„ 10ì‹œê¹Œì§€ ë†€ì"ë¼ê³  ëª…ì‹œí•´ì•¼ **22:00**ìœ¼ë¡œ ì˜¬ë°”ë¥´ê²Œ í•´ì„

### ì›ì¸
- AI í”„ë¡¬í”„íŠ¸ì—ì„œ ì‹œê°„ í•´ì„ ì‹œ ì˜¤ì „/ì˜¤í›„ êµ¬ë¶„ì´ ëª…í™•í•˜ì§€ ì•ŠìŒ
- ì»¨í…ìŠ¤íŠ¸(ì˜¤í›„ 2ì‹œë¶€í„° ì‹œì‘í•˜ëŠ” ì¼ì •)ë¥¼ ê³ ë ¤í•˜ì§€ ì•ŠìŒ

### í•´ê²°ë°©ì•ˆ
1. **í”„ë¡¬í”„íŠ¸ ê°œì„ **: `server/prompts/scheduleAnalysis.js`ì—ì„œ ì‹œê°„ í•´ì„ ê·œì¹™ ì¶”ê°€
   - ì‹œì‘ ì‹œê°„ì´ ì˜¤í›„ì¸ ê²½ìš°, ì¢…ë£Œ ì‹œê°„ë„ ì˜¤í›„ë¡œ ì¶”ì •
   - "10ì‹œ"ì²˜ëŸ¼ ì˜¤ì „/ì˜¤í›„ê°€ ì—†ìœ¼ë©´ ì»¨í…ìŠ¤íŠ¸ì— ë”°ë¼ íŒë‹¨
   - ì˜ˆ: ì˜¤í›„ 2ì‹œ ì‹œì‘ â†’ "10ì‹œê¹Œì§€" â†’ 22:00ìœ¼ë¡œ í•´ì„

### ê´€ë ¨ íŒŒì¼
- `server/prompts/scheduleAnalysis.js`
- `server/services/aiScheduleService.js`

---

## ë¬¸ì œ 2: êµ¬ê¸€ ì‚¬ìš©ì ì°¸ì„ ì‹œ ì¼ì • ì¤‘ë³µ í‘œì‹œ

### í˜„ìƒ
- êµ¬ê¸€ ì‚¬ìš©ìê°€ ì±„íŒ…ë°©ì—ì„œ **ì°¸ì„** í´ë¦­
- ë‹¬ë ¥ í˜ì´ì§€ì—ì„œ **ë¹¨ê°„ìƒ‰(personalTimes) + ì´ˆë¡ìƒ‰(Google Calendar)** 2ê°œê°€ í‘œì‹œë¨
- ì¼ì • í˜ì´ì§€ì—ì„œëŠ” 1ê°œë§Œ í‘œì‹œë¨

### ì›ì¸
1. ì°¸ì„ ì²˜ë¦¬ ì‹œ `User.personalTimes`ì— ì €ì¥ (ë¹¨ê°„ìƒ‰)
2. ë™ì‹œì— `syncToGoogleCalendar()`ë¡œ Google Calendarì—ë„ ë™ê¸°í™” (ì´ˆë¡ìƒ‰)
3. `MobileCalendarView.js`ì—ì„œ **ë‘ ì†ŒìŠ¤ë¥¼ ëª¨ë‘ í‘œì‹œ**í•˜ì—¬ ì¤‘ë³µ

### í•´ê²°ë°©ì•ˆ

**ë°©ì•ˆ A: êµ¬ê¸€ ì‚¬ìš©ìëŠ” personalTimesì— ì €ì¥í•˜ì§€ ì•ŠìŒ** (ê¶Œì¥)
- êµ¬ê¸€ ì‚¬ìš©ìëŠ” Google Calendarë§Œ ì‚¬ìš©
- `handleAutoResponse()`ì—ì„œ êµ¬ê¸€ ì‚¬ìš©ì ë¶„ê¸° ì²˜ë¦¬
- ì¥ì : ë‹¨ì¼ ì†ŒìŠ¤, ì¤‘ë³µ ì—†ìŒ
- ë‹¨ì : ì½”ë“œ ë¶„ê¸° ì¦ê°€

**ë°©ì•ˆ B: ë‹¬ë ¥ í‘œì‹œ ì‹œ ì¤‘ë³µ ì œê±°**
- Google Calendar ì´ë²¤íŠ¸ì™€ personalTimes ì¤‘ í•˜ë‚˜ë§Œ í‘œì‹œ
- `extendedProperties.private.suggestionId`ë¡œ ë§¤ì¹­í•˜ì—¬ ì¤‘ë³µ ì œê±°
- ì¥ì : ê¸°ì¡´ ë¡œì§ ìœ ì§€
- ë‹¨ì : í‘œì‹œ ë¡œì§ ë³µì¡

**ë°©ì•ˆ C: personalTimesë¥¼ ë§ˆìŠ¤í„°ë¡œ, Google CalendarëŠ” ë™ê¸°í™” ì „ìš©**
- personalTimesì—ë§Œ ì €ì¥í•˜ê³  Google CalendarëŠ” ì½ê¸° ì „ìš©ìœ¼ë¡œ ë™ê¸°í™”
- ë‹¬ë ¥ì—ì„œ Google Calendar ì´ë²¤íŠ¸ ì¤‘ suggestionIdê°€ ìˆëŠ” ê²ƒì€ ìˆ¨ê¹€

### ê´€ë ¨ íŒŒì¼
- `server/services/aiScheduleService.js` - `handleAutoResponse()` í•¨ìˆ˜
- `server/services/confirmScheduleService.js` - `syncToGoogleCalendar()` í•¨ìˆ˜
- `client/src/components/mobile/MobileCalendarView.js` - ì´ë²¤íŠ¸ í‘œì‹œ ë¡œì§

---

## ë¬¸ì œ 3: ê±°ì ˆ ì‹œ Google Calendar ì´ë²¤íŠ¸ ë¯¸ì‚­ì œ

### í˜„ìƒ
- ì±„íŒ…ë°©ì—ì„œ **ê±°ì ˆ** í´ë¦­
- ë¹¨ê°„ìƒ‰(personalTimes) â†’ ì‚­ì œë¨ âœ…
- ì´ˆë¡ìƒ‰(Google Calendar) â†’ ë‚¨ì•„ìˆìŒ âŒ

### ì›ì¸
- `handleAutoResponse()`ì˜ reject ì²˜ë¦¬ì—ì„œ `personalTimes`ë§Œ ì‚­ì œ
- Google Calendar ì´ë²¤íŠ¸ ì‚­ì œ ë¡œì§ ì—†ìŒ

### í•´ê²°ë°©ì•ˆ

```javascript
// server/services/aiScheduleService.js - handleAutoResponse() ë‚´ reject ì²˜ë¦¬

} else if (sentiment === 'reject') {
  userResponse.status = 'rejected';
  userResponse.respondedAt = new Date();

  // ğŸ†• ì´ë¯¸ ìˆ˜ë½í•´ì„œ personalTimeì´ ìˆì—ˆë‹¤ë©´ ì œê±°
  if (userResponse.personalTimeId) {
    const rejectUser = await User.findById(userId);
    if (rejectUser) {
      // personalTimeì—ì„œ í•´ë‹¹ ì¼ì • ì°¾ê¸°
      const ptToRemove = rejectUser.personalTimes.find(
        pt => pt.suggestionId === suggestion._id.toString()
      );

      // ğŸ†• êµ¬ê¸€ ì‚¬ìš©ìë©´ Google Calendarì—ì„œë„ ì‚­ì œ
      if (rejectUser.google?.refreshToken && ptToRemove) {
        try {
          await deleteFromGoogleCalendar(rejectUser, ptToRemove);
        } catch (gcErr) {
          console.warn('Google Calendar ì‚­ì œ ì‹¤íŒ¨:', gcErr.message);
        }
      }

      rejectUser.personalTimes = rejectUser.personalTimes.filter(
        pt => pt.suggestionId !== suggestion._id.toString()
      );
      await rejectUser.save();
    }
    userResponse.personalTimeId = null;
  }

  await suggestion.save();
  // ...
}
```

### í•„ìš”í•œ ì¶”ê°€ í•¨ìˆ˜
```javascript
// server/services/confirmScheduleService.jsì— ì¶”ê°€

async function deleteFromGoogleCalendar(user, personalTime) {
  const oauth2Client = new google.auth.OAuth2(...);
  oauth2Client.setCredentials({ refresh_token: user.google.refreshToken });

  const calendar = google.calendar({ version: 'v3', auth: oauth2Client });

  // suggestionIdë¡œ ì´ë²¤íŠ¸ ì°¾ê¸°
  const events = await calendar.events.list({
    calendarId: 'primary',
    privateExtendedProperty: `suggestionId=${personalTime.suggestionId}`
  });

  // ì°¾ì€ ì´ë²¤íŠ¸ ì‚­ì œ
  for (const event of events.data.items || []) {
    await calendar.events.delete({
      calendarId: 'primary',
      eventId: event.id
    });
  }
}
```

### ê´€ë ¨ íŒŒì¼
- `server/services/aiScheduleService.js` - reject ì²˜ë¦¬ ë¡œì§
- `server/services/confirmScheduleService.js` - Google Calendar ì‚­ì œ í•¨ìˆ˜ ì¶”ê°€ í•„ìš”
- `server/controllers/chatController.js` - `rejectSuggestion()` í•¨ìˆ˜

---

## ìë™ ë¶ˆì°¸ ê¸°ëŠ¥ ì ê²€ ê²°ê³¼

### í˜„ì¬ ìƒíƒœ: ì •ìƒ ë™ì‘ âœ…

### ë™ì‘ íë¦„
1. **ìƒˆ ì¼ì • ìƒì„± ì‹œ** (`handleNewSchedule`)
   - `preferenceService.checkTimeConflict()`ë¡œ ì¶©ëŒ ì²´í¬
   - ì¶©ëŒ ìˆëŠ” ë©¤ë²„ëŠ” `isAutoRejected: true`, `status: 'rejected'`ë¡œ ì„¤ì •
   - ì‹œìŠ¤í…œ ë©”ì‹œì§€: "ğŸš« OOOë‹˜ì€ í•´ë‹¹ ì‹œê°„ì— ì¼ì •ì´ ìˆì–´ ìë™ ë¶ˆì°¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤"

2. **ì‹œê°„ ë³€ê²½ ì‹œ** (`handleExtendSchedule`)
   - ëª¨ë“  ë©¤ë²„ ì¬ì²´í¬
   - ìƒˆë¡œ ì¶©ëŒ ìƒê¸´ ë©¤ë²„ â†’ ìë™ ë¶ˆì°¸
   - ì¶©ëŒ í•´ì†Œëœ ë©¤ë²„ â†’ pendingìœ¼ë¡œ ë³µêµ¬
   - ì‹œìŠ¤í…œ ë©”ì‹œì§€: "âš ï¸ ì‹œê°„ ë³€ê²½ìœ¼ë¡œ OOOë‹˜ì´ ìë™ ë¶ˆì°¸ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤"

3. **ìë™ ë¶ˆì°¸ì ì°¸ì„ ì˜ì‚¬ í‘œí˜„ ì‹œ** (`handleAutoResponse`)
   - ì¶©ëŒ ì¼ì • ì¬í™•ì¸
   - ì¶©ëŒ ìˆìœ¼ë©´ â†’ `conflict-confirmation-needed` ì†Œì¼“ ì´ë²¤íŠ¸
   - ì¶©ëŒ ì—†ìœ¼ë©´ â†’ ì°¸ì„ ì²˜ë¦¬

### í™•ì¸ í•„ìš” ì‚¬í•­
- [ ] ì‹œê°„ ë³€ê²½ ì‹œ ìë™ ë¶ˆì°¸ ì²˜ë¦¬ê°€ ì‹¤ì œë¡œ ë™ì‘í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸
- [ ] ìë™ ë¶ˆì°¸ìê°€ "ê°ˆê²Œ"ë¼ê³  í–ˆì„ ë•Œ ì¶©ëŒ í™•ì¸ ëª¨ë‹¬ì´ ëœ¨ëŠ”ì§€ í…ŒìŠ¤íŠ¸

---

## ìš°ì„ ìˆœìœ„

| ìˆœìœ„ | ë¬¸ì œ | ì‹¬ê°ë„ | ì˜ˆìƒ ì‘ì—…ëŸ‰ |
|------|------|--------|-------------|
| 1 | ê±°ì ˆ ì‹œ Google Calendar ë¯¸ì‚­ì œ | ë†’ìŒ | ì¤‘ |
| 2 | ì°¸ì„ ì‹œ ì¼ì • ì¤‘ë³µ í‘œì‹œ | ë†’ìŒ | ì¤‘ |
| 3 | ì‹œê°„ í•´ì„ ëª¨í˜¸ì„± | ë‚®ìŒ | ì†Œ |

---

## ì‘ì„±ì ë©”ëª¨
- ë¬¸ì œ 2, 3ì€ ì—°ê´€ë˜ì–´ ìˆìŒ - êµ¬ê¸€ ì‚¬ìš©ìì˜ ì¼ì • ì €ì¥ ë°©ì‹ì„ í†µì¼í•´ì•¼ í•¨
- ê·¼ë³¸ì  í•´ê²°: êµ¬ê¸€ ì‚¬ìš©ìëŠ” Google Calendarë¥¼ ë‹¨ì¼ ì†ŒìŠ¤ë¡œ ì‚¬ìš©
