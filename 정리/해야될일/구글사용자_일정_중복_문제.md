# 구글 사용자 일정 중복 및 동기화 문제

## 발견일: 2026-02-06
## 최종 수정: 2026-02-06

---

## 문제 1: 날짜 계산 오류 (미해결)

### 현상
- 오늘: 2026-02-06 (금요일)
- "다음 주 월요일" → 2월 9일이 맞는데 **2월 10일로 계산됨**

### 원인
- AI 프롬프트에서 "다음 주" 계산 로직 오류

### 해결방안
- `server/prompts/scheduleAnalysis.js`에서 날짜 계산 규칙 명확화
- 오늘 날짜와 요일 정보를 프롬프트에 더 명확하게 전달

### 관련 파일
- `server/prompts/scheduleAnalysis.js`

---

## 문제 2: extend 시 다른 일정을 "같은 값"으로 판단 (미해결)

### 현상
- 2월 10일 일정이 이미 22:00으로 변경된 상태
- 2월 9일 일정을 22:00으로 변경하려 함
- AI가 "이미 같은 값"이라며 스킵

```
[AI분석] 이미 같은 값 - extend 스킵: {
  data: {},
  old: { oldEndTime: '22:00' }  // 2월 10일 값을 참조하고 있음
}
```

### 원인
- AI가 반환한 `targetId`가 잘못되었거나
- extend 처리 시 날짜를 고려하지 않고 비교

### 해결방안
- extend 비교 시 날짜도 함께 확인
- 또는 AI 프롬프트에서 targetId 정확성 개선

### 관련 파일
- `server/services/aiScheduleService.js` - `handleExtendSchedule()` 함수
- `server/prompts/scheduleAnalysis.js`

---

## 문제 3: 구글 사용자 참석 시 일정 중복 표시 (✅ 최종 해결)

### 현상
- 구글 사용자가 채팅방에서 **참석** 클릭
- 달력 페이지에서 **빨간색(personalTimes) + 초록색(Google Calendar)** 2개가 표시됨

### 1차 시도 (실패)
- 클라이언트에서 `suggestionId`로 중복 필터링 시도
- extendedProperties가 응답에 포함되지 않는 경우 필터링 실패

### 2차 시도 (실패)
- 제목+날짜+시간으로 중복 필터링
- 여전히 서버에서 personalTimes에 저장하고 있어서 중복 발생

### 3차 수정 - 근본 원인 해결 (2026-02-06) ✅
**근본 원인:** 구글 사용자도 `user.personalTimes.push()`가 실행되어 DB에 저장됨

**해결책:** 구글 사용자는 Google Calendar에만 저장, personalTimes 저장 스킵

**수정 파일:**
1. `server/services/aiScheduleService.js` - `handleAutoResponse()` 함수
2. `server/controllers/chatController.js` - `acceptSuggestion()`, `rejectSuggestion()` 함수

**핵심 코드 변경:**
```javascript
const isGoogleUser = !!(user.google && user.google.refreshToken);

if (isGoogleUser) {
  // 🆕 구글 사용자: Google Calendar에만 저장 (personalTimes에 저장 안 함)
  await syncToGoogleCalendar(user, newPersonalTime, participantNames);
  userResponse.personalTimeId = null;  // Google Calendar가 source of truth
} else {
  // 일반 사용자: personalTimes에 저장
  user.personalTimes.push(newPersonalTime);
  await user.save();
  userResponse.personalTimeId = newPersonalTime.id;
}
```

**reject 시에도 동일 로직:**
```javascript
if (isGoogleUser) {
  // 구글 사용자: Google Calendar에서만 삭제 (personalTimes 없음)
  await deleteFromGoogleCalendar(user, ptData);
} else if (userResponse.personalTimeId) {
  // 일반 사용자: personalTimes에서 삭제
  user.personalTimes = user.personalTimes.filter(pt => pt.suggestionId !== suggestionId);
  await user.save();
}
```

### 관련 파일
- `server/services/aiScheduleService.js:614-950` - handleAutoResponse
- `server/controllers/chatController.js:392-549` - acceptSuggestion
- `server/controllers/chatController.js:770-871` - rejectSuggestion
- `server/services/confirmScheduleService.js` - syncToGoogleCalendar, deleteFromGoogleCalendar

---

## 문제 4: 시간 해석 모호성 (미해결)

### 현상
- "10시까지 놀자" → 오전 10시(10:00)로 해석
- 컨텍스트(오후 2시 시작)를 고려하면 22:00이어야 함

### 해결방안
- 프롬프트 개선: 시작 시간이 오후면 종료 시간도 오후로 추정

### 관련 파일
- `server/prompts/scheduleAnalysis.js`

---

## 문제 5: 일반 사용자 채팅 일정 추가 시 장소(location) 미표시 (✅ 해결)

### 현상
- 구글 사용자: "조선호텔에서 밥약속" → 장소 정상 표시
- 일반 사용자: "조선호텔에서 밥약속" → 장소 미표시 ("장소 미정")

### 원인
- 서버 재시작 필요 (코드 변경 후 서버가 재시작되지 않아서 발생)
- `updateUserSchedule`에서 `location` 필드 매핑 확인 완료

### 해결 (2026-02-06) ✅
- 서버 재시작 후 정상 작동
- 관련 코드 확인 완료:
  - `client/src/hooks/useChat/utils/apiRequestUtils.js` - `createSingleProfilePersonalTime()` 에서 `location: eventData.location || ''` 포함
  - `server/controllers/userController.js` - `updateUserSchedule()` 에서 `location: pt.location || ''` 매핑

### 관련 파일
- `client/src/hooks/useChat/utils/apiRequestUtils.js`
- `client/src/hooks/useChat/hooks/useEventAdd.js`
- `server/controllers/userController.js`

---

## 완료된 작업 (2026-02-05 ~ 2026-02-06)

### 2026-02-05
1. **isGoogleUser 분기 제거** (~12개 파일)
   - 모든 사용자가 DB를 primary data source로 사용
   - Google Calendar는 보조 표시용 (초록색)

2. **채팅 장소 자동 감지 추가**
   - `unifiedPrompt.js`에 location 추출 규칙 추가

3. **마이크 버튼 음성인식 연결**
   - BottomNavigation에서 `?voice=start` query param 사용

4. **카메라 버튼 OCR 연결**
   - Gemini 2.0 Flash 사용
   - BottomNavigation에서 `?camera=open` query param 사용

5. **문서 통합**
   - 3개 개발 문서를 `프로젝트_개발_가이드.md`로 통합

### 2026-02-06
1. **채팅 참여자 추출 및 저장**
   - "형우랑 창정이랑 지윤이랑 밥약속" → `externalParticipants: [{name: "형우"}, {name: "창정"}, {name: "지윤"}]`
   - 구글/일반 사용자 모두 지원

2. **참여자 뱃지 디자인 통일**
   - 조율방 확정 일정과 동일한 파란색 뱃지 디자인 적용
   - `EventDetailModal.js` 수정

3. **편집 모드 개선**
   - 삭제 버튼: 편집 모드에서만 표시
   - 취소 시 상태 복원 (initialState 패턴)
   - Google 일정 삭제도 편집 모드에서만 가능

4. **일반 사용자 location 문제 해결**
   - 서버 재시작으로 해결

5. **"다다음주" 날짜 계산 규칙 추가**
   - `unifiedPrompt.js`에 "다다음주 월요일 → 다음주 +7일" 규칙 추가

---

## 우선순위

| 순위 | 문제 | 심각도 | 상태 |
|------|------|--------|------|
| 1 | 구글 사용자 중복 표시 | 높음 | ✅ 최종 해결 (3차) |
| 2 | 일반 사용자 location 미표시 | 높음 | ✅ 해결 |
| 3 | extend "같은 값" 오판 | 중간 | 미해결 |
| 4 | 날짜 계산 오류 | 중간 | 미해결 |
| 5 | 시간 해석 모호성 | 낮음 | 미해결 |
