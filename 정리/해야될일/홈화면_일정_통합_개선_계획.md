# 홈화면 일정 통합 개선 - 완료 보고서

**작성일:** 2026-01-30
**최종 업데이트:** 2026-01-30 (오후)
**상태:** ✅ **기본 기능 완료 (일부 개선 필요)**

---

## 📋 목차
1. [원래 문제점](#원래-문제점)
2. [완료된 작업](#완료된-작업)
3. [발견된 버그 및 수정](#발견된-버그-및-수정)
4. [추가 구현된 기능](#추가-구현된-기능)
5. [남은 작업](#남은-작업)
6. [파일 변경 이력](#파일-변경-이력)
7. [테스트 가이드](#테스트-가이드)

---

## 원래 문제점

### 1. ❌ 참석자 수 표시 오류
**문제:** 홈화면 일정 탭에서 참석자가 여러 명인데 "1명"으로만 표시됨
**원인:** MobileScheduleView.js에서 `participants: 1`로 하드코딩됨

### 2. ❌ 장소 표시 오류
**문제:** 채팅에서 "의정부 CGV", "의정부 시내" 같은 장소 언급을 AI가 감지하지 못함
**원인:** scheduleAnalysis.js 프롬프트에 장소 감지 로직이 없음

### 3. ❌ 디자인 불일치
**문제:** 확정된 일정이 다른 곳에서는 초록색인데, 홈화면에서는 흰색으로 표시됨
**원인:** 확정 조건 스타일이 적용되지 않음

---

## 완료된 작업

### ✅ Task 1: 참석자 수 정확히 표시

#### 수정한 파일
1. **`server/services/aiScheduleService.js`** (Line 370-396)

**수정 내용:**
```javascript
// ❌ 이전: personalTime에 participants 필드가 없었음

// ✅ 수정 후
const acceptedCount = suggestion.memberResponses.filter(r => r.status === 'accepted').length;

const newPersonalTime = {
  id: ...,
  title: `[약속] ${suggestion.summary}`,
  // ... 기존 필드들 ...
  participants: acceptedCount,  // 🆕 실제 참석자 수
  suggestionId: suggestion._id.toString()  // 🆕 원본 일정 ID
};
```

**핵심 변경점:**
- `userResponse.status = 'accepted'` 를 **먼저** 업데이트
- 그 다음 acceptedCount 계산 (현재 사용자 포함)
- personalTime에 participants와 suggestionId 저장

2. **`client/src/components/mobile/MobileScheduleView.js`** (Line 158, 182, 202)

**수정 내용:**
```javascript
// ❌ 이전: participants: 1 (하드코딩)

// ✅ 수정 후
participants: pt.participants || 1  // DB에서 가져온 실제 값 사용
```

**핵심 변경점:**
- 3곳 모두 하드코딩 제거
- DB에 저장된 participants 값 사용
- 없으면 기본값 1

---

### ✅ Task 2: AI 장소 자동 감지

#### 수정한 파일
1. **`server/prompts/scheduleAnalysis.js`**

**추가한 내용 (Line 1354~1383):**

```markdown
**🆕 장소(location) 필드 처리 규칙 🆕**

**1. 장소 감지 기준:**
- ✅ 구체적인 장소명: "의정부 CGV", "강남역 스타벅스"
- ✅ 일반 지역: "의정부 시내", "강남", "홍대"
- ❌ 장소 미언급: 빈 문자열 ""

**2. 장소 추출 예시:**
- "의정부 CGV에서 영화 보자" → location: "의정부 CGV"
- "강남역 2번 출구 스타벅스" → location: "강남역 스타벅스"
- "밥 먹자" (장소 없음) → location: ""
```

**추가한 예시 (Line 157~195):**
- 예시 2-1: 장소 포함 케이스 ("의정부 CGV")
- 예시 2-2: 장소 변경 (extend) 케이스

**출력 JSON 형식 (Line 1394~1405):**
```json
{
  "action": "new",
  "data": {
    "summary": "영화",
    "date": "2026-01-28",
    "startTime": "19:00",
    "endTime": "21:00",
    "location": "의정부 CGV"  // 🆕 AI가 자동 감지
  }
}
```

2. **`client/src/components/chat/SuggestionModal.js`** (Line 332-346)

**수정 내용:**
```javascript
// ❌ 이전: location이 있을 때만 표시
{suggestion.location && (
  <div>...</div>
)}

// ✅ 수정 후: 항상 표시 (없으면 "미정")
<div className="flex items-center gap-2">
  <MapPin size={14} />
  <span className={suggestion.location ? '' : 'text-gray-400'}>
    {suggestion.location || '미정'}
  </span>
</div>
```

---

### ✅ Task 3: 디자인 통일 (초록색 배경)

#### 수정한 파일
1. **`client/src/components/tabs/DashboardTab.js`** (Line 70-74)

**수정 내용:**
```javascript
const EventCard = ({ title, time, participants, priority, isCoordinated, roomName }) => {
  // 🆕 확정 조건: 참석자 2명 이상
  const isConfirmed = isCoordinated && participants >= 2;

  return (
    <div className={`... ${isConfirmed
      ? 'bg-green-50 border-green-300'  // 초록색
      : 'bg-white border-gray-200'       // 흰색
    } ...`}>
  );
};
```

2. **`client/src/components/mobile/MobileScheduleView.js`** (Line 12-17)

**수정 내용:**
```javascript
const EventCard = ({ event, onClick, isToday, isHighlighted, cardRef }) => {
  // 🆕 확정 조건
  const isConfirmed = event.isCoordinated && event.participants >= 2;

  return (
    <div className={`event-card ${isConfirmed ? 'confirmed' : ...} ...`}>
  );
};
```

3. **`client/src/components/mobile/MobileScheduleView.css`** (Line 356~363)

**추가한 CSS:**
```css
/* 🆕 확정된 일정 스타일 (참석자 2명 이상) */
.event-card.confirmed {
   border-color: #10b981;
   border-left-width: 4px;
   background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 20%, #d1fae5 100%);
   box-shadow: 0 2px 8px rgba(16, 185, 129, 0.15);
}
```

**확정 기준:**
- `isCoordinated === true` (AI 일정 조율로 생성)
- `participants >= 2` (2명 이상 참석)

---

## 발견된 버그 및 수정

### 🐛 Bug 1: 기존 데이터에는 participants 필드 없음

**문제:**
새로 수정한 코드는 **새로 생성되는 일정**에만 적용됨.
**기존에 만들어진 일정**에는 participants 필드가 없어서 여전히 1로 표시됨.

**해결 방법:**
1. **임시 방안:** 기존 일정은 `pt.participants || 1`로 기본값 1 사용
2. **완벽한 해결:**
   - suggestionId를 사용해서 실시간으로 ScheduleSuggestion에서 참석자 수 조회
   - 또는 DB 마이그레이션 스크립트로 기존 데이터 업데이트

**현재 상태:** 임시 방안 적용 완료 ✅

---

### 🐛 Bug 2: nextEvent.participants 참조 오류

**문제:**
Line 202에서 `nextEvent`가 정의되지 않은 영역에서 `nextEvent.participants` 참조

**원인:**
replace_all로 일괄 치환하면서 실수로 잘못된 변수 참조

**수정:**
```javascript
// ❌ 잘못된 코드
participants: pt.participants || nextEvent.participants || 1

// ✅ 수정 후
participants: pt.participants || 1
```

**파일:** `MobileScheduleView.js` Line 202
**상태:** 수정 완료 ✅

---

## 추가 구현된 기능

### 🆕 추가 기능 1: 일정 상세 모달 (지도 + 대중교통)

**요청:** "누르면 자세하게 볼 수 있는 모달이 나왔으면 좋겠고 지도로 표시됐으면 좋겠어"

#### 새로 만든 파일
**`client/src/components/chat/ScheduleDetailModal.js`** (전체 신규)

**기능:**
1. ✅ 일정 상세 정보 표시 (날짜, 시간, 장소, 참석자)
2. ✅ Google Maps로 위치 표시 (마커 포함)
3. ✅ 사용자 집 → 약속 장소 대중교통 경로
4. ✅ 소요 시간, 거리, 환승 정보
5. ✅ 단계별 경로 안내 (버스/지하철 노선, 정거장 수)

**구현 세부사항:**
```javascript
// Google Maps API 사용
- Geocoder: 주소 → 좌표 변환
- Map: 지도 표시
- Marker: 위치 마커
- DirectionsService: 경로 계산
- DirectionsRenderer: 경로 표시

// 대중교통 옵션
transitOptions: {
  modes: ['BUS', 'SUBWAY', 'TRAIN'],
  routingPreference: 'FEWER_TRANSFERS'  // 환승 최소화
}
```

**모달 열기:**
- SuggestionModal에서 일정 카드 클릭
- 제목 또는 날짜/시간/장소 영역 클릭 시 열림

---

### 🆕 추가 기능 2: 모바일 반응형 모달

**요청:** "모바일에 맞게 크기 조절해주고"

**수정한 내용:**
- 모바일: 패딩 줄임 (`p-4 sm:p-6`)
- 텍스트: 작게 표시 (`text-sm sm:text-base`)
- 지도: 높이 조정 (`h-48 sm:h-64`)
- 최대 높이: 화면 가득 (`max-h-[95vh] sm:max-h-[90vh]`)

**변경 파일:** `ScheduleDetailModal.js` (전체)

---

### 🆕 추가 기능 3: 배경 클릭으로 모달 닫기

**요청:** "바탕을 누르면 없어지게 해줘"

**구현:**
```javascript
const handleBackdropClick = (e) => {
  if (e.target === e.currentTarget) {
    onClose();
  }
};

<div onClick={handleBackdropClick}>  {/* 배경 */}
  <div onClick={(e) => e.stopPropagation()}>  {/* 모달 내용 */}
    ...
  </div>
</div>
```

**동작:**
- 모달 바깥 어두운 부분 클릭 → 모달 닫힘 ✅
- 모달 내부 클릭 → 그대로 유지 ✅

**변경 파일:** `ScheduleDetailModal.js` (Line 131-138)

---

### 🆕 추가 기능 4: 채팅방 새로고침 시 페이지 유지

**요청:** "채팅방에서 새로고침하면 채팅방에서 되게해줘"

**문제:**
채팅방에 있는데 F5 누르면 → 홈화면으로 이동됨

**원인:**
- localStorage에는 currentRoomId 저장됨
- 하지만 새로고침 시 자동으로 복원하는 로직이 없었음

**해결:**
```javascript
// SchedulingSystem.js에 추가
useEffect(() => {
  const currentRoomId = localStorage.getItem('currentRoomId');
  const savedTab = localStorage.getItem('activeTab');

  // 새로고침 시 coordination 탭이고 roomId가 있으면 복원
  if (savedTab === 'coordination' && currentRoomId) {
    setTimeout(() => {
      console.log('🔄 페이지 새로고침 - 채팅방 복원:', currentRoomId);
      window.dispatchEvent(new CustomEvent('restoreRoom', {
        detail: { roomId: currentRoomId }
      }));
    }, 100);
  }
}, []); // 최초 마운트 시 한 번만
```

**동작:**
1. 채팅방 입장 → localStorage에 저장
2. F5 새로고침
3. 앱 로드 → localStorage 확인
4. currentRoomId 발견 → 'restoreRoom' 이벤트 발송
5. CoordinationTab이 이벤트 수신 → 채팅방 복원 ✅

**변경 파일:** `client/src/SchedulingSystem.js` (Line 208-223)

---

### 🆕 추가 기능 5: SuggestionModal 장소 항상 표시

**수정 내용:**
- 이전: 장소가 있을 때만 표시
- 수정: 항상 표시 (없으면 "미정")

**변경 파일:** `SuggestionModal.js` (Line 332-346)

---

## 남은 작업

### 🔧 개선 필요 사항

#### 1. 기존 일정 참석자 수 업데이트
**문제:** 이번 수정 이전에 만들어진 일정은 participants 필드가 없음

**해결 방안 A: DB 마이그레이션 (권장)**
```javascript
// 스크립트 예시
const suggestions = await ScheduleSuggestion.find({ /* 모든 일정 */ });

for (const suggestion of suggestions) {
  const acceptedCount = suggestion.memberResponses.filter(
    r => r.status === 'accepted'
  ).length;

  // 각 멤버의 personalTimes 업데이트
  for (const response of suggestion.memberResponses) {
    if (response.status === 'accepted' && response.personalTimeId) {
      const user = await User.findById(response.user);
      const pt = user.personalTimes.id(response.personalTimeId);
      if (pt && !pt.participants) {
        pt.participants = acceptedCount;
        pt.suggestionId = suggestion._id.toString();
        await user.save();
      }
    }
  }
}
```

**해결 방안 B: 실시간 조회**
```javascript
// MobileScheduleView.js
if (pt.suggestionId && !pt.participants) {
  // suggestionId로 ScheduleSuggestion 조회
  // memberResponses에서 accepted 카운트
  // 표시
}
```

**상태:** ⏳ 미구현

---

#### 2. 참석자 변경 시 자동 동기화
**문제:** 참석자가 추가로 수락하면 다른 사람의 personalTimes는 업데이트 안 됨

**예시:**
- A가 일정 생성 → A의 personalTimes: participants = 1
- B가 수락 → B의 personalTimes: participants = 2
- **하지만 A의 personalTimes는 여전히 1**

**해결 방안:**
```javascript
// aiScheduleService.js - handleAutoResponse 수정
// 사용자가 수락할 때
userResponse.status = 'accepted';
await suggestion.save();

// 🆕 이미 수락한 모든 사용자의 personalTimes 업데이트
const newAcceptedCount = suggestion.memberResponses.filter(
  r => r.status === 'accepted'
).length;

for (const response of suggestion.memberResponses) {
  if (response.status === 'accepted' && response.personalTimeId) {
    const user = await User.findById(response.user);
    const pt = user.personalTimes.id(response.personalTimeId);
    if (pt) {
      pt.participants = newAcceptedCount;
      await user.save();
    }
  }
}
```

**상태:** ⏳ 미구현

---

#### 3. 장소 없을 때 제안자 주소 표시
**현재 동작:** 장소 없으면 "미정"으로 표시

**개선 방안:**
```javascript
// 우선순위
const displayLocation =
  suggestion.location ||           // AI가 감지한 장소
  suggestedBy?.address ||          // 제안자 집주소
  "미정";                          // 둘 다 없음
```

**변경 필요 파일:**
- `SuggestionModal.js`
- `ScheduleDetailModal.js`

**상태:** ⏳ 미구현

---

#### 4. Kakao Maps 전환 (선택사항)
**이유:** Google Maps는 한국 대중교통 데이터가 제한적

**장점:**
- Kakao Maps는 한국 지역 데이터 정확
- 대중교통 경로가 더 정확
- 장소 검색이 더 잘됨

**단점:**
- API 키 새로 발급 필요
- 코드 전면 수정 필요

**상태:** ⏳ 미구현 (우선순위 낮음)

---

## 파일 변경 이력

### 서버 (Backend)

#### 1. `server/services/aiScheduleService.js`
**변경 내용:**
- Line 370-396: `handleAutoResponse` 함수 수정
- `userResponse.status` 먼저 업데이트 후 participants 계산
- `newPersonalTime`에 `participants`와 `suggestionId` 추가

**변경 사유:** 참석자 수를 정확히 저장하기 위함

---

#### 2. `server/prompts/scheduleAnalysis.js`
**변경 내용:**
- Line 157-195: 예시 2-1, 2-2 추가 (장소 포함 케이스)
- Line 1354-1405: 장소 필드 처리 규칙 추가
  - 감지 기준
  - 추출 예시
  - extend에서 장소 변경

**변경 사유:** AI가 채팅에서 장소를 자동으로 감지하도록

---

### 클라이언트 (Frontend)

#### 3. `client/src/components/mobile/MobileScheduleView.js`
**변경 내용:**
- Line 12-17: `EventCard`에 `isConfirmed` 조건 추가
- Line 158, 182, 202: `participants: 1` → `participants: pt.participants || 1`
- Line 213: `suggestionId: pt.suggestionId || null` 추가

**변경 사유:**
- 실제 참석자 수 표시
- 확정 일정 스타일 적용

---

#### 4. `client/src/components/mobile/MobileScheduleView.css`
**변경 내용:**
- Line 356-363: `.event-card.confirmed` CSS 클래스 추가

**변경 사유:** 확정 일정(2명 이상)에 초록색 배경 적용

---

#### 5. `client/src/components/tabs/DashboardTab.js`
**변경 내용:**
- Line 70-74: `EventCard`에 `isConfirmed` 조건 추가
- `bg-green-50 border-green-300` vs `bg-white border-gray-200`

**변경 사유:** 데스크톱 버전도 확정 일정에 초록색 배경 적용

---

#### 6. `client/src/components/chat/SuggestionModal.js`
**변경 내용:**
- Line 4: `ScheduleDetailModal` import 추가
- Line 37-38: `userProfile`, `selectedSuggestion` state 추가
- Line 56-69: `fetchUserProfile` 함수 추가
- Line 305-320: 일정 카드를 클릭 가능하게 수정
- Line 332-346: 장소 항상 표시 (없으면 "미정")
- Line 끝: `ScheduleDetailModal` 컴포넌트 추가

**변경 사유:**
- 일정 클릭 시 상세 모달 표시
- 장소 항상 표시

---

#### 7. `client/src/components/chat/ScheduleDetailModal.js` ⭐ **신규 파일**
**내용:**
- 일정 상세 모달 컴포넌트
- Google Maps 통합
- 대중교통 경로 표시
- 모바일 반응형
- 배경 클릭으로 닫기

**라인 수:** ~320줄

**주요 기능:**
- `initMap()`: 지도 초기화 및 마커 표시
- `fetchDirections()`: 대중교통 경로 조회
- `handleBackdropClick()`: 배경 클릭 처리
- `formatDuration()`, `formatDistance()`: 시간/거리 포맷팅

---

#### 8. `client/src/SchedulingSystem.js`
**변경 내용:**
- Line 208-223: 새로고침 시 채팅방 복원 로직 추가

**변경 사유:** F5 새로고침 시 현재 채팅방 유지

---

## 테스트 가이드

### 🧪 테스트 시나리오 1: 새 일정 생성 + 장소 감지

**준비:**
1. 서버 실행 중
2. 클라이언트 새로고침
3. 채팅방 입장

**테스트 단계:**
```
1. 메시지 입력: "내일 의정부 CGV에서 영화 보자"
   → AI 분석 대기

2. 다른 사용자로 응답: "ㅇㅋ"
   → 일정 생성 확인

3. 또 다른 사용자: "나도 감"
   → 참석자 추가 확인

4. 일정 관리 모달 열기
   → 장소: "의정부 CGV" 표시 확인 ✅
   → 참석자: 3명 표시 확인 ✅

5. 홈화면 → 일정 탭
   → 초록색 배경 확인 ✅
   → 참석자 3명 확인 ✅
```

**예상 결과:**
- ✅ 장소: "의정부 CGV"
- ✅ 참석자: 3명
- ✅ 초록색 배경

---

### 🧪 테스트 시나리오 2: 일정 상세 모달

**준비:**
1. 프로필에 집주소 입력 (예: "서울특별시 강남구 테헤란로 123")
2. 장소가 있는 일정 생성 완료

**테스트 단계:**
```
1. 일정 관리 모달 열기

2. 일정 카드의 제목 클릭
   → 상세 모달 열림 확인 ✅

3. 지도 확인
   → Google Maps 표시 확인 ✅
   → 마커 표시 확인 ✅

4. 대중교통 경로 확인
   → 소요 시간 표시 확인 ✅
   → 거리 표시 확인 ✅
   → 단계별 경로 확인 ✅
   → 버스/지하철 노선 정보 확인 ✅

5. 모달 바깥 클릭
   → 모달 닫힘 확인 ✅

6. 모바일 뷰 테스트 (F12 → 모바일 모드)
   → 화면에 맞게 표시 확인 ✅
```

**예상 결과:**
- ✅ 지도 표시됨
- ✅ 대중교통 경로 표시됨
- ✅ 배경 클릭 시 닫힘
- ✅ 모바일에서 잘 보임

---

### 🧪 테스트 시나리오 3: 채팅방 새로고침

**테스트 단계:**
```
1. 일정 맞추기 탭 이동

2. 아무 채팅방 클릭해서 입장
   → 채팅방 열림 확인

3. F5 (새로고침)
   → 잠시 로딩...

4. 결과 확인
   → 동일한 채팅방 열려있음 ✅
   → 콘솔에 "🔄 페이지 새로고침 - 채팅방 복원" 로그 확인 ✅
```

**예상 결과:**
- ✅ 채팅방 유지됨
- ✅ 홈화면으로 안 가고 그대로 유지

---

### 🧪 테스트 시나리오 4: 장소 변경 (extend)

**테스트 단계:**
```
1. 장소 없는 일정 생성
   메시지: "내일 7시 밥먹자"
   → 일정 생성 (location: "")

2. 장소 제안
   메시지: "그냥 의정부 시내에서 만나는 게 어때?"
   → 다른 사용자: "ㅇㅋ"

3. 일정 관리 모달에서 확인
   → 장소: "의정부 시내" 표시 확인 ✅
```

**예상 결과:**
- ✅ AI가 extend action으로 장소 추가
- ✅ location 필드 업데이트됨

---

## 📊 성과 요약

### ✅ 완료된 기능 (7개)
1. 참석자 수 정확히 표시
2. AI 장소 자동 감지
3. 초록색 배경 디자인 통일
4. 일정 상세 모달 (지도 + 대중교통)
5. 모바일 반응형 모달
6. 배경 클릭으로 모달 닫기
7. 채팅방 새로고침 시 페이지 유지

### ⏳ 남은 작업 (4개)
1. 기존 일정 참석자 수 업데이트 (DB 마이그레이션)
2. 참석자 변경 시 자동 동기화
3. 장소 없을 때 제안자 주소 표시
4. Kakao Maps 전환 (선택사항)

### 🐛 수정된 버그 (2개)
1. participants 하드코딩
2. nextEvent.participants 참조 오류

### 📝 수정된 파일 (8개)
- 서버: 2개
- 클라이언트: 6개 (+ 신규 1개)

---

## 💡 다음 주에 기억할 것

### "아 맞다 그랬지!" 체크리스트

#### ✅ 완료된 것
- [x] 참석자 수는 **새 일정부터** 정확히 표시됨
- [x] 장소 감지는 **AI 프롬프트**에 추가됨
- [x] 초록색은 **participants >= 2**일 때만
- [x] 상세 모달은 **일정 카드 클릭**하면 열림
- [x] F5 누르면 **채팅방 유지됨**

#### ⚠️ 주의할 것
- **기존 일정**: participants 필드 없음 → 1로 표시됨
- **동기화 안 됨**: A가 수락 후 B가 수락해도 A의 화면은 업데이트 안 됨
- **Google Maps**: 한국 대중교통 정보가 제한적일 수 있음

#### 🔧 다음에 할 것
1. DB 마이그레이션 스크립트 작성
2. 참석자 변경 시 실시간 동기화
3. 제안자 주소 우선순위 적용

---

**작업 종료일:** 2026-01-30
**총 작업 시간:** 약 4시간
**커밋 메시지 제안:** "feat: 홈화면 일정 통합 개선 - 참석자 수, 장소 감지, 디자인, 상세 모달"
