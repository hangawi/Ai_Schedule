# AI 일정 조율 시스템 - 프로젝트 개발 가이드

**최종 업데이트:** 2026-02-05
**상태:** 프로덕션 운영 중

---

## 1. 프로젝트 개요

### 목표
그룹 채팅을 통해 자연스럽게 일정을 조율하고, AI가 합의된 일정을 자동으로 감지하여 제안하는 시스템

### 핵심 설계 철학: LLM 중심 (하드코딩 최소화)
- **날짜 계산**: LLM이 "금요일", "다음주 월요일" 등을 직접 계산
- **시간 해석**: LLM이 맥락으로 "6시 밥" → 18:00 판단
- **합의 감지**: LLM이 대화 흐름으로 자연스럽게 판단
- **장소 감지**: LLM이 "신라호텔 오후2시" → location: "신라호텔" 추출
- **프롬프트**: 한국어로 작성하여 문화적 맥락 전달 강화

---

## 2. 아키텍처 원칙 (2026-02-05 통합)

### 구글 사용자 = 일반 사용자
- **모든 사용자는 DB를 주 데이터 소스로 사용**
- 구글 캘린더는 보조 기능(추가 표시)으로만 유지
- `isGoogleUser` 분기 없이 동일한 코드 경로 사용
- `tabType`은 항상 `'local'`, `context`는 `'profile'`로 통일

### 채팅 → 장소 자동 감지
- LLM 프롬프트에 `location` 필드 포함
- Event 모델에 `location` 필드 추가 (String, default: '')
- 채팅으로 일정 추가 시 장소가 자동 저장됨

### 하단 네비게이션 통합
- **마이크**: 달력 페이지에서 바로 음성 인식, 다른 페이지에서는 달력으로 이동 후 시작
- **카메라**: 달력 페이지에서 바로 촬영 → OCR, 다른 페이지에서는 달력으로 이동 후 촬영

---

## 3. 주요 파일 구조

### 프론트엔드 (client/src/)

| 파일 | 역할 |
|------|------|
| `SchedulingSystem.js` | PC 메인 시스템 (탭 관리, 전역 상태) |
| `components/mobile/MobileCalendarView.js` | 모바일 달력 (FullCalendar + 채팅 + 음성 + 카메라) |
| `components/mobile/MobileScheduleView.js` | 모바일 일정 리스트 |
| `components/mobile/BottomNavigation.js` | 하단 네비 (새로고침/카메라/채팅/마이크) |
| `hooks/useChat/enhanced.js` | 강화된 챗봇 훅 |
| `hooks/useChat/handlers/enhancedIntentHandlers.js` | AI 인텐트 라우팅 |
| `hooks/useChat/hooks/useEventAdd.js` | 단일 일정 추가 |
| `hooks/useChat/hooks/useRecurringEventAdd.js` | 반복 일정 추가 |
| `hooks/useChat/hooks/useRangeDeletion.js` | 범위 삭제 |
| `hooks/useChat/prompts/unifiedPrompt.js` | AI 프롬프트 (location 포함) |
| `hooks/useChat/utils/apiRequestUtils.js` | API 요청 데이터 생성 |
| `hooks/useChat/utils/eventFilterUtils.js` | 이벤트 필터링 유틸 |

### 백엔드 (server/)

| 파일 | 역할 |
|------|------|
| `models/event.js` | Event 스키마 (location 필드 포함) |
| `controllers/eventController.js` | 일정 CRUD |
| `controllers/ocrController.js` | Gemini 2.0 Flash 기반 OCR |
| `services/aiScheduleService.js` | 조율방 AI 분석 |
| `controllers/authController.js` | 인증 (Google OAuth 포함) |

---

## 4. 이벤트 색상 구분

| 종류 | 색상 | 코드 |
|------|------|------|
| 선호시간 (가능) | 파란색 | `#60a5fa` |
| 개인시간 | 빨간색 | `#ef4444` |
| 예외 스케줄 | 보라색 | `#a855f7` |
| 구글 캘린더 일정 | 초록색 | `#22c55e` |
| 조율 확정 일정 | 파란색 | `#3b82f6` |

---

## 5. AI 챗봇 인텐트

| 인텐트 | 설명 |
|--------|------|
| `add_preferred_time` | 선호시간 추가 (priority 1-3) |
| `add_personal_time` | 개인시간(불가능한 시간) 추가 |
| `add_event` | 일반 일정 추가 (location 포함) |
| `add_recurring_event` | 반복 일정 추가 |
| `add_recurring_preferred_time` | 반복 선호시간 추가 |
| `delete_event` | 일정 삭제 |
| `delete_range` | 범위 삭제 |
| `edit_event` | 일정 수정 |

---

## 6. Google Calendar 연동

### OAuth 흐름
1. `GET /api/auth/google/calendar-consent` → OAuth URL 생성
2. `GET /api/auth/google/calendar-callback` → token 교환, refreshToken 저장
3. 클라이언트에서 `loginMethod === 'google'` 확인

### 현재 동작 방식 (2026-02-05 이후)
- 구글 사용자도 DB가 주 데이터 소스
- 구글 캘린더 이벤트는 달력에 보조로 표시 (초록색)
- 채팅으로 일정 추가 시 로컬 DB에 저장
- 편집/선호시간/개인시간 모두 일반 사용자와 동일하게 동작

---

## 7. OCR 시간표 인식

### 흐름
1. 카메라 버튼 클릭 → 사진 촬영
2. `/api/ocr/analyze-schedule`로 이미지 전송
3. Gemini 2.0 Flash가 시간표 분석
4. 추출된 일정을 자동으로 `/api/events`에 등록

### 관련 파일
- `server/controllers/ocrController.js`
- `client/src/components/mobile/MobileCalendarView.js` (handleCameraCapture)

---

## 8. 음성 인식

### 흐름
1. 마이크 버튼 클릭 → Web Speech API (ko-KR) 시작
2. 음성 → 텍스트 변환
3. 변환된 텍스트를 채팅 메시지로 전송
4. AI가 인텐트 파싱 → 일정 추가/삭제/수정

### 관련 파일
- `client/src/hooks/useIntegratedVoiceSystem.js`
- `client/src/hooks/useVoiceCommands.js`
- `MobileCalendarView.js` (handleStartVoiceRecognition)

---

## 9. 테스트 체크리스트

### 사용자 통합
- [ ] 일반 사용자: 기존과 동일 동작
- [ ] 구글 사용자: 달력에서 편집 버튼 보임
- [ ] 구글 사용자: 선호시간/개인시간 설정 가능
- [ ] 구글 사용자: 채팅으로 일정 추가 → DB 저장
- [ ] 구글 사용자: 조율방 자동배정 사용 가능

### 장소 감지
- [ ] "신라호텔 오후2시" → 장소: 신라호텔
- [ ] "내일 3시 회의" → 장소: 없음(빈값)

### 음성 인식
- [ ] 달력 페이지: 마이크 → 바로 음성 인식
- [ ] 다른 페이지: 마이크 → 달력 이동 + 음성 시작

### 카메라 OCR
- [ ] 달력 페이지: 카메라 → 촬영
- [ ] 다른 페이지: 카메라 → 달력 이동 + 촬영
- [ ] 시간표 사진 → OCR → 일정 자동 등록

---

## 10. 변경 이력

### 2026-02-05: 프로젝트 통합 개선
- **Phase 1**: 구글 사용자 = 일반 사용자 (isGoogleUser 분기 12곳 제거)
- **Phase 2**: 채팅 장소 자동 감지 (location 필드 추가)
- **Phase 3**: 마이크 = 음성 → 채팅 (BottomNavigation 연결)
- **Phase 4**: 카메라 = 시간표 OCR (촬영 → 분석 → 자동 등록)
- **Phase 5**: 문서 통합 (3개 문서 → 1개로 통합)

### 2026-01-30: 홈화면 일정 통합 개선
- 참석자 수 정확히 표시
- 장소 표시 개선
- 확정 일정 디자인 통일
