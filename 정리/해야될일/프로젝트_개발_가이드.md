# AI 일정 조율 시스템 - 프로젝트 개발 가이드

**최종 업데이트:** 2026-02-09

---

## 1. 프로젝트 개요

### 목표
그룹 채팅을 통해 자연스럽게 일정을 조율하고, AI가 합의된 일정을 자동으로 감지하여 제안하는 시스템

### 핵심 설계 철학: LLM 중심 (하드코딩 최소화)
- **날짜 계산**: LLM이 "금요일", "다음주 월요일" 등을 직접 계산
- **시간 해석**: LLM이 맥락으로 "6시 밥" → 18:00 판단
- **합의 감지**: LLM이 대화 흐름으로 자연스럽게 판단
- **장소 감지**: LLM이 "신라호텔 오후2시" → location: "신라호텔" 추출
- **프롬프트**: 한국어로 작성하여 문화적 맥락 전달 강화

### 아키텍처 원칙
- **모든 사용자는 DB를 주 데이터 소스로 사용** (구글 캘린더는 보조 표시용 초록색)
- `isGoogleUser` 분기 없이 동일한 코드 경로 사용
- `tabType`은 항상 `'local'`, `context`는 `'profile'`로 통일

---

## 2. 주요 파일 구조

### 프론트엔드 (client/src/)

| 파일 | 역할 |
|------|------|
| `SchedulingSystem.js` | PC 메인 시스템 (탭 관리, 전역 상태) |
| `components/mobile/MobileCalendarView.js` | 모바일 달력 (FullCalendar + 채팅 + 음성 + 카메라) |
| `components/mobile/MobileGroupsView.js` | 모바일 그룹(조율방) 뷰 |
| `components/mobile/BottomNavigation.js` | 하단 네비 (새로고침/카메라/채팅/마이크) |
| `components/coordination/ConversationalRoomView.js` | 대화형 조율방 뷰 |
| `components/tabs/CoordinationTab/index.js` | 조율방 메인 컨테이너 |
| `components/modals/RoomCreationModal.js` | 조율방 생성 모달 |
| `components/modals/OptimalTimeModal.js` | 최적 시간 후보 모달 |
| `components/modals/CustomAlertModal.js` | 커스텀 알림/확인 모달 (Portal 사용) |
| `components/chat/SuggestionModal.js` | 일정 제안 모달 |
| `components/chat/GroupChat.js` | 그룹 채팅 |
| `hooks/useChat/enhanced.js` | 강화된 챗봇 훅 |
| `hooks/useChat/prompts/unifiedPrompt.js` | AI 프롬프트 (location 포함) |

### 백엔드 (server/)

| 파일 | 역할 |
|------|------|
| `models/event.js` | Event 스키마 (location 필드 포함) |
| `models/ScheduleSuggestion.js` | 일정 제안 스키마 (optimalSource 필드 포함) |
| `controllers/eventController.js` | 일정 CRUD |
| `controllers/coordinationController.js` | 조율방 컨트롤러 (최적시간 찾기 포함) |
| `controllers/coordinationMemberController.js` | 조율방 멤버 관리 (나가기/강퇴) |
| `controllers/chatController.js` | 채팅 컨트롤러 (제안 수락/거절) |
| `services/aiScheduleService.js` | 조율방 AI 분석 (자동 참석/불참) |
| `services/preferenceService.js` | 선호시간 충돌 체크 |
| `controllers/ocrController.js` | Gemini 2.0 Flash 기반 OCR |

---

## 3. 이벤트 색상 구분

| 종류 | 색상 | 코드 |
|------|------|------|
| 선호시간 (가능) | 파란색 | `#60a5fa` |
| 개인시간 | 빨간색 | `#ef4444` |
| 예외 스케줄 | 보라색 | `#a855f7` |
| 구글 캘린더 일정 | 초록색 | `#22c55e` |
| 조율 확정 일정 | 파란색 | `#3b82f6` |

---

## 4. 완료된 작업

### 2026-02-05
1. **isGoogleUser 분기 제거** (~12개 파일) - 모든 사용자 DB 기반
2. **채팅 장소 자동 감지** - unifiedPrompt.js에 location 추출 규칙 추가
3. **마이크 버튼 음성인식 연결** - `?voice=start` query param
4. **카메라 버튼 OCR 연결** - Gemini 2.0 Flash, `?camera=open` query param
5. **문서 통합** - 3개 → 1개
6. **모바일 헤더 정리** - 6개 버튼 → 2개 (프로필, 로그아웃)

### 2026-02-06
1. **채팅 참여자 추출 및 저장** - "형우랑 창정이랑 밥약속" → externalParticipants
2. **참여자 뱃지 디자인 통일** - 파란색 뱃지
3. **편집 모드 개선** - 삭제 버튼 편집 모드에서만, 취소 시 상태 복원
4. **일반 사용자 location 문제 해결**
5. **"다다음주" 날짜 계산 규칙 추가**
6. **구글 사용자 중복 표시 해결** - personalTimes 저장 스킵, Google Calendar만 저장

### 2026-02-09
1. **조율방 생성 모달 모바일 최적화** - 중앙 배치, 스크롤 가능, 85% 너비
2. **최적 시간표 로직 개선** - optimalSource 필드 추가, 선호시간 없으면 차단, 중복 방지, 삭제 시 복원
3. **일정 삭제 vs 불참 분기 처리** - 참석자 0명이면 삭제, 1명 이상이면 불참 (3개 코드 경로 모두 수정)
4. **조율방 모드 순서 변경** - 대화형 모드 디폴트 + 왼쪽, 표준 모드일 때만 시간표 설정 표시
5. **방 생성 모달 버그 수정** - CustomAlertModal prop 수정(show→isOpen), 최소 인원 1명, 여백 추가
6. **방 나가기 기능 수정** - 혼자 남은 방장이 나가면 방 삭제, window.confirm → CustomAlertModal 변환
7. **CustomAlertModal Portal 적용** - ReactDOM.createPortal로 document.body에 렌더링, #root z-index 설정
8. **자동 일정 충돌 감지** - 제안 시 참여자 기존 일정과 충돌 체크 → 자동 불참 처리

---

## 5. 미완료 작업 (TODO)

### 높은 우선순위

#### ~~5-1. 일반 사용자 장소가 새로고침 시 집주소로 변경됨~~ ✅ 해결됨
#### ~~5-2. 구글 사용자 채팅 제안 일정 달력에서 삭제 불가~~ ✅ 해결됨

### 중간 우선순위

#### 5-3. extend 시 다른 일정을 "같은 값"으로 오판
- **현상**: 2월 10일 일정이 22:00인 상태에서 2월 9일 일정을 22:00으로 변경하려 하면 "이미 같은 값" 스킵
- **원인**: AI가 날짜를 고려하지 않고 시간만 비교
- **수정 파일**: `server/services/aiScheduleService.js`, `server/prompts/scheduleAnalysis.js`

#### 5-4. 날짜 계산 오류
- **현상**: "다음 주 월요일"이 1일 밀려서 계산됨
- **수정 파일**: `server/prompts/scheduleAnalysis.js`

### 낮은 우선순위

#### 5-5. 시간 해석 모호성
- **현상**: "10시까지 놀자" → 오전 10시로 해석 (맥락상 22:00이어야 함)
- **수정 파일**: `server/prompts/scheduleAnalysis.js`

#### 5-6. 나머지 window.confirm → CustomAlertModal 변환
- 현재 조율방 나가기만 완료, 다른 곳들 미완료:
  - `AdminRoomManagement.js` (방 삭제, 로그 삭제)
  - `AdminUserManagement.js` (회원 삭제, 승급, 강등)
  - `TimetableGrid.js` (시간 삭제)
  - `SuggestionModal.js` (제안 삭제)
  - `EventDetailModal.js` (일정 삭제)
  - `MobileCalendarView.js` (모두 삭제)
  - `MobileScheduleEdit.js` (모든 일정 삭제)
  - `MemberStatsModal.js` (이월시간 삭제)
  - `MemberLogsModal.js` (로그 삭제)
  - `RoomManagementModal.js` (로그 초기화, 멤버 제거, 방 나가기, 방 삭제)

---

## 6. 기술 참고

### AI 챗봇 인텐트
| 인텐트 | 설명 |
|--------|------|
| `add_preferred_time` | 선호시간 추가 (priority 1-3) |
| `add_personal_time` | 개인시간(불가능한 시간) 추가 |
| `add_event` | 일반 일정 추가 (location 포함) |
| `add_recurring_event` | 반복 일정 추가 |
| `delete_event` | 일정 삭제 |
| `delete_range` | 범위 삭제 |
| `edit_event` | 일정 수정 |

### Google Calendar 연동
- OAuth: `/api/auth/google/calendar-consent` → `/api/auth/google/calendar-callback`
- 구글 사용자도 DB가 주 데이터 소스, 구글 캘린더는 보조 표시 (초록색)

### OCR 시간표 인식
- 카메라 → `/api/ocr/analyze-schedule` → Gemini 2.0 Flash 분석 → 일정 자동 등록

### 음성 인식
- 마이크 → Web Speech API (ko-KR) → 텍스트 → 채팅 메시지 → AI 인텐트 파싱

### 자동 일정 충돌 감지
- 채팅에서 일정 제안 시 참여자별 기존 일정(personalTimes + events) 확인
- 충돌 있으면 자동 불참 처리 + 시스템 메시지
- "나도 갈게" 등 참석 의사 표현 시 수동 참석 변경

### Cross-Page Feature Pattern (하단 네비게이션)
- `?voice=start` → 음성 인식
- `?camera=open` → 카메라/OCR
- `?chat=open` → 채팅 열기

### CustomAlertModal 사용법
- `ReactDOM.createPortal`로 `document.body`에 렌더링 (z-index: 9999)
- Props: `isOpen`, `onClose`, `onConfirm`, `title`, `message`, `type`(info/success/warning/error), `showCancel`, `confirmText`, `cancelText`
