================================================================================
🔥 3가지 핵심 문제 해결 계획
================================================================================
작성일: 2025-12-31
상태: 진행 중
우선순위: 높음

================================================================================
📋 문제 요약
================================================================================

[문제 1] 실시간 업데이트 미작동
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📌 증상:
   - 방장이 "대중교통 보기" 적용
   - 조원 계정에서 시간표가 모두 "배정불가"로 표시됨
   - 방을 나갔다가 다시 들어와도 동일
   - 새로고침을 해야 제대로 보임

🎯 예상 원인:
   - Socket.io 실시간 통신 문제
   - 이벤트 리스너 미등록 또는 잘못된 이벤트명
   - 클라이언트에서 받은 데이터를 state에 반영하지 않음

📁 관련 파일:
   - client/src/components/tabs/CoordinationTab.js (소켓 이벤트 처리)
   - server/controllers/coordinationSchedulingController.js (이벤트 발신)
   - client/src/contexts/SocketContext.js (소켓 관리)


[문제 2] 이동시간 고려한 빗금 처리 강화
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📌 증상:
   상황: A(월 9-11), B(월 13:10-14:10), C(수 10:20-11:20)
   금지시간: 12-13시

   Case 1: C를 A 뒤에 배치하려는 경우
   - A 끝: 11시
   - C가 11시에 시작하면 → 이동시간 때문에 금지시간(12-13) 침범
   - 현재: 11-11:10 빈시간으로 표시
   - 원하는 것: 11-11:10을 배정불가(빗금)로 표시

   Case 2: C를 B 뒤에 배치하려는 경우
   - B 끝: 14:10
   - B→C 이동시간: 30분
   - C가 14:10에 시작하면 → 이동시간 부족으로 불가능
   - 원하는 것: 14:10-14:40을 배정불가(빗금)로 표시

🎯 목표:
   - 조원 계정 로그인 시, 다른 사람 수업 뒤의 시간을 자동 분석
   - 이동시간을 고려해서 실제 배치 불가능한 시간을 빗금으로 표시
   - 사용자는 이동시간을 몰라도 가능한 시간만 선택 가능

📝 필요한 로직:
   1. 다른 사람의 수업 종료 시간 파악
   2. 해당 위치 → 조원의 수업 위치까지 이동시간 계산
   3. 끝나는 시간 + 이동시간 이전 슬롯들을 빗금 처리
   4. 금지시간 고려 (배치하면 금지시간 침범하는 경우도 빗금)

📁 관련 파일:
   - client/src/components/timetable/WeekView.js (빗금 생성 로직)
   - client/src/services/travelScheduleCalculator.js (이동시간 계산)


[문제 3] 거리 기반 재배정 문제
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📌 증상:
   초기 상태: 월요일에 A, B, C 모두 배치됨
   대중교통 적용 후: C가 수요일로 이동

   상황:
   - A: 월 9-11시
   - B: 월 13:10-14:10
   - C: 1시간 수업 (원래는 월요일에 있었음)
   - 거리: 방장→A, A→B(10분), B→C(20분)

   예상:
   - C는 1시간 수업이므로, 이동시간 포함해도 월요일에 배치 가능
   - 14:10 + 20분(이동) = 14:30-15:30에 배치되어야 함

   실제:
   - C가 수요일에 그대로 남음

🎯 원인:
   - 파일: client/src/services/travelScheduleCalculator.js
   - 함수: sortSlotsByDistance()
   - 로직: 날짜별로 그룹화 → 각 날짜 내에서만 거리 순 정렬
   - 문제: 다른 날짜에 있는 슬롯을 최적의 날짜로 이동시키지 못함

💡 해결 방법:
   옵션 1) sortSlotsByDistance 전면 수정
      - 날짜 구분 없이 전체 슬롯을 거리 순서대로 정렬
      - 각 슬롯을 순차적으로 배치하면서 최적의 날짜/시간 찾기
      - 선호시간, 금지시간 고려하여 재배정

   옵션 2) recalculateScheduleWithTravel 수정
      - 거리 순서대로 정렬된 슬롯 처리 시
      - canPlace=false면 현재 날짜뿐 아니라 다른 날짜도 탐색
      - findAvailableSlot을 모든 가능한 날짜에 대해 실행

📁 관련 파일:
   - client/src/services/travelScheduleCalculator.js


================================================================================
🎯 해결 전략 및 작업 순서
================================================================================

우선순위: 문제 3 → 문제 2 → 문제 1
(거리 재배정이 제대로 되어야 빗금 처리도 정확해지고,
 모든 로직이 완성된 후 실시간 업데이트를 추가)


1️⃣ [먼저] 문제 3: 거리 기반 재배정 수정
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   📝 작업 내용:
      1. travelScheduleCalculator.js 분석
      2. sortSlotsByDistance 함수 수정
      3. 날짜 경계를 넘어서 재배정 가능하도록 수정
      4. 선호시간 체크 강화

   🧪 테스트:
      - A(월 9-11), B(월 13:10-14:10), C(1시간)
      - 대중교통 적용 후 C가 월요일 14:30-15:30에 배치되는지 확인

   ⏱️ 예상 소요시간: 1-2시간
   🔥 난이도: ★★★★☆


2️⃣ [다음] 문제 2: 이동시간 고려 빗금 처리 강화
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   📝 작업 내용:
      1. WeekView.js에 새로운 빗금 생성 함수 추가
      2. 다른 사람 수업 종료 시간 + 이동시간 계산
      3. 배치 불가능한 슬롯들을 빗금으로 표시
      4. 금지시간 침범 체크

   🧪 테스트:
      - C 계정 로그인
      - A 뒤 11:00 슬롯이 빗금으로 표시되는지 확인
      - B 뒤 14:10-14:40 슬롯들이 빗금으로 표시되는지 확인

   ⏱️ 예상 소요시간: 2-3시간
   🔥 난이도: ★★★★★


3️⃣ [마지막] 문제 1: 실시간 업데이트 수정
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   📝 작업 내용:
      1. 소켓 이벤트 확인 (서버→클라이언트)
      2. 클라이언트 이벤트 리스너 확인
      3. State 업데이트 로직 추가
      4. 대중교통 적용 시 모든 조원에게 알림

   🧪 테스트:
      - 방장 계정: 대중교통 보기 적용
      - 조원 계정: 새로고침 없이 자동으로 업데이트되는지 확인

   ⏱️ 예상 소요시간: 30분-1시간
   🔥 난이도: ★★★☆☆


================================================================================
📌 참고: 기존 빗금 표시 로직
================================================================================

위치: client/src/components/timetable/WeekView.js

빗금 생성 조건 (기존):
  ✅ 조건 1: 조원이어야 함 (!isRoomOwner)
  ✅ 조건 2: 이동 모드 활성화 (travelMode !== 'normal')
  ✅ 조건 3: 이동 시간 설정됨 (myTravelDuration > 0)
  ✅ 조건 4: 현재 시간에 본인 수업 없음
  ✅ 조건 5: 다른 조원 수업 없음 (!ownerInfo)
  ✅ 조건 6: 이동시간 구간에 방장 일정 있음
  ✅ 조건 7: 현재 시간이 방장의 선호시간임
  ✅ 조건 8: 확정되지 않음 (!isConfirmed)
  ✅ 조건 9: 조원 본인의 선호시간임

빗금 타입:
  - travel_restricted: 이동시간 확보 필요
  - user_non_preferred: 조원 본인 비선호시간
  - non_preferred: 방장 비선호시간
  - other_member: 다른 조원 배치됨
  - exception: 방 예외시간
  - personal: 개인시간

새로 추가할 타입:
  - cannot_place_after: 이동시간 부족으로 배치 불가
  - blocked_by_restriction: 금지시간 침범으로 배치 불가


================================================================================
🧪 전체 테스트 시나리오
================================================================================

[준비]
  1. 방 생성 (방장 계정)
  2. 금지시간 설정: 12-13시
  3. 조원 A, B, C 추가
  4. 위치 정보 입력:
     - 방장: 기본 위치
     - A: 거리 0분
     - B: A→B 10분
     - C: B→C 20분
  5. 수업 시간 입력:
     - A: 2시간
     - B: 1시간
     - C: 1시간

[테스트 1] 거리 기반 재배정
  1. 자동배정 실행 (일반 모드)
  2. 대중교통 모드로 변경
  3. "보기" 클릭
  4. 결과 확인:
     ✅ A: 월 9-11시
     ✅ B: 월 13:10-14:10
     ✅ C: 월 14:30-15:30 (수요일 아님!)

[테스트 2] 빗금 처리
  1. C 계정으로 로그인
  2. 시간표 확인:
     ✅ 11:00-11:XX: 빗금 (A 뒤 배치 불가)
     ✅ 14:10-14:40: 빗금 (B 뒤 이동시간 부족)
     ✅ 나머지 가능한 시간: 빈시간
  3. 챗봇으로 "수업 시간 변경" 요청
  4. 빗금이 아닌 시간만 선택 가능

[테스트 3] 실시간 업데이트
  1. 방장 계정: 대중교통 "적용" 클릭
  2. 조원 계정 (새로고침 없이):
     ✅ 즉시 이동시간 슬롯 표시
     ✅ 빗금 자동으로 사라짐
     ✅ 배정된 시간표 표시

================================================================================
📂 작업 체크리스트
================================================================================

[⬜] 문제 3: 거리 기반 재배정
    [⬜] travelScheduleCalculator.js 코드 분석
    [⬜] sortSlotsByDistance 함수 수정
    [⬜] recalculateScheduleWithTravel 함수 수정
    [⬜] 테스트 실행
    [⬜] 결과 확인
    [⬜] Git commit

[⬜] 문제 2: 이동시간 고려 빗금 처리
    [⬜] WeekView.js 분석
    [⬜] 새로운 빗금 생성 함수 작성
    [⬜] 이동시간 계산 로직 추가
    [⬜] 금지시간 침범 체크 추가
    [⬜] 렌더링 조건 추가
    [⬜] TimeSlot.js 스타일 추가
    [⬜] 테스트 실행
    [⬜] 결과 확인
    [⬜] Git commit

[⬜] 문제 1: 실시간 업데이트
    [⬜] 서버 이벤트 확인
    [⬜] 클라이언트 이벤트 리스너 확인
    [⬜] State 업데이트 로직 추가
    [⬜] 테스트 실행
    [⬜] 결과 확인
    [⬜] Git commit

================================================================================
