# LLM 기반 일정 분석 시스템

## 개요
채팅방에서 대화를 분석하여 일정을 자동으로 생성/수정/취소하는 AI 시스템

## 핵심 파일
- `server/services/aiScheduleService.js` - 메인 분석 로직
- `server/prompts/scheduleAnalysis.js` - LLM 프롬프트

---

## Action 유형

### 1. `new` - 새 일정 생성
**조건:**
- 최소 2명 이상 참여 (제안 + 동의)
- 구체적인 날짜/시간 합의
- 기존 일정과 다른 새로운 약속

**예시:**
```
A: 내일 7시에 밥먹을까?
B: ㅇㅋ
C: 좋아
→ 새 일정 생성
```

### 2. `response` - 기존 일정 응답 (무시)
**조건:**
- 기존 일정에 대한 동의/응답
- 이미 등록된 일정과 같은 내용

**예시:**
```
[일정: 내일 7시 밥약속 - 이미 생성됨]
D: ㅇㅋ 내일 7시 ㄱㄱ
→ 무시 (중복 생성 안 함)
```

### 3. `extend` - 일정 확장/수정
**조건:**
- 기존 일정에 추가 활동 합의
- 시간/장소 변경 합의

**예시:**
```
[일정: 6시 밥약속]
A: 밥 먹고 PC방 ㄱ?
B: ㅇㅋ
→ 기존 일정 수정: "밥약속" → "밥약속 + PC방", endTime 연장
```

### 4. `cancel` - 일정 취소
**조건:**
- 제안자가 취소 의사 표현
- "ㅈㅅ 일생김", "못 갈 것 같아" 등

**취소 로직:**
```
if (제안자 제외 수락자 >= 2명) {
  // 제안자만 불참 처리, 일정은 유지
  // "OOO님이 빠졌습니다. 나머지 인원으로 진행됩니다"
} else {
  // 일정 완전 취소
  // "OOO님이 일정을 취소하였습니다"
}
```

### 5. `none` - 아무것도 안 함
- 아직 합의 안 됨
- 단순 잡담
- 불확실한 상황 ("보고 결정하자")

---

## LLM에 전달되는 정보

### 1. 현재 날짜/시간
```
오늘: 2026-01-28 (수요일)
이번주: 일=2026-01-25, 월=2026-01-26, ...
다음주: 일=2026-02-01, 월=2026-02-02, ...
```

### 2. 기존 일정 목록
```
[일정 1] ID: 507f1f77bcf86cd799439011
- 내용: 밥약속
- 날짜: 2026-01-29 18:00~19:00
- 제안자: 철수
- 수락: 2명 / 대기: 1명
```

### 3. 최근 대화 20개
```
철수: 내일 밥먹자
영희: ㅇㅋ
민수: 좋아
```

---

## 시간 표현 해석 (LLM이 판단)

| 표현 | 맥락 | 해석 |
|------|------|------|
| "6시" | 밥/저녁/술 | 18:00 |
| "6시" | 아침 | 06:00 |
| "2시" | 점심 | 14:00 |
| "내일" | - | 오늘 + 1일 |
| "금요일" | - | 가장 가까운 금요일 |
| "다음주 월요일" | - | 다음 주 월요일 |

---

## 자동 endTime 계산

| 활동 | 기본 시간 |
|------|-----------|
| 회의/미팅/스터디 | 1시간 |
| 밥/식사/카페 | 2시간 |
| 밥 + 활동 (PC방 등) | 3시간 |

---

## 특이사항

1. **중복 생성 방지**: 30초 이내 재분석 방지
2. **거절 내역 체크**: 이전에 거절된 동일 일정은 재제안 안 함
3. **제안자 자동 수락**: 일정 생성 시 제안자는 자동으로 '수락' 상태
4. **Socket 실시간 전송**: 모든 변경사항 즉시 브로드캐스트

---

## 출력 JSON 형식

```json
// 새 일정
{
  "action": "new",
  "data": {
    "summary": "밥약속",
    "date": "2026-01-28",
    "startTime": "18:00",
    "endTime": "19:00",
    "location": ""
  }
}

// 응답 (무시)
{
  "action": "response",
  "targetId": "기존일정ID",
  "reason": "기존 밥약속에 대한 동의"
}

// 확장
{
  "action": "extend",
  "targetId": "기존일정ID",
  "data": {
    "summary": "밥약속 + PC방",
    "endTime": "21:00"
  }
}

// 취소
{
  "action": "cancel",
  "targetId": "기존일정ID",
  "reason": "제안자가 일정 취소 요청"
}

// 아무것도 안 함
{
  "action": "none",
  "reason": "아직 합의 안 됨"
}
```
