# AI 일정 조율 시스템 - 프로젝트 통합 가이드

**최종 업데이트:** 2026-02-10

---

## 1. 프로젝트 개요

### 목표
그룹 채팅을 통해 자연스럽게 일정을 조율하고, AI가 합의된 일정을 자동으로 감지하여 제안하는 시스템

### 핵심 설계 철학: LLM 중심 (하드코딩 최소화)
- **날짜 계산**: LLM이 "금요일", "다음주 월요일" 등을 직접 계산
- **시간 해석**: LLM이 맥락으로 "6시 밥" → 18:00 판단
- **합의 감지**: LLM이 대화 흐름으로 자연스럽게 판단
- **장소 감지**: LLM이 "신라호텔 오후2시" → location: "신라호텔" 추출
- **프롬프트**: 한국어로 작성하여 문화적 맥락 전달 강화

### 아키텍처 원칙
- **모든 사용자는 DB를 주 데이터 소스로 사용** (구글 캘린더는 보조 표시용 초록색)
- `isGoogleUser` 분기 없이 동일한 코드 경로 사용
- `tabType`은 항상 `'local'`, `context`는 `'profile'`로 통일

---

## 2. 주요 파일 구조

### 프론트엔드 (client/src/)

| 파일 | 역할 |
|------|------|
| `SchedulingSystem.js` | PC 메인 시스템 (탭 관리, 전역 상태) |
| `components/mobile/MobileCalendarView.js` | 모바일 달력 (FullCalendar + 채팅 + 음성 + 카메라) |
| `components/mobile/MobileGroupsView.js` | 모바일 그룹(조율방) 뷰 |
| `components/mobile/MobileSettings.js` | 설정 페이지 (구글 계정 연동, 동기화) |
| `components/mobile/BottomNavigation.js` | 하단 네비 (새로고침/카메라/채팅/마이크) |
| `components/coordination/ConversationalRoomView.js` | 대화형 조율방 뷰 |
| `components/tabs/CoordinationTab/index.js` | 조율방 메인 컨테이너 |
| `components/modals/RoomCreationModal.js` | 조율방 생성 모달 |
| `components/modals/OptimalTimeModal.js` | 최적 시간 후보 모달 |
| `components/modals/CustomAlertModal.js` | 커스텀 알림/확인 모달 (Portal 사용) |
| `components/chat/SuggestionModal.js` | 일정 제안 모달 |
| `components/chat/GroupChat.js` | 그룹 채팅 |
| `hooks/useChat/enhanced.js` | 강화된 챗봇 훅 |
| `hooks/useChat/hooks/useEventAdd.js` | 일정 추가 훅 (프로필/이벤트 분기) |
| `hooks/useChat/prompts/unifiedPrompt.js` | AI 프롬프트 (location 포함) |

### 백엔드 (server/)

| 파일 | 역할 |
|------|------|
| `models/event.js` | Event 스키마 (location 필드 포함) |
| `models/ScheduleSuggestion.js` | 일정 제안 스키마 (optimalSource 필드 포함) |
| `controllers/eventController.js` | 일정 CRUD |
| `controllers/calendarController.js` | 구글 캘린더 동기화 (createGoogleCalendarEvent, syncEventsToGoogle) |
| `controllers/coordinationController.js` | 조율방 컨트롤러 (최적시간 찾기 포함) |
| `controllers/coordinationMemberController.js` | 조율방 멤버 관리 (나가기/강퇴) |
| `controllers/chatController.js` | 채팅 컨트롤러 (제안 수락/거절) |
| `controllers/authController.js` | 인증 컨트롤러 (구글 링크 API 포함) |
| `controllers/ocrController.js` | Gemini 2.0 Flash 기반 OCR |
| `services/aiScheduleService.js` | 조율방 AI 분석 (자동 참석/불참) |
| `services/preferenceService.js` | 선호시간 충돌 체크 |

---

## 3. 이벤트 색상 구분

| 종류 | 색상 | 코드 |
|------|------|------|
| 선호시간 (가능) | 파란색 | `#60a5fa` |
| 개인시간 | 빨간색 | `#ef4444` |
| 예외 스케줄 | 보라색 | `#a855f7` |
| 구글 캘린더 일정 | 초록색 | `#22c55e` |
| 조율 확정 일정 | 파란색 | `#3b82f6` |

---

## 4. 기술 참고

### AI 챗봇 인텐트

| 인텐트 | 설명 |
|--------|------|
| `add_preferred_time` | 선호시간 추가 (priority 1-3) |
| `add_personal_time` | 개인시간(불가능한 시간) 추가 |
| `add_event` | 일반 일정 추가 (location 포함) |
| `add_recurring_event` | 반복 일정 추가 |
| `delete_event` | 일정 삭제 |
| `delete_range` | 범위 삭제 |
| `edit_event` | 일정 수정 |

### Google Calendar 연동
- OAuth: `/api/auth/google/calendar-consent` → `/api/auth/google/calendar-callback`
- 구글 사용자도 DB가 주 데이터 소스, 구글 캘린더는 보조 표시 (초록색)
- 앱에서 만든 이벤트는 `extendedProperties.private.source = 'meetagent'` 태그 → 달력에서 중복 필터링

### OCR 시간표 인식
- 카메라 → `/api/ocr/analyze-schedule` → Gemini 2.0 Flash 분석 → 일정 자동 등록

### 음성 인식
- 마이크 → Web Speech API (ko-KR) → 텍스트 → 채팅 메시지 → AI 인텐트 파싱

### 자동 일정 충돌 감지
- 채팅에서 일정 제안 시 참여자별 기존 일정(personalTimes + events) 확인
- 충돌 있으면 자동 불참 처리 + 시스템 메시지
- "나도 갈게" 등 참석 의사 표현 시 수동 참석 변경

### Cross-Page Feature Pattern (하단 네비게이션)
- `?voice=start` → 음성 인식
- `?camera=open` → 카메라/OCR
- `?chat=open` → 채팅 열기

### CustomAlertModal 사용법
- `ReactDOM.createPortal`로 `document.body`에 렌더링 (z-index: 9999)
- Props: `isOpen`, `onClose`, `onConfirm`, `title`, `message`, `type`(info/success/warning/error), `showCancel`, `confirmText`, `cancelText`

### 초록불 (구글 연동 인디케이터)
- 5개 모바일 파일에서 `user?.google?.refreshToken` 유무로 판단
- 대상: MobileHeader, MobileDashboard, MobileGroupsView, MobileScheduleView, MobileCalendarView

---

## 5. 구글 계정 연동 기능 (계획 중)

### 개요
일반(이메일/비밀번호) 로그인 사용자가 설정 페이지에서 구글 계정을 연동할 수 있게 한다.
연동 후에는 구글 로그인으로도 접속 가능하며, 기존 데이터(일정, 선호시간, 조율방 등)가 그대로 유지된다.

### 핵심 원리

기존 데이터는 MongoDB의 User 문서에 저장되어 있고, User는 `firebaseUid`로 식별된다.
Firebase Auth는 하나의 계정에 여러 로그인 방법(이메일, 구글 등)을 **링크**할 수 있다.
따라서 구글 Provider를 기존 Firebase 계정에 링크하면 **firebaseUid가 변하지 않아** 데이터 이전이 필요 없다.

```
[기존]
Firebase 계정 (UID: abc123) ← 이메일/비밀번호 로그인
  → MongoDB User (firebaseUid: abc123) ← 모든 데이터 여기에 저장

[연동 후]
Firebase 계정 (UID: abc123) ← 이메일/비밀번호 OR 구글 로그인 (둘 다 가능)
  → MongoDB User (firebaseUid: abc123) ← 데이터 그대로 유지
  → + google.refreshToken 추가 → 구글 캘린더 연동 가능
```

### 구현 단계

#### 1단계: 설정 페이지 생성
**새 파일:** `client/src/components/mobile/MobileSettings.js`
- 구글 계정 연동 버튼
- 연동 상태 표시 (연동됨/미연동)
- 연동 해제 버튼

#### 2단계: 사이드바에 설정 메뉴 추가
**수정 파일:** 모바일 뷰 4곳의 사이드바
- `client/src/components/mobile/MobileGroupsView.js`
- `client/src/components/mobile/MobileCalendarView.js`
- `client/src/components/mobile/MobileDashboard.js`
- `client/src/components/mobile/MobileScheduleView.js`

```
기존 메뉴:
  🏠 홈으로
  📅 내 일정
  👥 그룹
  📆 달력

추가:
  ⚙️ 설정    ← 맨 아래에 추가
```

#### 3단계: 라우트 추가
**수정 파일:** `client/src/App.js`
```
/mobile/settings → MobileSettings 컴포넌트
```

#### 4단계: 프론트엔드 - 구글 계정 링크
**수정 파일:** `client/src/components/mobile/MobileSettings.js`

```
[구글 계정 연동하기] 버튼 클릭
  → Firebase linkWithPopup(googleProvider) 호출
  → 구글 로그인 팝업 표시
  → 성공 시: 서버에 구글 토큰 저장 요청
  → 실패 시: 에러 메시지 표시
```

Firebase의 `linkWithPopup` API:
- 기존 이메일/비밀번호 계정에 구글 Provider를 추가
- firebaseUid 변경 없음 → 데이터 안전

#### 5단계: 백엔드 - 구글 토큰 저장 API
**수정 파일:** `server/routes/auth.js`, `server/controllers/authController.js`

```
POST /api/auth/link-google
  → 요청: { googleAccessToken, googleIdToken }
  → 서버: Google OAuth로 refreshToken 획득
  → MongoDB: user.google = { id, accessToken, refreshToken } 저장
  → 응답: { success: true, message: '구글 계정 연동 완료' }
```

#### 6단계: 구글 캘린더 동기화 (자동)
연동 완료 후:
- `user.google.refreshToken`이 존재 → 구글 캘린더 이벤트가 달력에 초록색으로 표시
- 기존 코드가 이미 이 동작을 지원함 (refreshToken 유무로 판단)

### 수정 파일 목록

| 파일 | 작업 |
|------|------|
| `client/src/components/mobile/MobileSettings.js` | **신규** - 설정 페이지 |
| `client/src/App.js` | 라우트 추가 `/mobile/settings` |
| `client/src/components/mobile/MobileGroupsView.js` | 사이드바에 설정 메뉴 추가 |
| `client/src/components/mobile/MobileCalendarView.js` | 사이드바에 설정 메뉴 추가 |
| `client/src/components/mobile/MobileDashboard.js` | 사이드바에 설정 메뉴 추가 |
| `client/src/components/mobile/MobileScheduleView.js` | 사이드바에 설정 메뉴 추가 |
| `server/controllers/authController.js` | 구글 링크 API 추가 |
| `server/routes/auth.js` | 라우트 추가 |

### 데이터 흐름

```
[설정 페이지]
  사용자가 "구글 계정 연동하기" 클릭
       ↓
[Firebase Client SDK]
  linkWithPopup(auth.currentUser, googleProvider)
  → 구글 로그인 팝업 → 사용자 승인
       ↓
[프론트엔드]
  구글 credential 획득 (accessToken, idToken)
  → POST /api/auth/link-google { tokens }
       ↓
[백엔드]
  Google OAuth로 refreshToken 교환
  → user.google = { id, accessToken, refreshToken } 저장
  → localStorage에 loginMethod = 'google' 설정을 위한 응답
       ↓
[완료]
  - 구글 로그인 가능
  - 구글 캘린더 초록색 표시
  - 기존 데이터 100% 유지
```

### 주의사항
1. **이미 구글로 가입한 다른 계정이 있는 경우**: Firebase에서 `auth/credential-already-in-use` 에러 발생 → "이미 다른 계정에 연결된 구글 계정입니다" 메시지 표시
2. **연동 해제**: Firebase에서 `unlink('google.com')` + MongoDB에서 `user.google = null` 처리
3. **로그인 인디케이터**: 연동 후 로고 우측 상단 원이 초록색(구글)으로 변경됨

---

## 6. 완료된 작업

### 2026-02-05
1. **isGoogleUser 분기 제거** (~12개 파일) - 모든 사용자 DB 기반
2. **채팅 장소 자동 감지** - unifiedPrompt.js에 location 추출 규칙 추가
3. **마이크 버튼 음성인식 연결** - `?voice=start` query param
4. **카메라 버튼 OCR 연결** - Gemini 2.0 Flash, `?camera=open` query param
5. **문서 통합** - 3개 → 1개
6. **모바일 헤더 정리** - 6개 버튼 → 2개 (프로필, 로그아웃)

### 2026-02-06
1. **채팅 참여자 추출 및 저장** - "형우랑 창정이랑 밥약속" → externalParticipants
2. **참여자 뱃지 디자인 통일** - 파란색 뱃지
3. **편집 모드 개선** - 삭제 버튼 편집 모드에서만, 취소 시 상태 복원
4. **일반 사용자 location 문제 해결**
5. **"다다음주" 날짜 계산 규칙 추가**
6. **구글 사용자 중복 표시 해결** - personalTimes 저장 스킵, Google Calendar만 저장

### 2026-02-09
1. **조율방 생성 모달 모바일 최적화** - 중앙 배치, 스크롤 가능, 85% 너비
2. **최적 시간표 로직 개선** - optimalSource 필드 추가, 선호시간 없으면 차단, 중복 방지, 삭제 시 복원
3. **일정 삭제 vs 불참 분기 처리** - 참석자 0명이면 삭제, 1명 이상이면 불참 (3개 코드 경로 모두 수정)
4. **조율방 모드 순서 변경** - 대화형 모드 디폴트 + 왼쪽, 표준 모드일 때만 시간표 설정 표시
5. **방 생성 모달 버그 수정** - CustomAlertModal prop 수정(show→isOpen), 최소 인원 1명, 여백 추가
6. **방 나가기 기능 수정** - 혼자 남은 방장이 나가면 방 삭제, window.confirm → CustomAlertModal 변환
7. **CustomAlertModal Portal 적용** - ReactDOM.createPortal로 document.body에 렌더링, #root z-index 설정
8. **자동 일정 충돌 감지** - 제안 시 참여자 기존 일정과 충돌 체크 → 자동 불참 처리
9. **구글 연동 관련 수정** (코드 적용 완료, 실사용 테스트 필요):
   - 빨간+파란 중복 표시 방지: `calendarController.js`에 `source = 'meetagent'` 태그, `MobileCalendarView.js`에서 필터링
   - 상단 초록불: 5개 파일에서 `localStorage loginMethod` → `user?.google?.refreshToken`으로 변경
   - 수동 동기화 버튼: `syncEventsToGoogle`이 personalTimes + Event 컬렉션 둘 다 읽도록 수정, `MobileSettings.js`에 동기화 버튼 + 연동 콜백 시 자동 동기화

### 2026-02-10
1. **구글 로그인 사용자 일정 추가 400 에러 수정** - `useEventAdd.js`에서 기존 personalTimes를 PUT할 때 `isGoogleEvent: true`인 구글 캘린더 항목 필터링 추가

---

## 7. 미완료 작업 (TODO)

### 실사용 테스트 필요 (코드 적용 완료)

#### 7-1. 빨간+파란 중복 표시 검증
- **확인 사항**: 새로 일정 추가했을 때 빨간색만 뜨는지 확인
- **주의**: 기존에 이미 동기화된 이벤트(source 태그 없음)는 여전히 중복될 수 있음 → 구글 캘린더에서 수동 삭제 후 재동기화

#### 7-2. 상단 초록불 검증
- **확인 사항**: 이메일 로그인 → 설정에서 구글 연동 → 초록불로 바뀌는지 확인

#### 7-3. 수동 동기화 버튼 검증
- **확인 사항**: 설정 → 동기화 버튼 클릭 → 기존 일정이 구글 캘린더에 추가되는지 확인

---

### 중간 우선순위

#### 7-4. extend 시 다른 일정을 "같은 값"으로 오판
- **현상**: 2월 10일 일정이 22:00인 상태에서 2월 9일 일정을 22:00으로 변경하려 하면 "이미 같은 값" 스킵
- **원인**: AI가 날짜를 고려하지 않고 시간만 비교
- **수정 파일**: `server/services/aiScheduleService.js`, `server/prompts/scheduleAnalysis.js`

#### 7-5. 날짜 계산 오류
- **현상**: "다음 주 월요일"이 1일 밀려서 계산됨
- **수정 파일**: `server/prompts/scheduleAnalysis.js`

---

### 낮은 우선순위

#### 7-6. 시간 해석 모호성
- **현상**: "10시까지 놀자" → 오전 10시로 해석 (맥락상 22:00이어야 함)
- **수정 파일**: `server/prompts/scheduleAnalysis.js`

#### 7-7. 나머지 window.confirm → CustomAlertModal 변환
- 현재 조율방 나가기만 완료, 다른 곳들 미완료:
  - `AdminRoomManagement.js` (방 삭제, 로그 삭제)
  - `AdminUserManagement.js` (회원 삭제, 승급, 강등)
  - `TimetableGrid.js` (시간 삭제)
  - `SuggestionModal.js` (제안 삭제)
  - `EventDetailModal.js` (일정 삭제)
  - `MobileCalendarView.js` (모두 삭제)
  - `MobileScheduleEdit.js` (모든 일정 삭제)
  - `MemberStatsModal.js` (이월시간 삭제)
  - `MemberLogsModal.js` (로그 삭제)
  - `RoomManagementModal.js` (로그 초기화, 멤버 제거, 방 나가기, 방 삭제)
