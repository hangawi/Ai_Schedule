# 자동 일정 충돌 감지 기능 구현 계획

## 기능 개요

조율방에서 시간을 제안할 때, 참여자들의 기존 일정과 충돌 여부를 자동으로 확인하여:
- 충돌 있는 사람 → 자동 불참 처리 + 채팅방에 알림
- 충돌 없는 사람 → 아무 처리 안함 (수동으로 참석 표시 필요)
- "나도 갈게" 등 참석 의사 표현 시 → 수동 참석 처리

---

## 시나리오 예시

```
조율방: A, B, C, D (4명)

A: "내일 저녁 6시에 만나자"

→ 시스템이 각 참여자의 기존 일정 확인
   - B: 6시에 일정 있음 → 자동 불참
   - A, C, D: 일정 없음 → 아무 처리 안함

→ 채팅방에 표시:
   "⚠️ B님은 해당 시간에 일정이 있어 자동 불참 처리되었습니다"

--- 나중에 ---

B: "그 약속 취소됐어 나도 갈게"
→ B를 참석으로 변경
```

---

## 규칙

| 상황 | 처리 |
|------|------|
| 일정 충돌 있음 | 자동 불참 ✅ |
| 일정 없음 | 아무것도 안함 (수동 참석 필요) |
| "나도 갈게" 등 참석 의사 표현 | 수동 참석 ✅ |
| 일정 정보 공개 | "일정 있음"만 표시 (제목 비공개) |

---

## 구현 계획

### 1단계: 백엔드 API 수정

**파일: `server/controllers/roomController.js`**

- 새 API 또는 기존 API 확장: `checkParticipantsAvailability`
- 입력: roomId, 제안된 시간 (startTime, endTime)
- 출력: 각 참여자별 충돌 여부
  ```json
  {
    "conflicts": [
      { "odakUserId": "user123", "odakUserName": "B", "hasConflict": true }
    ]
  }
  ```

**로직:**
1. 방의 모든 참여자 목록 가져오기
2. 각 참여자의 events, personalTimes 조회
3. 제안 시간과 겹치는 일정 있는지 확인
4. 충돌 목록 반환

### 2단계: 조율방 시간 제안 시 충돌 체크

**파일: `server/controllers/roomController.js` - `proposeTime` 또는 관련 함수**

- 시간 제안 시 자동으로 충돌 체크 호출
- 충돌 있는 참여자는 자동으로 `declined` 상태로 설정
- 충돌 정보를 응답에 포함

### 3단계: 프론트엔드 UI 수정

**파일: `client/src/components/tabs/CoordinationTab.js` 또는 관련 컴포넌트**

- 시간 제안 후 응답에서 충돌 정보 받기
- 채팅/알림 영역에 "⚠️ B님은 해당 시간에 일정이 있어 자동 불참 처리되었습니다" 표시
- 참석 현황에 자동 불참자 표시 (다른 색상/아이콘으로 구분)

### 4단계: LLM 프롬프트 수정 (채팅 기반 참석 변경)

**파일: `client/src/hooks/useChat/prompts/` 또는 `server/services/aiScheduleService.js`**

- "나도 갈게", "참석할게", "갈 수 있어" 등의 표현 인식
- 해당 사용자의 참석 상태를 `declined` → `accepted`로 변경

---

## 수정 파일 목록

### 백엔드
1. `server/controllers/roomController.js` - 충돌 체크 로직 추가
2. `server/models/room.js` - 참여자 상태에 `autoDeclined` 필드 추가 (선택)
3. `server/routes/roomRoutes.js` - 새 API 라우트 (필요시)

### 프론트엔드
4. `client/src/components/tabs/CoordinationTab.js` - 충돌 알림 UI
5. `client/src/components/coordination/` - 관련 컴포넌트들
6. `client/src/hooks/useChat/` - 참석 의사 표현 인식

---

## 데이터 흐름

```
[사용자 A가 시간 제안]
       ↓
[백엔드: proposeTime API]
       ↓
[각 참여자의 events, personalTimes 조회]
       ↓
[제안 시간과 충돌 체크]
       ↓
[충돌 있는 참여자 → 자동 불참 처리]
       ↓
[프론트엔드: 충돌 정보 + 참석 현황 표시]
```

---

## 확인 필요 사항

1. 현재 조율방에서 시간 제안하는 방식 확인 (API 구조)
2. 참여자의 참석/불참 상태 관리 방식 확인
3. 채팅 메시지 표시 방식 확인

---

## 구현 순서

1. [x] 현재 조율방 코드 구조 파악 ✅
2. [x] preferenceService.checkTimeConflict에 events 체크 추가 ✅
3. [x] MemberResponseSchema에 자동 불참 필드 추가 ✅
4. [x] handleNewSchedule에서 자동 불참 처리 ✅
5. [x] 프론트엔드 충돌 알림 UI 구현 ✅
6. [x] LLM 참석 의사 인식 추가 ✅
7. [ ] 테스트

---

## 코드 분석 결과

### 핵심 파일
- `server/services/preferenceService.js` - checkTimeConflict (충돌 체크)
- `server/services/aiScheduleService.js` - handleNewSchedule (제안 생성)
- `server/models/ScheduleSuggestion.js` - memberResponses (참석 상태)

### 현재 충돌 체크 대상
- room.timeSlots (확정된 그룹 일정) ✅
- user.personalTimes (개인 시간) ✅
- **user.events (개인 일정) ❌ ← 추가 필요**

### 데이터 흐름
```
채팅 메시지 발송 (sendMessage)
       ↓
AI 대화 분석 (aiScheduleService.analyzeConversation)
       ↓
새 일정 감지 시 (handleNewSchedule)
       ↓ ← 여기서 충돌 체크 + 자동 불참 처리
ScheduleSuggestion 생성 (memberResponses에 상태 저장)
       ↓
시스템 메시지 발송 (자동 불참자 알림 포함)
```