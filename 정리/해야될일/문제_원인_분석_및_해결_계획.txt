[시간표 침범 문제 - 원인 분석 및 해결 계획]

================================================================================
1. 문제 원인 분석
================================================================================

[핵심 문제 1] 일반 보기 알고리즘 - 블록 분산 문제
---------------------------------------------
현상:
- 6시간 작업을 월/화/수/목으로 분산시킴
  예) a작업: 월 13-17 (4시간) + 화 13-16 (2시간)
      b작업: 수 13-17 (4시간) + 목 13-16 (2시간)

원인:
- 알고리즘이 블록을 "가능한 한 빨리 배치"하는 방식으로 동작
- "한 날에 최대한 모으기" 로직 부재
- 블록 결합 우선순위가 낮음

영향:
- 불필요하게 여러 날에 걸쳐 작업 배치
- 사용자 경험 저하 (한 날에 완료할 수 있는 작업이 여러 날로 분산)


[핵심 문제 2] 교통수단 보기 - 금지시간 침범 문제
---------------------------------------------
현상:
- 이동시간 추가 시 기존 일정을 뒤로 밀어서 17시 이후로 침범
  예) 기존: 13-17 (4시간 작업)
      이동시간 1시간 추가 후: 13-18 → 17-18시는 금지시간 침범!

원인:
- 교통수단 보기가 "일반 보기 결과 + 이동시간"으로 단순 계산
- 이동시간 추가 시 선호시간/금지시간 검증 로직 부재
- 시간을 뒤로 미는 방식으로만 처리 (재배치 로직 없음)

영향:
- 절대 규칙 위반 (17-24시 금지시간 침범)
- 선호시간을 벗어난 일정 배정
- 검증 실패 처리가 되지 않아 잘못된 일정이 확정됨


[핵심 문제 3] 이동시간 검증 부재
---------------------------------------------
현상:
- 이동시간 + 작업시간이 선호시간을 벗어나도 그대로 배정

원인:
- 교통수단별 이동시간 추가 시 선호시간 범위 검증 미흡
- 금지시간 충돌 감지 로직 부재
- 재배치 알고리즘 미구현

영향:
- 유효하지 않은 일정이 확정됨
- 사용자가 실행 불가능한 일정을 받게 됨


================================================================================
2. 해결 계획
================================================================================

[Phase 1] ✅ 일반 보기 알고리즘 개선 - 블록 결합 우선순위 추가 (완료)
-------------------------------------------------------------
목표: 한 날에 최대한 블록을 모아서 배치

1.1. ✅ 블록 결합 로직 추가
   - 같은 날의 여러 선호 블록을 결합하여 우선 배치
   - 예) 월 9-12 (3시간) + 월 13-17 (4시간) = 월 9-12, 13-17 (총 6시간)

1.2. ✅ 배치 우선순위 변경
   기존: 요일 순서대로 빈 블록에 순차 배치
   변경:
   - 1순위: 한 날에 전체 작업을 완료할 수 있는 경우
   - 2순위: 한 날에 최대한 많이 배치 (남은 시간은 다음 날)
   - 3순위: 기존 방식 (여러 날 분산)

1.3. ✅ 구현 위치
   - 파일: server/services/schedulingAlgorithm/basicScheduler.js (추정)
   - 함수: assignTimeBlocks() 또는 유사 함수

1.4. ✅ 검증 방법
   - 6시간 작업이 월 9-12 + 13-16으로 한 날에 배치되는지 확인
   - 4시간 작업이 13-17 한 블록에 배치되는지 확인


[Phase 2] 교통수단 보기 - 이동시간 검증 및 재배치 로직 추가
-------------------------------------------------------------
목표: 이동시간 추가 후 선호시간/금지시간 검증 및 자동 재배치

2.1. 선호시간 검증 함수 추가
   함수명: validateTimeWithTravel(block, travelTime, preferences, prohibited)
   입력:
   - block: 배정된 시간 블록
   - travelTime: 이동시간 (분)
   - preferences: 선호시간 배열
   - prohibited: 금지시간 배열

   출력:
   - valid: boolean (유효성 여부)
   - reason: string (실패 사유)

   검증 내용:
   - 이동시간 + 작업시간이 선호시간 안에 모두 포함되는가?
   - 금지시간을 침범하지 않는가?
   - 17-24시 절대 금지 시간을 침범하지 않는가?

2.2. 재배치 알고리즘 구현
   함수명: relocateBlockWithTravel(block, travelTime, preferences, prohibited)

   재배치 전략:
   a) 같은 날의 다른 선호 블록으로 이동
      예) 13-17 배치 → 이동시간 때문에 17시 넘김
          → 같은 날 9-12로 이동 가능한지 확인

   b) 블록 분할
      예) 6시간 작업 = 월 9-12 (3시간+이동) + 화 13-16 (3시간+이동)

   c) 다음 날로 이동
      예) 월요일에 배치 불가 → 화요일 13-17로 이동

   d) 모두 실패 시 에러 반환
      - "이동시간을 고려하면 선호시간 내 배치 불가능"

2.3. 구현 위치
   - 파일: server/services/schedulingAlgorithm/travelTimeHandler.js (추정)
          또는 server/services/schedulingAlgorithm/validators/ 하위
   - 기존 교통수단 처리 로직에 검증 단계 추가

2.4. 검증 방법
   테스트 케이스:
   - 13-17 블록 + 1시간 이동 = 13-18 → 금지시간 침범 감지 및 재배치
   - 9-12 블록 + 1시간 이동 = 8-12 → 선호시간 밖이면 재배치
   - 재배치 불가능 시 적절한 에러 메시지 반환


[Phase 3] 통합 테스트 및 엣지 케이스 처리
-------------------------------------------------------------
3.1. 테스트 시나리오
   - 4시간 작업 (A, B 모두 월/화/수 9-12, 13-17 선호)
     예상 결과: A는 월 13-17, B는 화 13-17

   - 6시간 작업 + 이동시간 없음
     예상 결과: 월 9-12 + 13-16 (한 날에 완료)

   - 6시간 작업 + 1시간 이동시간
     예상 결과:
     - 월 9-12 (4시간 = 3시간 작업 + 1시간 이동)
     - 화 13-16 (4시간 = 3시간 작업 + 1시간 이동)

   - 금지시간 침범 케이스
     예상 결과: 재배치 또는 에러 메시지

3.2. 엣지 케이스
   - 모든 선호 블록이 이동시간 때문에 사용 불가
   - 블록 분할 후에도 선호시간 부족
   - 여러 조원의 금지시간이 겹치는 경우

3.3. 로깅 추가
   - 재배치가 발생한 경우 로그 기록
   - 금지시간 침범 감지 시 경고 로그
   - 최종 배치 결과 상세 로그


================================================================================
3. 구현 순서 및 우선순위
================================================================================

[✅ 완료] Phase 1: 일반 보기 블록 결합 개선
   상태: 완료됨
   결과:
   - 6시간 작업이 이제 한 날에 배치됨 (예: 월 9-12 + 13-16)
   - 블록 분산 문제 해결됨

[우선순위 1 - 긴급] Phase 2: 교통수단 보기 검증 로직
   이유: 금지시간 침범은 절대 규칙 위반으로 즉시 수정 필요
   예상 작업 시간: 2-3일

   세부 단계:
   1) 기존 교통수단 처리 코드 파악 (0.5일)
   2) 검증 함수 구현 (0.5일)
   3) 재배치 알고리즘 구현 (1일)
   4) 단위 테스트 작성 (0.5일)
   5) 통합 테스트 (0.5일)

[우선순위 2 - 보완] Phase 3: 통합 테스트 및 엣지 케이스
   이유: 안정성 확보 및 예외 상황 대비
   예상 작업 시간: 1일

   세부 단계:
   1) 테스트 시나리오 작성 (0.3일)
   2) 엣지 케이스 테스트 (0.4일)
   3) 로깅 개선 (0.3일)


================================================================================
4. 예상 결과
================================================================================

[개선 전]
- 6시간 작업 → 월 13-17, 화 13-16 (2일 분산)
- 이동시간 추가 시 → 월 13-18 (17-18시 금지시간 침범!)

[개선 후]
- 6시간 작업 → 월 9-12, 13-16 (1일 완료)
- 이동시간 추가 시 → 월 9-12 (4시간), 화 13-16 (4시간)
  또는 재배치 불가 시 명확한 에러 메시지


================================================================================
5. 리스크 및 대응 방안
================================================================================

[리스크 1] 기존 코드 구조가 복잡하여 수정 범위 확대
대응: 단계별로 구현하고 각 단계마다 테스트하여 영향 범위 최소화

[리스크 2] 재배치 알고리즘 복잡도로 인한 성능 저하
대응: 블록 수가 적은 경우 재배치, 많은 경우 에러 처리로 타협

[리스크 3] 엣지 케이스 미처리로 인한 새로운 버그
대응: 충분한 테스트 케이스 작성 및 로깅 강화


================================================================================
6. 다음 단계 (현재 시점)
================================================================================

✅ 1. Phase 1 완료
   - 일반 보기 알고리즘 개선 완료
   - 블록 결합 로직 구현 완료

🔄 2. Phase 2 (우선순위 1) 구현 시작 - 현재 진행 중
   단계:
   a) 기존 코드베이스 파악
      - server/services/schedulingAlgorithm/ 하위 파일 구조 확인
      - 교통수단 처리 로직 위치 파악

   b) 검증 함수 구현
      - validateTimeWithTravel() 함수 작성
      - 선호시간/금지시간 검증 로직 추가

   c) 재배치 알고리즘 구현
      - relocateBlockWithTravel() 함수 작성
      - 같은 날 재배치, 블록 분할, 다음 날 이동 로직

   d) 테스트 및 피드백
      - 실제 데이터로 테스트
      - 문제 발생 시 로그 확인 및 디버깅

📋 3. Phase 3 구현 (Phase 2 완료 후)
   - 통합 테스트
   - 엣지 케이스 처리
   - 전체 시스템 안정화

================================================================================
