# AI 일정 조율 시스템 - 프로젝트 통합 문서

**최종 업데이트:** 2026-01-30
**시스템 상태:** 프로덕션 준비 완료

---

## 📋 목차
1. [프로젝트 개요](#프로젝트-개요)
2. [핵심 시스템: LLM 기반 일정 분석](#핵심-시스템-llm-기반-일정-분석)
3. [개발 완료 현황](#개발-완료-현황)
4. [최근 개선사항 (2026-01-30)](#최근-개선사항-2026-01-30)
5. [주요 파일 구조](#주요-파일-구조)
6. [시스템 플로우](#시스템-플로우)
7. [API 및 Socket 이벤트](#api-및-socket-이벤트)
8. [향후 개선 항목](#향후-개선-항목)

---

## 프로젝트 개요

### 목표
그룹 채팅을 통해 자연스럽게 일정을 조율하고, AI가 합의된 일정을 자동으로 감지하여 제안하는 시스템

### 핵심 설계 철학: LLM 중심 (하드코딩 최소화)
- **날짜 계산**: LLM이 "금요일", "다음주 월요일" 등을 직접 계산
- **시간 해석**: LLM이 맥락으로 "6시 밥" → 18:00 판단
- **합의 감지**: LLM이 대화 흐름으로 자연스럽게 판단
- **프롬프트**: 한국어로 작성하여 문화적 맥락 전달 강화
- **Few-Shot Learning**: 10가지 실제 대화 예시 제공

---

## 핵심 시스템: LLM 기반 일정 분석

### 핵심 파일
- `server/services/aiScheduleService.js` - 메인 분석 로직
- `server/prompts/scheduleAnalysis.js` - LLM 프롬프트 (한국어, Few-shot)

### Action 유형

#### 1. `new` - 새 일정 생성
**조건:**
- 최소 2명 이상 참여 (제안 + 동의)
- 구체적인 날짜/시간 합의
- 기존 일정과 다른 새로운 약속

**예시:**
```
A: 내일 7시에 밥먹을까?
B: ㅇㅋ
C: 좋아
→ 새 일정 생성
```

#### 2. `response` - 기존 일정 응답 (🆕 자동 참석/불참 처리)
**조건:**
- 기존 일정에 대한 참석/불참 의사 표현
- sentiment 분석으로 자동 처리

**Sentiment 분석:**
- `"accept"`: "나도 감", "ㅇㅋ", "좋아" 등 → **자동 수락**
- `"reject"`: "못 갈 것 같아", "불참", "패스" 등 → **자동 거절**
- `null`: 중복 제안 또는 단순 응답 → 처리 안 함

**예시 1 - 자동 수락:**
```
[일정: 내일 7시 밥약속 - 이미 생성됨]
D: 나도 감
→ D를 자동으로 일정에 "수락" 처리
```

**예시 2 - 자동 거절:**
```
[일정: 내일 7시 밥약속 - 이미 생성됨]
E: 못 갈 것 같아 ㅠ
→ E를 자동으로 일정에 "거절" 처리
```

#### 3. `extend` - 일정 확장/수정
**조건:**
- 기존 일정에 추가 활동 합의
- 시간/장소 변경 합의

**예시:**
```
[일정: 6시 밥약속]
A: 밥 먹고 PC방 ㄱ?
B: ㅇㅋ
→ 기존 일정 수정: "밥약속" → "밥약속 + PC방", endTime 연장
```

#### 4. `cancel` - 일정 취소
**조건:**
- 제안자가 취소 의사 표현
- "ㅈㅅ 일생김", "못 갈 것 같아" 등

**취소 로직:**
```javascript
if (제안자 제외 수락자 >= 2명) {
  // 제안자만 불참 처리, 일정은 유지
} else {
  // 일정 완전 취소
}
```

#### 5. `none` - 아무것도 안 함
- 아직 합의 안 됨
- 단순 잡담
- 불확실한 상황

### 시간 표현 해석 (LLM이 판단)

| 표현 | 맥락 | 해석 |
|------|------|------|
| "6시" | 밥/저녁/술 | 18:00 |
| "6시" | 아침 | 06:00 |
| "2시" | 점심 | 14:00 |
| "내일" | - | 오늘 + 1일 |
| "금요일" | - | 가장 가까운 금요일 |
| "다음주 월요일" | - | 다음 주 월요일 |

### 자동 endTime 계산

| 활동 | 기본 시간 |
|------|-----------|
| 회의/미팅/스터디 | 1시간 |
| 밥/식사/카페 | 2시간 |
| 밥 + 활동 (PC방 등) | 3시간 |

### 특이사항

1. ✅ **30초 버퍼 제거** (2026-01-30): 모든 메시지를 즉시 분석하여 실시간 응답 가능
2. ✅ **자동 참석/불참 처리** (2026-01-30): "나도 감" 같은 메시지로 자동 수락/거절
3. ✅ **중복 응답 방지** (2026-01-30): 이미 수락/거절한 사용자는 재처리 안 함
4. **거절 내역 체크**: 이전에 거절된 동일 일정은 재제안 안 함
5. **제안자 자동 수락**: 일정 생성 시 제안자는 자동으로 '수락' 상태
6. **Socket 실시간 전송**: 모든 변경사항 즉시 브로드캐스트

### 출력 JSON 형식

```json
// 새 일정
{
  "action": "new",
  "data": {
    "summary": "밥약속",
    "date": "2026-01-28",
    "startTime": "18:00",
    "endTime": "19:00",
    "location": ""
  }
}

// 응답 - 자동 수락
{
  "action": "response",
  "targetId": "기존일정ID",
  "sentiment": "accept",
  "reason": "참석 의사 표현"
}

// 응답 - 자동 거절
{
  "action": "response",
  "targetId": "기존일정ID",
  "sentiment": "reject",
  "reason": "불참 의사 표현"
}

// 확장
{
  "action": "extend",
  "targetId": "기존일정ID",
  "data": {
    "summary": "밥약속 + PC방",
    "endTime": "21:00"
  }
}

// 취소
{
  "action": "cancel",
  "targetId": "기존일정ID",
  "reason": "제안자가 일정 취소 요청"
}

// 아무것도 안 함
{
  "action": "none",
  "reason": "아직 합의 안 됨"
}
```

---

## 개발 완료 현황

### AI 엔진 (Phase 1-6) - ✅ 모두 완료
| Phase | 작업 | 상태 |
|-------|------|------|
| 1 | 프롬프트 분리 및 개선 (한국어, LLM 중심) | ✅ |
| 2 | 거절 추적 시스템 (중복 제안 방지) | ✅ |
| 3 | 거절 메시지 기록 (시스템 메시지) | ✅ |
| 4 | 선호시간 체크 로직 (충돌 감지) | ✅ |
| 5 | 최종 확인 플로우 (확인 모달) | ✅ |
| 6 | 날짜 인식 개선 및 테스트 케이스 | ✅ |

### 모바일 버전 (Phase 1-5) - ✅ 대부분 완료
| Phase | 작업 | 상태 |
|-------|------|------|
| 1 | 기본 구조 설정 (MobileDashboard) | ✅ |
| 2 | FullCalendar 통합 | ✅ |
| 3 | 화면 연결 (Router) | ✅ |
| 4 | UX 개선 및 버그 수정 | ✅ |
| 5 | 대화형 자동 일정 조율 시스템 | ✅ |

---

## 최근 개선사항 (2026-01-30)

### 🚀 주요 개선

#### 1. 실시간 응답 개선 - 30초 버퍼 제거
**문제:**
- 이전: 한 번 분석하면 30초 동안 새 메시지 무시
- 예: "내일 7시 밥먹자" (분석됨) → 10초 후 "나도 감" (무시됨!)

**해결:**
```javascript
// 이전 코드 (제거됨)
if (lastAnalysis && now - lastAnalysis < 30000) {
  return; // 30초 이내 재분석 방지
}

// 새 코드
// 버퍼 없음 - 모든 메시지를 즉시 분석
```

**효과:**
- ✅ 실시간으로 모든 메시지 분석 가능
- ✅ "나도 감" 같은 빠른 응답 즉시 처리

#### 2. 자동 참석/불참 처리
**문제:**
- 이전: "나도 감" 메시지 → 사용자가 버튼 클릭 필요
- 불편함: 한 번 더 클릭해야 함

**해결:**
```javascript
// 새로운 handleAutoResponse 함수 추가
if (sentiment === 'accept') {
  // 자동으로 일정에 "수락" 처리
  userResponse.status = 'accepted';
} else if (sentiment === 'reject') {
  // 자동으로 일정에 "거절" 처리
  userResponse.status = 'rejected';
}
```

**프롬프트 개선:**
```json
{
  "action": "response",
  "targetId": "기존일정ID",
  "sentiment": "accept",  // 🆕 추가됨
  "reason": "참석 의사 표현"
}
```

**효과:**
- ✅ "나도 감" → 자동 수락 + 개인 달력 추가
- ✅ "못 갈 것 같아" → 자동 거절
- ✅ 버튼 클릭 불필요

**🆕 개인 달력 자동 추가 (2026-01-30):**
```javascript
// 자동 수락 시 user.personalTimes에 일정 추가
const newPersonalTime = {
  title: `[약속] ${suggestion.summary}`,
  type: 'event',
  startTime: suggestion.startTime,
  endTime: suggestion.endTime,
  specificDate: suggestion.date,
  color: '#3b82f6',
  roomId: roomId
};
user.personalTimes.push(newPersonalTime);
await user.save();
```

#### 3. 중복 응답 방지
**문제:**
- 이전: "못 갈 것 같아" (불참) → "맞짱 깔 사람?" (잡담) → 또 불참 처리! ❌
- 이미 응답한 사용자인데도 계속 재처리

**해결:**
```javascript
// 이미 응답한 사용자는 재처리 안 함
if (userResponse.status !== 'pending') {
  console.log(`User already responded (${userResponse.status}), skipping`);
  return;
}
```

**효과:**
- ✅ pending 상태인 사용자만 처리
- ✅ 이미 accepted/rejected면 스킵
- ✅ 잡담으로 중복 처리 방지

#### 4. Sentiment 판단 기준 강화
**문제:**
- 이전: "맞짱 깔 사람?" (잡담) → 불참으로 오판 ❌
- 프롬프트의 sentiment 판단 기준이 너무 느슨함

**해결:**
```
🚨 sentiment 판단 엄격 규칙 🚨

1. 명확한 참석 표현만 "accept":
   ✅ "나도 감", "ㅇㅋ", "좋아"
   ❌ "맞짱 깔 사람?" → 새로운 제안!

2. 명확한 불참 표현만 "reject":
   ✅ "못 가", "불참", "패스"
   ❌ "맞짱 깔 사람?" → 잡담!

3. 애매하면 무조건 "none"
4. 가장 마지막 메시지만 판단
```

**추가된 예시:**
```
[예시 6 - 잡담은 none!]
이전: "못 감" (불참 처리됨)
현재: "맞짱 깔 사람?"
분석: 새로운 활동 제안, 일정 무관
→ { "action": "none" }
```

**효과:**
- ✅ 잡담을 일정 응답으로 오판 방지
- ✅ 새로운 활동 제안은 "none" 처리
- ✅ 가장 마지막 메시지만 판단

### 🛠️ 수정된 파일

1. **server/services/aiScheduleService.js**
   - 30초 버퍼 제거 (18-27번 줄)
   - `handleAutoResponse` 함수 추가 (299-369번 줄)
   - `action === 'response'` 처리 로직 개선 (102-110번 줄)
   - 🆕 **개인 달력 자동 추가**: `user.personalTimes`에 일정 추가
   - 🆕 **시간 형식 정규화**: `24:00` → `23:59` 변환
   - 🆕 **상세 로그 추가**: 모든 단계별 로그 출력

2. **server/prompts/scheduleAnalysis.js**
   - `response` action에 `sentiment` 필드 추가
   - 예시 3-2 추가 (불참 케이스)
   - 출력 형식 업데이트
   - 🆕 **targetId 사용법 명확화**: "기존일정ID" → 실제 MongoDB ObjectId 사용
   - 🆕 **다중 일정 처리 로직**: 가장 최근 일정을 기본 대상으로 선택
   - 🆕 **sentiment 판단 기준 강화**: 잡담/새 제안 오판 방지
   - 🆕 **"난 간다" 예시 추가**: 다양한 참석 표현 인식

---

## 주요 파일 구조

### 서버
```
server/
├── prompts/
│   ├── scheduleAnalysis.js              # 🔥 AI 프롬프트 (한국어, Few-shot)
│   ├── conversationalScheduleRecommender.js  # 대화형 시간표 추천
│   └── scheduleOptimizer.js             # 시간표 최적화
├── models/
│   ├── ScheduleSuggestion.js            # 일정 제안 스키마
│   └── RejectedSuggestion.js            # 거절 내역 스키마
├── services/
│   ├── aiScheduleService.js             # 🔥 AI 분석 서비스 (메인)
│   └── preferenceService.js             # 선호시간 체크 서비스
├── controllers/
│   └── chatController.js                # 채팅/제안 API
└── routes/
    └── chat.js                          # API 라우트
```

### 클라이언트
```
client/src/components/chat/
├── GroupChat.js                         # 그룹 채팅 (AI 제안 카드)
└── SuggestionModal.js                   # 일정 제안 모달
```

---

## 시스템 플로우

```
[사용자 채팅: "내일 7시 밥먹자"]
    ↓
[chatController.sendMessage]
    ↓ (비동기)
[aiScheduleService.analyzeConversation]
    ├─ 최근 5개 메시지 조회
    ├─ 한국어 프롬프트 생성
    ├─ Gemini API 호출
    ├─ JSON 파싱
    ├─ Action 판단
    │   ├─ new → 새 일정 생성
    │   ├─ response → 🆕 자동 참석/불참 처리
    │   ├─ extend → 일정 확장
    │   ├─ cancel → 일정 취소
    │   └─ none → 무시
    └─ Socket 이벤트 전송
            ↓
    [클라이언트 실시간 업데이트]
```

---

## API 및 Socket 이벤트

### 일정 제안 관련 API
```
GET  /api/chat/:roomId/suggestions?status=future|today|past
POST /api/chat/:roomId/suggestions/:suggestionId/accept
POST /api/chat/:roomId/suggestions/:suggestionId/reject
POST /api/chat/:roomId/check-conflict
```

### Socket 이벤트
```
schedule-suggestion    # 새 제안 발생
suggestion-updated     # 제안 상태 업데이트 (수락/거절)
schedule-rejected      # 거절 시
join-room              # 방 입장
chat-message           # 채팅 메시지 (시스템 메시지 포함)
```

---

## 향후 개선 항목

### 단기
- [ ] LLM 응답 품질 모니터링 (잘못된 날짜 계산 로그 수집)
- [ ] 프롬프트 A/B 테스팅
- [ ] 다양한 대화 패턴 수집 및 Few-shot 예시 추가
- [ ] sentiment 분석 정확도 개선 ("애매한 응답" 처리)

### 중장기
- [ ] 다국어 지원 (영어권 사용자용 프롬프트)
- [ ] 시간대(timezone) 지원
- [ ] 반복 일정 제안
- [ ] 선호 시간 힌트 제공 (선택적)

---

## 기술 스택

- **백엔드**: Node.js, Express, MongoDB, Socket.io
- **프론트엔드**: React, FullCalendar
- **AI**: Google Gemini 2.0-flash-exp
- **실시간 통신**: Socket.io

---

## 결론

**시스템 상태: 프로덕션 준비 완료**

✅ 모든 핵심 기능 구현 완료
✅ 하드코딩 최소화, LLM 자연어 이해 능력 최대 활용
✅ 실시간 응답 (30초 버퍼 제거)
✅ 자동 참석/불참 처리 (버튼 클릭 불필요)
✅ Few-shot learning으로 다양한 상황 커버
✅ 형식 검증 안전장치 유지
✅ 실시간 Socket 업데이트 완비

> **"LLM을 믿어라. 규칙을 주지 말고 예시를 줘라."**
