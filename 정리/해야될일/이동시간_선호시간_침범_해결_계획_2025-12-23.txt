작성일: 2025-12-23
작성자: Gemini (AI Assistant)
목적: 이동시간을 고려한 선호시간(Available Time) 유효성 검사 및 UI/챗봇 개선 계획
================================================================================

1. 문제 정의 (Problem Definition)
================================================================================
현재 시스템은 수업 배정 시 '수업 시간' 자체만 선호 시간 내에 있으면 허용하고 있습니다.
하지만 이동시간이 필요한 경우(예: 방장 -> 조원), 수업 시작 전 이동시간이 선호 시간 앞쪽(금지 시간)으로 튀어나가는 문제가 발생합니다.

[구체적 예시]
- 방장 선호시간: 09:00 ~ 12:00
- 필요 이동시간: 50분
- 사용자 행동: 조원이 "09:00"에 수업을 배치하거나 챗봇에 요청함.
- 현재 결과: 수업은 09:00에 잡히고, 이동시간은 08:10~09:00에 생성됨 (08:10은 금지시간임에도 생성됨).
- 기대 결과: 이동시간을 포함해도 선호시간 내여야 하므로, 09:50 이전에는 수업 배치를 막아야 함.

2. 개선 목표 (Goals)
================================================================================
1. **UI 시각화 (Priority 1)**: 
   - 조원이 시간표를 볼 때, 이동시간 때문에 수업이 불가능한 앞쪽 구간(예: 09:00~09:50)을 시각적으로 '금지(빗금)' 처리하여 클릭을 방지함.
2. **챗봇/서버 로직 강화 (Priority 2)**:
   - 챗봇을 통한 일정 변경 요청 시, 이동시간을 포함하여 선호시간을 벗어나는 경우 이를 거부하고 가능한 시간을 안내함.

3. 상세 구현 계획
================================================================================

Step 1: UI 시각화 개선 (Client)
--------------------------------------------------------------------------------
- **대상 파일**: `client/src/components/timetable/WeekView.js`
- **현재 로직**: `getMergedTimeBlocks` 및 `renderNormalView`에서 `time - myTravelDuration` 구간에 금지시간(`blocked`)이 있는지 확인함.
- **수정 로직**: 
  - 현재 로직은 '다른 일정(blocked)'과의 충돌만 체크할 가능성이 높음.
  - '선호시간(Preference)' 범위를 벗어나는지도 체크해야 함.
  - 방장의 `defaultSchedule` (선호시간) 정보를 활용하여, `time - myTravelDuration` 시점이 선호시간 시작점보다 이전이면 해당 슬롯(`time`)을 `travel_restricted` 처리함.

Step 2: 서버 유효성 검사 강화 (Server)
--------------------------------------------------------------------------------
- **대상 파일**: `server/controllers/coordinationExchangeController.js` (smartExchange 함수)
- **로직 추가**:
  - `targetTime` (요청된 수업 시작 시간)이 주어졌을 때,
  - `travelDuration` (예상 이동시간)을 계산하거나 가져옴.
  - `targetTime - travelDuration` (이동 시작 시간)이 방장의 선호시간 범위(`ownerTargetSchedules`) 내에 있는지 검사.
  - 범위를 벗어나면(예: 9시 이전), 에러 메시지 반환:
    "이동시간 50분을 포함하면 방장의 선호시간(09:00) 이전에 시작해야 합니다. 09:50 이후로 변경해주세요."

4. 작업 순서
================================================================================
1. [분석] `WeekView.js`에서 선호시간(Preference) 데이터를 어떻게 확인하고 있는지 분석.
2. [구현] UI에서 선호시간 시작점 미만 구간을 `travel_restricted`로 처리하는 로직 추가.
3. [구현] 서버 `smartExchange` 함수에 이동시간 포함 선호시간 검증 로직 추가.
4. [테스트]
   - 조원 계정으로 09:00~09:50 구간이 빗금쳐져 있는지 확인.
   - 챗봇으로 "09:00로 옮겨줘" 요청 시 거절 메시지가 뜨는지 확인.
