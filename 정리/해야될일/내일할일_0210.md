# 내일 할 일 (2026-02-10)

---

## 1. [긴급] 순수 구글 로그인 사용자 일정 추가 400 에러 수정

**현상**: 구글로 로그인한 사용자가 채팅으로 일정 추가 시 `PUT /api/users/profile/schedule 400 (Bad Request)` Validation Error 발생

**원인 (확인됨)**:
`getUserSchedule` (userController.js:320)이 DB personalTimes와 구글 캘린더 이벤트를 합쳐서 반환:
```javascript
const allPersonalTimes = [...personalTimesWithLocation, ...googleConfirmedEvents];
```
→ useEventAdd.js가 이걸 그대로 다시 PUT으로 보냄
→ 구글 캘린더 이벤트에는 `type` 필드 없음 (스키마 required), `id`가 문자열 (스키마 Number required)
→ Mongoose ValidationError 400

**수정 방법**: useEventAdd.js에서 기존 personalTimes를 re-save할 때 `isGoogleEvent: true`인 항목 필터링
```javascript
const existingPersonalTimes = Array.isArray(currentSchedule.personalTimes)
  ? currentSchedule.personalTimes.filter(pt => !pt.isGoogleEvent)  // 구글 이벤트 제외
  : [];
```

**파일**: `client/src/hooks/useChat/hooks/useEventAdd.js` (184번 줄)

---

## 2. [긴급] 일정 추가 시 빨간+파란 중복 표시 검증

**현상**: 구글 연동 사용자가 채팅으로 일정 추가 → 빨간색(DB)과 파란색(구글캘린더) 동시 표시

**이미 적용한 수정**:
- `calendarController.js`: createGoogleCalendarEvent, syncEventsToGoogle에 `extendedProperties.private.source = 'meetagent'` 추가
- `MobileCalendarView.js`: 구글 이벤트 필터에서 `source === 'meetagent'`이면 스킵 (2곳)

**검증 필요**:
- 새로 일정 추가했을 때 빨간색만 뜨는지 확인
- 기존에 이미 동기화된 이벤트(source 태그 없음)는 여전히 중복될 수 있음 → 구글캘린더에서 수동 삭제 후 재동기화

---

## 3. [중간] 상단 초록불 검증

**이미 적용한 수정**:
5개 파일에서 `localStorage.getItem('loginMethod') === 'google'` → `user?.google?.refreshToken` 변경:
- MobileHeader.js
- MobileDashboard.js
- MobileGroupsView.js
- MobileScheduleView.js
- MobileCalendarView.js

**검증 필요**: 이메일 로그인 → 설정에서 구글 연동 → 초록불로 바뀌는지 확인

---

## 4. [중간] 수동 동기화 버튼 검증

**이미 적용한 수정**:
- `calendarController.js` syncEventsToGoogle: personalTimes + Event 컬렉션 둘 다 읽도록 수정
- `MobileSettings.js`: "기존 일정 동기화" 버튼 추가 (구글 캘린더 연동 상태에서만 표시)
- 연동 콜백 시 자동 동기화 호출도 추가

**검증 필요**: 설정 → 동기화 버튼 클릭 → 기존 일정이 구글 캘린더에 추가되는지 확인

---

## 5. [기존] 프로젝트 가이드 기존 미완료 작업

### 5-3. extend 시 "같은 값" 오판 (중간 우선순위)
- 2월 10일 일정이 22:00인 상태에서 2월 9일을 22:00으로 변경 시 "이미 같은 값" 스킵
- 파일: `server/services/aiScheduleService.js`, `server/prompts/scheduleAnalysis.js`

### 5-4. 날짜 계산 오류 (중간 우선순위)
- "다음 주 월요일"이 1일 밀려서 계산
- 파일: `server/prompts/scheduleAnalysis.js`

### 5-5. 시간 해석 모호성 (낮은 우선순위)
- "10시까지 놀자" → 오전 10시로 해석됨 (맥락상 22:00)
- 파일: `server/prompts/scheduleAnalysis.js`

### 5-6. window.confirm → CustomAlertModal 변환 (낮은 우선순위)
- 남은 파일 10개:
  - AdminRoomManagement.js, AdminUserManagement.js, TimetableGrid.js
  - SuggestionModal.js, EventDetailModal.js, MobileCalendarView.js
  - MobileScheduleEdit.js, MemberStatsModal.js, MemberLogsModal.js
  - RoomManagementModal.js

---

## 작업 순서 권장

1. **1번 (400 에러)** → 한 줄 수정으로 해결 가능, 가장 급함
2. **2번 (중복 표시 검증)** → 이미 코드 수정 완료, 테스트만
3. **3번 (초록불 검증)** → 이미 코드 수정 완료, 테스트만
4. **4번 (동기화 검증)** → 이미 코드 수정 완료, 테스트만
5. **5번** → 시간 여유 있으면 진행
