[코드 분석 결과 - 2025]

================================================================================
1. 분석한 주요 파일
================================================================================

✅ server/services/schedulingAlgorithm/validators/travelTimeValidator.js
   - 이동시간 검증 모듈 (선호시간 + 금지시간 검증)
   - 함수: isWithinPreferredTime, validateTravelTimeSlot, validateAllSlots

✅ server/services/schedulingAlgorithm/validators/prohibitedTimeValidator.js
   - 금지시간 검증 및 블록 분할 모듈
   - 함수: isTimeInBlockedRange, splitBlockToAvoidProhibited, validateAssignedSlots

✅ server/services/schedulingAlgorithm/services/publicTransportAssignmentService.js
   - 대중교통 모드 배정 서비스 (교통수단 보기)
   - 함수: assignByPublicTransport, assignTimeSlot

✅ server/services/schedulingAlgorithm/helpers/assignmentHelper.js
   - 배정 관련 헬퍼 함수
   - 함수: findNearestMemberWithSufficientTime, sortMembersByDistance, calculateTravelTime

✅ server/services/schedulingAlgorithm/services/slotAssignmentService.js
   - 슬롯 배정 서비스 (일반 보기 알고리즘)
   - 함수: assignByTimeOrder, assignUndisputedSlots, iterativeAssignment

✅ server/services/schedulingAlgorithm/utils/timeUtils.js
   - 시간 관련 유틸리티
   - 함수: validateTimeSlotWithTravel, findNextAvailableSlot, findConflictingPersonalTime


================================================================================
2. 현재 구현 상태 분석
================================================================================

[2.1] 일반 보기 알고리즘 (slotAssignmentService.js)
-----------------------------------------------------
✅ 이미 블록 결합 로직이 구현되어 있음!

주요 로직 (assignByTimeOrder):
1. 모든 가능한 블록을 찾음
2. 충분한 블록(≥ maxSlotsPerRound)과 부족한 블록 분리
3. 충분한 블록 중 가장 빠른 시간 우선 배정 (분할 최소화)
4. 금지시간 검증 포함

예상 동작:
- 6시간 작업 → 월 9-12 + 13-16 (한 날에 완료) ✅
- 4시간 작업 → 13-17 한 블록 ✅

⚠️ 잠재적 문제:
- 코드 상으로는 올바르게 보이나, 실제 동작 확인 필요
- 블록 검색 로직이 복잡하여 엣지 케이스에서 오류 가능성


[2.2] 교통수단 보기 (publicTransportAssignmentService.js)
-----------------------------------------------------
⚠️ 재배치 로직 부족!

현재 흐름:
1. findNearestMemberWithSufficientTime으로 가장 가까운 학생 찾기
2. validateTimeSlotWithTravel로 시간 검증
   - 이동시간 + 수업시간이 선호시간 안에 들어가는지 확인
   - 예외시간 충돌 시 예외시간 이후로 자동 이동
3. 검증 통과 시 assignTimeSlot으로 배정
4. 검증 실패 시 다음 멤버로 넘어감

⚠️ 문제점:
- validateTimeSlotWithTravel이 예외시간 이후로 이동만 함
- 이동 후에도 선호시간을 벗어나면 실패 처리
- 같은 날의 다른 블록으로 이동 시도 없음
- 다른 날로 이동 시도 없음
- 블록 분할 시도 없음


[2.3] 시간 검증 (timeUtils.js - validateTimeSlotWithTravel)
-----------------------------------------------------
✅ 기본 검증 기능은 잘 구현됨

주요 기능:
1. 이동시간 + 수업시간 계산
2. 선호시간 범위 확인
3. 예외시간(개인시간) 충돌 감지
4. 예외시간 이후로 자동 이동
5. 방 레벨 금지시간 지원 (roomBlockedTimes, roomExceptions)

⚠️ 한계:
- 단순히 "가능/불가능" 판단만 함
- 대안 시간대 제시 없음
- 재배치 로직 없음


================================================================================
3. 문제 원인 정리
================================================================================

[문제 1] 일반 보기 - 블록 분산 문제
-------------------------------------
상태: ⚠️ 코드상으로는 해결되어 있음 (검증 필요)

현재 코드:
- assignByTimeOrder가 충분한 블록 중 가장 빠른 시간 우선 배정
- 이론적으로는 "한 날에 최대한 모으기" 달성

의문점:
- 실제로 이 로직이 잘 작동하는가?
- 엣지 케이스에서 문제 발생 가능성?

권장 조치:
- 실제 테스트 케이스로 동작 확인
- 필요 시 로직 개선


[문제 2] 교통수단 보기 - 금지시간 침범 문제
-------------------------------------
상태: ❌ 재배치 로직 부재

현재 동작:
1. 13-17 블록 + 1시간 이동 = 13-18
2. validateTimeSlotWithTravel 호출
3. 예외시간 이후로 이동 시도 (예: 18시부터 시작)
4. 18시가 선호시간을 벗어나면 실패 처리
5. 해당 멤버 건너뛰고 다음 멤버로

문제점:
- 같은 날 9-12 블록으로 재배치 시도 안 함
- 다른 날로 이동 시도 안 함
- 블록 분할 시도 안 함

필요한 개선:
- findNearestMemberWithSufficientTime에 재배치 로직 추가
- 또는 새로운 함수 추가: findBestSlotForMember


[문제 3] 이동시간 검증 부재
-------------------------------------
상태: ✅ 검증 함수는 있음 / ⚠️ 재배치 로직 없음

현재:
- validateTimeSlotWithTravel이 검증 수행
- 하지만 실패 시 재시도 로직 없음

필요한 개선:
- 검증 실패 시 대안 시간대 찾기
- 여러 선호 블록 순회하며 최적 블록 찾기


================================================================================
4. 구현 계획 수정
================================================================================

[우선순위 1 - 긴급] 교통수단 보기 재배치 로직 추가
--------------------------------------------
목표: 이동시간으로 인한 선호시간 초과 시 자동 재배치

작업 내용:
1. findAlternativeSlot 함수 구현
   - 같은 날의 다른 선호 블록 탐색
   - 다른 날의 선호 블록 탐색
   - 블록 분할 고려

2. findNearestMemberWithSufficientTime 개선
   - validateTimeSlotWithTravel 실패 시
   - findAlternativeSlot으로 대안 탐색
   - 대안이 있으면 재배치, 없으면 다음 멤버

3. 로깅 강화
   - 재배치 발생 시 상세 로그
   - 금지시간 침범 감지 로그

구현 위치:
- server/services/schedulingAlgorithm/helpers/assignmentHelper.js
  → findAlternativeSlot 함수 추가
  → findNearestMemberWithSufficientTime 수정

예상 작업 시간: 2-3시간


[우선순위 2 - 중요] 일반 보기 동작 검증 및 개선
--------------------------------------------
목표: 실제로 "한 날에 최대한 모으기"가 작동하는지 확인

작업 내용:
1. 테스트 케이스 작성
   - 6시간 작업 → 월 9-12 + 13-16 기대
   - 4시간 작업 → 13-17 한 블록 기대

2. 실제 동작 확인
   - 로그 분석
   - 예상과 다르면 원인 파악

3. 필요 시 로직 개선
   - 블록 검색 알고리즘 수정
   - 우선순위 조정

구현 위치:
- server/services/schedulingAlgorithm/services/slotAssignmentService.js
  → assignByTimeOrder 함수 검증 및 개선

예상 작업 시간: 1-2시간


[우선순위 3 - 보완] 통합 테스트
--------------------------------------------
목표: 전체 시스템 안정성 확보

작업 내용:
1. 엣지 케이스 테스트
2. 금지시간 침범 방지 확인
3. 재배치 로직 검증


================================================================================
5. 다음 단계
================================================================================

즉시 시작:
1. [우선순위 1] 교통수단 보기 재배치 로직 구현
   - findAlternativeSlot 함수 작성
   - findNearestMemberWithSufficientTime 수정

2. [우선순위 2] 일반 보기 동작 검증
   - 테스트 케이스 실행
   - 문제 발견 시 수정

3. [우선순위 3] 통합 테스트
   - 전체 시나리오 테스트
   - 문제 발생 시 디버깅


================================================================================
6. 구현 세부 사항 (findAlternativeSlot)
================================================================================

함수명: findAlternativeSlot

입력:
- member: 멤버 객체
- currentEndTime: 현재 종료 시간
- travelTimeMinutes: 이동시간
- classDurationMinutes: 수업시간
- transportMode: 교통수단
- roomBlockedTimes: 방 금지시간
- roomExceptions: 방 예외시간

출력:
- { day, startTime, endTime, relocationType } 또는 null

재배치 전략:
1. 같은 날의 다른 선호 블록 탐색
   - 이른 시간대 (예: 9-12)로 이동 가능한지 확인
   - validateTimeSlotWithTravel로 검증

2. 다른 날의 같은 시간대 탐색
   - 다음 날 같은 블록 (예: 화요일 13-17)
   - validateTimeSlotWithTravel로 검증

3. 블록 분할
   - splitBlockToAvoidProhibited 활용
   - 6시간 → 3시간 + 3시간 분할

4. 모두 실패 시 null 반환


================================================================================
