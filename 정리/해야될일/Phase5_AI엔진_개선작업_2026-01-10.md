# Phase 5 AI 엔진 개선 작업 로그

**작업 시작일**: 2026-01-10
**작업자**: Claude Code
**목적**: AI 일정 제안 시스템의 정확도 및 사용자 경험 개선

---

## 📋 현재 문제점

### 1. 날짜 인식 오류
**증상**:
- 사용자: "다음주 목요일 오후 4시에 만나자"
- AI 인식 결과: 2026-01-10 (오늘) → **잘못된 날짜**
- 예상 결과: 2026-01-16 (다음주 목요일)

**원인 분석 필요**:
- 현재 프롬프트의 날짜 파싱 로직이 하드코딩되어 있음
- LLM이 맥락을 자연스럽게 파악하지 못하고 있음

### 2. 거절 후 재등장 문제
**증상**:
- 사용자가 AI 제안을 거절해도 같은 제안이 계속 다시 나타남
- 새로운 대화 내용도 분석해야 하는데 이전 거절 내역이 없어서 반복됨

**필요 기능**:
- 거절된 제안을 DB에 기록
- 동일한 제안 재생성 방지
- 새로운 대화/약속은 정상적으로 분석

### 3. 프롬프트 하드코딩 문제
**증상**:
```javascript
// 현재 프롬프트 (aiScheduleService.js:66-92)
2. **Date Parsing**:
   - "내일" (tomorrow) → ${today} + 1 day
   - "모레" (day after tomorrow) → ${today} + 2 day
   - "다음주 월요일" → next Monday from ${today}
```
- 규칙 기반 접근으로 LLM의 자연어 이해 능력을 제한함
- 예외 케이스 처리 어려움

**개선 방향**:
- LLM이 스스로 맥락을 파악하도록 프롬프트 재작성
- 날짜/시간 계산을 LLM에게 맡기고 검증만 수행

### 4. 수락 플로우 부족
**현재 플로우**:
```
사용자 클릭 [수락] → 즉시 캘린더 추가
```

**개선 필요**:
```
1. [수락] 버튼 클릭
2. 방 멤버들의 선호시간 체크
3. 시간 충돌 여부 판단
4. "이 시간에 일정을 추가하시겠습니까?" 최종 확인 모달
5. [확인] → 캘린더 추가
```

### 5. 거절 기록 부재
**필요 기능**:
- 거절 시 채팅창에 시스템 메시지 표시: "AI 일정 제안을 거절했습니다"
- ChatMessage에 거절 내역 저장

---

## 🎯 개선 계획

### Phase 1: 프롬프트 분리 및 개선
**작업 내용**:
- [ ] `server/prompts/scheduleAnalysis.js` 파일 생성
- [ ] 하드코딩된 규칙 제거, LLM 중심 프롬프트 작성
- [ ] 맥락 이해 능력 강화
- [ ] Few-shot 예제 추가 고려

**관련 파일**:
- `server/services/aiScheduleService.js` (기존)
- `server/prompts/scheduleAnalysis.js` (신규)

---

### Phase 2: 거절 추적 시스템 구현
**작업 내용**:
- [ ] `RejectedSuggestion` 모델 생성 또는 `ChatMessage`에 거절 타입 추가
- [ ] 거절된 제안 저장 API
- [ ] AI 분석 시 거절 내역 체크 로직 추가
- [ ] 중복 제안 필터링

**필요 스키마**:
```javascript
{
  roomId: ObjectId,
  suggestion: {
    date: String,
    startTime: String,
    endTime: String,
    summary: String,
    location: String
  },
  rejectedAt: Date,
  rejectedBy: ObjectId
}
```

**관련 파일**:
- `server/models/RejectedSuggestion.js` (신규)
- `server/services/aiScheduleService.js` (수정)
- `server/controllers/chatController.js` (거절 API 추가)

---

### Phase 3: 거절 메시지 기록
**작업 내용**:
- [ ] 거절 버튼 클릭 시 시스템 메시지 생성
- [ ] ChatMessage type='system' 추가
- [ ] 클라이언트에서 시스템 메시지 스타일링

**관련 파일**:
- `server/controllers/chatController.js` (거절 API)
- `client/src/components/chat/GroupChat.js` (거절 핸들러)

---

### Phase 4: 선호시간 체크 로직
**작업 내용**:
- [ ] 사용자 선호시간 조회 API
- [ ] 제안 시간과 선호시간 충돌 체크 알고리즘
- [ ] 충돌 발생 시 경고 메시지 생성

**필요 기능**:
```javascript
// 예시
function checkTimeConflict(proposedDate, proposedTime, roomMembers) {
  // 각 멤버의 선호시간 조회
  // 제안 시간과 비교
  // 충돌 여부 반환
}
```

**관련 파일**:
- `server/services/preferenceService.js` (신규)
- `server/controllers/chatController.js` (수정)

---

### Phase 5: 최종 확인 플로우
**작업 내용**:
- [ ] 수락 버튼 클릭 시 즉시 추가하지 않고 확인 모달 표시
- [ ] 모달에서 멤버 선호시간 충돌 정보 표시
- [ ] [최종 확인] 버튼 → 캘린더 추가

**UI 플로우**:
```
[AI 제안 카드]
  ↓ 사용자 클릭 [수락]
[확인 모달]
  - 일정 정보 표시
  - 멤버 가능 여부 표시
  - [취소] [일정 추가]
  ↓ 사용자 클릭 [일정 추가]
[캘린더에 추가 완료]
```

**관련 파일**:
- `client/src/components/chat/GroupChat.js` (모달 추가)
- `server/controllers/chatController.js` (confirm API 수정)

---

### Phase 6: 날짜 인식 개선
**작업 내용**:
- [ ] 새 프롬프트로 "다음주 목요일" 정확도 테스트
- [ ] 엣지 케이스 테스트 (이번 주/다음 주 경계)
- [ ] 필요 시 프롬프트 재조정

---

## 📁 파일 구조

### 신규 파일
```
server/
├── prompts/
│   └── scheduleAnalysis.js          # AI 프롬프트 분리
├── models/
│   └── RejectedSuggestion.js        # 거절 내역 스키마
└── services/
    └── preferenceService.js          # 선호시간 체크 서비스
```

### 수정 파일
```
server/
├── services/
│   └── aiScheduleService.js         # 프롬프트 import, 거절 체크 로직
├── controllers/
│   └── chatController.js            # 거절 API, confirm API 수정
└── routes/
    └── chat.js                       # 거절 라우트 추가

client/
└── src/
    └── components/
        └── chat/
            └── GroupChat.js          # 거절 핸들러, 확인 모달
```

---

## 🐛 오류 및 수정사항 기록

### [2026-01-10 작업 1] Phase 1 완료 - 프롬프트 분리 및 개선
- **작업**: AI 프롬프트를 별도 파일로 분리하고 LLM 중심으로 개선
- **변경 사항**:
  - `server/prompts/scheduleAnalysis.js` 파일 생성
  - 하드코딩된 날짜/시간 규칙 제거
  - LLM이 맥락을 자연스럽게 이해하도록 프롬프트 재작성
  - Few-shot 예제 4개 추가
  - `aiScheduleService.js`에서 새 프롬프트 함수 사용
- **파일**: 
  - `server/prompts/scheduleAnalysis.js` (신규)
  - `server/services/aiScheduleService.js` (수정)
- **예상 효과**: "다음주 목요일" 같은 표현의 정확도 개선

### [2026-01-10 작업 2] Phase 2 완료 - 거절 추적 시스템
- **작업**: 거절된 제안을 DB에 저장하여 중복 제안 방지
- **변경 사항**:
  - `RejectedSuggestion` 모델 생성
  - `isRejected()` static 메소드로 거절 내역 조회
  - `cleanOldRejections()` 메소드로 7일 이상 지난 거절 내역 자동 삭제
  - `aiScheduleService.js`에서 일정 제안 전 거절 내역 체크
- **파일**:
  - `server/models/RejectedSuggestion.js` (신규)
  - `server/services/aiScheduleService.js` (수정)
- **효과**: 한 번 거절한 제안이 다시 나타나지 않음

### [2026-01-10 작업 3] Phase 3 완료 - 거절 메시지 기록 & API
- **작업**: 거절 시 채팅방에 시스템 메시지 자동 생성
- **변경 사항**:
  - `chatController.js`에 `rejectSchedule` 함수 추가
  - 거절 시 RejectedSuggestion에 저장
  - 채팅방에 시스템 메시지 전송: "🚫 AI 일정 제안을 거절했습니다"
  - Socket 이벤트 `schedule-rejected` 발송
  - `chat.js` 라우트에 `/reject` 엔드포인트 추가
- **파일**:
  - `server/controllers/chatController.js` (수정)
  - `server/routes/chat.js` (수정)

### [2026-01-10 작업 4] 클라이언트 거절 버튼 기능 구현
- **작업**: 클라이언트에서 거절 버튼 클릭 시 서버 API 호출
- **변경 사항**:
  - `GroupChat.js`의 `handleRejectSchedule` 함수를 async로 변경
  - `/api/chat/:roomId/reject` API 호출 추가
  - 에러 처리 및 토스트 메시지 개선
- **파일**:
  - `client/src/components/chat/GroupChat.js` (수정)
- **효과**: 거절 시 DB에 기록되고 채팅방에 메시지 표시

---

## ✅ 작업 진행 상황

- [x] Phase 1: 프롬프트 분리 및 개선 ✅ 완료
- [x] Phase 2: 거절 추적 시스템 ✅ 완료
- [x] Phase 3: 거절 메시지 기록 ✅ 완료
- [ ] Phase 4: 선호시간 체크 ⏸️ 보류 (사용자 확인 필요)
- [ ] Phase 5: 최종 확인 플로우 🔄 진행 예정
- [ ] Phase 6: 날짜 인식 테스트 🔄 진행 예정

---

## 📝 메모

- Gemini 2.0-flash 모델 사용 중
- 현재 30초 중복 방지 throttle 적용됨
- Socket.io 이벤트: `schedule-suggestion`
